<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="jmpews,jmpews@gmail.com"><title>HookZzæ¡†æ¶ Â· jmpews</title><meta name="description" content="a hook framework
ref to: frida-gum and minhook and substrate. special thanks to frida-gum&amp;#39;s perfect code and modular architecture.
still developin"><meta name="keywords" content="py,go,pwn,reverse"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">jmpews</a></h3><div class="description"><p>py &amp; go &amp; pwn &amp; reverse</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/jmpews"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/winter1ife"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/jmpews"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">é¦–é¡µ</a></li><li><a href="/about">å…³äº</a></li><li><a href="/archives">å½’æ¡£</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>HookZzæ¡†æ¶</a></h3></div><div class="post-content"><p><strong>a hook framework</strong></p>
<p><strong>ref to: <a href="https://github.com/frida/frida-gum" target="_blank" rel="external">frida-gum</a> and <a href="https://github.com/TsudaKageyu/minhook" target="_blank" rel="external">minhook</a> and <a href="https://github.com/jevinskie/substrate" target="_blank" rel="external">substrate</a>. special thanks to <code>frida-gum&#39;s</code> perfect code and modular architecture</strong>.</p>
<p><strong>still developing, for arm64/IOS now!</strong></p>
<h1 id="HookFramework-æ¶æ„è®¾è®¡"><a href="#HookFramework-æ¶æ„è®¾è®¡" class="headerlink" title="HookFramework æ¶æ„è®¾è®¡"></a>HookFramework æ¶æ„è®¾è®¡</h1><p>ä¸€èˆ¬æ¥è¯´å¯ä»¥åˆ†ä¸ºä»¥ä¸‹å‡ ä¸ªæ¨¡å—</p>
<ol>
<li>å†…å­˜åˆ†é… æ¨¡å—</li>
<li>æŒ‡ä»¤å†™ æ¨¡å—</li>
<li>æŒ‡ä»¤è¯» æ¨¡å—</li>
<li>æŒ‡ä»¤ä¿®å¤ æ¨¡å—</li>
<li>è·³æ¿ æ¨¡å—</li>
<li>è°ƒåº¦å™¨ æ¨¡å—</li>
<li>æ ˆ æ¨¡å—</li>
</ol>
<h4 id="1-å†…å­˜åˆ†é…-æ¨¡å—"><a href="#1-å†…å­˜åˆ†é…-æ¨¡å—" class="headerlink" title="1. å†…å­˜åˆ†é… æ¨¡å—"></a>1. å†…å­˜åˆ†é… æ¨¡å—</h4><p>éœ€è¦åˆ†é…éƒ¨åˆ†å†…å­˜ç”¨äºå†™å…¥æŒ‡ä»¤, è¿™é‡Œéœ€è¦å…³æ³¨ä¸¤ä¸ªå‡½æ•°éƒ½æ˜¯å…³äºå†…å­˜å±æ€§ç›¸å…³çš„. 1. å¦‚ä½•ä½¿å†…å­˜ <code>å¯å†™</code> 2. å¦‚ä½•ä½¿å†…å­˜ <code>å¯æ‰§è¡Œ</code> 3. å¦‚ä½•åˆ†é…ç›¸è¿‘çš„å†…å­˜æ¥è¾¾åˆ° <code>near jump</code></p>
<p>è¿™ä¸€éƒ¨åˆ†ä¸å…·ä½“çš„æ“ä½œç³»ç»Ÿæœ‰å…³. æ¯”å¦‚ <code>darwin</code> ä¸‹åˆ†é…å†…å­˜ä½¿ç”¨ <code>mmap</code> å®é™…ä½¿ç”¨çš„æ˜¯ <code>mach_vm_allocate</code>. <a href="https://github.com/bminor/glibc/blob/master/sysdeps/mach/hurd/mmap.c" target="_blank" rel="external">move to detail</a>.</p>
<p>åœ¨ lldb ä¸­å¯ä»¥é€šè¿‡ <code>memory region address</code> æŸ¥çœ‹åœ°å€çš„å†…å­˜å±æ€§.</p>
<p>å½“ç„¶è¿™é‡Œä¹Ÿå­˜åœ¨ä¸€ä¸ªå·¨å¤§çš„å‘, IOS ä¸‹æ— æ³•åˆ†é… <code>rwx</code> å±æ€§çš„å†…å­˜é¡µ. è¿™å¯¼è‡´ inlinehook æ— æ³•åœ¨éè¶Šç‹±ç³»ç»Ÿä¸Šä½¿ç”¨, å¹¶ä¸”åªæœ‰ <code>MobileSafari</code> æ‰æœ‰ <code>VM_FLAGS_MAP_JIT</code> æƒé™. å…·ä½“è§£é‡Šè¯·å‚ä¸‹æ–¹ <strong>[å‘ - rwx ä¸ codesigning]</strong>.</p>
<p>å¦ä¸€ä¸ªå‘å°±æ˜¯å¦‚ä½•åœ¨ hook ç›®æ ‡å‘¨å›´åˆ†é…å†…å­˜, å¦‚æœå¯ä»¥åˆ†é…åˆ°å‘¨å›´çš„å†…å­˜, å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>b</code> æŒ‡ä»¤è¿›è¡Œç›¸å¯¹åœ°å€è·³(<code>near jump</code>), ä»è€Œå¯ä»¥å¯ä»¥å®ç°å•æŒ‡ä»¤çš„ hook.</p>
<p>ä¸¾ä¸ªä¾‹å­æ¯”å¦‚ <code>b label</code>, åœ¨ armv8 ä¸­çš„å¯ä»¥æƒ³åœ¨ <code>+-128MB</code> èŒƒå›´å†…è¿›è¡Œ <code>near jump</code>, å…·ä½“å¯ä»¥å‚è€ƒ <code>ARM Architecture Reference Manual ARMv8, for ARMv8-A architecture profile Page: C6-550</code>.</p>
<p>è¿™é‡Œå¯ä»¥æœ‰ä¸‰ä¸ªå°è¯•.</p>
<ol>
<li><p>ä½¿ç”¨ <code>mmap</code> çš„ <code>MAP_FIXED</code> å°è¯•åœ¨å‘¨å›´åœ°å€åˆ†é…å†…å­˜é¡µ, æˆåŠŸå‡ ç‡å°.</p>
</li>
<li><p>å°è¯•ä½¿ç”¨ <code>vm_region_recurse_64</code> æœç´¢ <code>protection</code> ä¸º <code>PROT_EXEC</code> &amp; <code>PROT_READ</code> åŒºåŸŸ. (é€šå¸¸ç”¨æ¥æš´åŠ›æŸ¥æ‰¾ <code>dyld</code> çš„åœ°å€)</p>
</li>
<li><p>å°è¯•æœç´¢å†…å­˜ç©ºæ´(memory code cave), æœç´¢ <code>__text</code> è¿™ä¸ª <code>section</code> å…¶å®æ›´å‡†ç¡®æ¥è¯´æ˜¯æœç´¢ <code>__TEXT</code> è¿™ä¸ª <code>segment</code>. ç”±äºå†…å­˜é¡µå¯¹é½çš„åŸå› ä»¥åŠå…¶ä»–åŸå› å¾ˆå®¹æ˜“å‡ºç° <code>memory code cave</code>. æ‰€ä»¥åªéœ€è¦æœç´¢è¿™ä¸ªåŒºé—´å†…çš„ <code>00</code> å³å¯, <code>00</code> æœ¬èº«å°±æ˜¯æ— æ•ˆæŒ‡ä»¤, æ‰€ä»¥å¯ä»¥åˆ¤æ–­è¯¥ä½ç½®æ— æŒ‡ä»¤ä½¿ç”¨.</p>
</li>
</ol>
<p>å½“ç„¶è¿˜å¯ä»¥æœ‰å¼ºåˆ¶ç›¸å¯¹è·³(<code>double jump</code>), ç›´æ¥å¯¹ <code>+-128MB</code> å†…é€‰ä¸€ä¸ªåœ°å€å¼ºåˆ¶ code patch å¹¶ä¿®å¤.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">__asm__ &#123;</div><div class="line">  // ç¬¬ä¸€æ¬¡ç»å¯¹åœ°å€è·³, è·³è½¬åˆ°ä¿®å¤æ¨¡å—, æ‰§è¡Œæ­£å¸¸æµç¨‹</div><div class="line">  &quot;ldr x17, #0x8\n&quot;</div><div class="line">  &quot;b #0xc\n&quot;</div><div class="line">  &quot;.long\n&quot;</div><div class="line">  &quot;.long\n&quot;</div><div class="line">  &quot;br x17&quot;</div><div class="line"></div><div class="line">  // double jump, è·³è½¬åˆ° on_enter_trampoline</div><div class="line">  &quot;ldr x17, #0x8\n&quot;</div><div class="line">  &quot;b #0xc\n&quot;</div><div class="line">  &quot;.long\n&quot;</div><div class="line">  &quot;.long\n&quot;</div><div class="line">  &quot;br x17&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="2-æŒ‡ä»¤å†™-æ¨¡å—"><a href="#2-æŒ‡ä»¤å†™-æ¨¡å—" class="headerlink" title="2. æŒ‡ä»¤å†™ æ¨¡å—"></a>2. æŒ‡ä»¤å†™ æ¨¡å—</h4><p>å…ˆè¯´å‘,  éè¶Šç‹±çŠ¶æ€ä¸‹ä¸å…è®¸è®¾ç½® <code>rw-</code> ä¸º <code>r-x</code>, æˆ–è€…  è®¾ç½® <code>r-x</code> ä¸º <code>rx-</code>. å…·ä½“è§£é‡Šè¯·å‚è€ƒä¸‹æ–¹å‘ <strong>[å‘-rwx ä¸ codesigning]</strong>.</p>
<p>å…¶å®è¿™é‡Œçš„æŒ‡ä»¤å†™æœ‰ç§ç®€å•çš„æ–¹æ³•, å°±æ˜¯åœ¨æœ¬åœ°ç”ŸæˆæŒ‡ä»¤çš„16è¿›åˆ¶ä¸², ä¹‹åç›´æ¥å†™å³å¯. ä½†è¿™ç§åº”è¯¥æ˜¯å±äº hardcode.</p>
<p>è¿™é‡Œä½¿ç”¨ <code>frida-gum</code> å’Œ <code>CydiaSubstrace</code> éƒ½ç”¨çš„æ–¹æ³•, æŠŠéœ€è¦ç”¨åˆ°çš„æŒ‡ä»¤éƒ½å†™æˆä¸€ä¸ªå°å‡½æ•°.</p>
<p>ä¾‹å¦‚:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div></pre></td><td class="code"><pre><div class="line">// frida-gum/gum/arch-arm64/gumarm64writer.c</div><div class="line">void</div><div class="line">gum_arm64_writer_put_ldr_reg_address (GumArm64Writer * self,</div><div class="line">                                      arm64_reg reg,</div><div class="line">                                      GumAddress address)</div><div class="line">&#123;</div><div class="line">  gum_arm64_writer_put_ldr_reg_u64 (self, reg, (guint64) address);</div><div class="line">&#125;</div><div class="line"></div><div class="line">void</div><div class="line">gum_arm64_writer_put_ldr_reg_u64 (GumArm64Writer * self,</div><div class="line">                                  arm64_reg reg,</div><div class="line">                                  guint64 val)</div><div class="line">&#123;</div><div class="line">  GumArm64RegInfo ri;</div><div class="line"></div><div class="line">  gum_arm64_writer_describe_reg (self, reg, &amp;ri);</div><div class="line"></div><div class="line">  g_assert_cmpuint (ri.width, ==, 64);</div><div class="line"></div><div class="line">  gum_arm64_writer_add_literal_reference_here (self, val);</div><div class="line">  gum_arm64_writer_put_instruction (self,</div><div class="line">      (ri.is_integer ? 0x58000000 : 0x5c000000) | ri.index);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>å…¶å®æœ‰å¦å¤–ä¸€ä¸ªå°æ€è·¯,  æœ‰ä¸€ç‚¹å°ä¸è¶³, å°±æ˜¯ç¡®å®šæŒ‡ä»¤ç‰‡æ®µçš„é•¿åº¦, ä½†å…¶å®ä¹Ÿæœ‰è§£å†³æ–¹æ³•, <strong>å¯ä»¥æ”¾å‡ æ¡ç‰¹æ®ŠæŒ‡ä»¤ä½œä¸ºç»“å°¾æ ‡è®°</strong>.</p>
<p>å…ˆä½¿ç”¨å†…è”æ±‡ç¼–å†™ä¸€ä¸ªå‡½æ•°.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">__attribute__((__naked__)) static void ctx_save() &#123;</div><div class="line">  __asm__ volatile(</div><div class="line"></div><div class="line">      /* reserve space for next_hop */</div><div class="line">      &quot;sub sp, sp, #(2*8)\n&quot;</div><div class="line"></div><div class="line">      /* save &#123;q0-q7&#125; */</div><div class="line">      &quot;sub sp, sp, #(8*16)\n&quot;</div><div class="line">      &quot;stp q6, q7, [sp, #(6*16)]\n&quot;</div><div class="line">      &quot;stp q4, q5, [sp, #(4*16)]\n&quot;</div><div class="line">      &quot;stp q2, q3, [sp, #(2*16)]\n&quot;</div><div class="line">      &quot;stp q0, q1, [sp, #(0*16)]\n&quot;</div><div class="line"></div><div class="line">      /* save &#123;x1-x30&#125; */</div><div class="line">      &quot;sub sp, sp, #(30*8)\n&quot;</div><div class="line">      &quot;stp fp, lr, [sp, #(28*8)]\n&quot;</div><div class="line">      &quot;stp x27, x28, [sp, #(26*8)]\n&quot;</div><div class="line">      &quot;stp x25, x26, [sp, #(24*8)]\n&quot;</div><div class="line">      &quot;stp x23, x24, [sp, #(22*8)]\n&quot;</div><div class="line">      &quot;stp x21, x22, [sp, #(20*8)]\n&quot;</div><div class="line">      &quot;stp x19, x20, [sp, #(18*8)]\n&quot;</div><div class="line">      &quot;stp x17, x18, [sp, #(16*8)]\n&quot;</div><div class="line">      &quot;stp x15, x16, [sp, #(14*8)]\n&quot;</div><div class="line">      &quot;stp x13, x14, [sp, #(12*8)]\n&quot;</div><div class="line">      &quot;stp x11, x12, [sp, #(10*8)]\n&quot;</div><div class="line">      &quot;stp x9, x10, [sp, #(8*8)]\n&quot;</div><div class="line">      &quot;stp x7, x8, [sp, #(6*8)]\n&quot;</div><div class="line">      &quot;stp x5, x6, [sp, #(4*8)]\n&quot;</div><div class="line">      &quot;stp x3, x4, [sp, #(2*8)]\n&quot;</div><div class="line">      &quot;stp x1, x2, [sp, #(0*8)]\n&quot;</div><div class="line"></div><div class="line">      /* save sp, x0 */</div><div class="line">      &quot;sub sp, sp, #(2*8)\n&quot;</div><div class="line">      &quot;add x1, sp, #(2*8 + 8*16 + 30*8 + 2*8)\n&quot;</div><div class="line">      &quot;stp x1, x0, [sp, #(0*8)]\n&quot;</div><div class="line"></div><div class="line">      /* alignment padding + dummy PC */</div><div class="line">      &quot;sub sp, sp, #(2*8)\n&quot;);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹‹åç›´æ¥å¤åˆ¶è¿™å—å‡½æ•°å†…å­˜æ•°æ®å³å¯, è¿™ä¸€èˆ¬é€‚åˆé‚£ç§æŒ‡ä»¤ç‰‡æ®µå †.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">void ZzThunkerBuildEnterThunk(ZzWriter *writer)</div><div class="line">&#123;</div><div class="line"></div><div class="line">    // pop x17</div><div class="line">    writer_put_ldr_reg_reg_offset(writer, ARM64_REG_X17, ARM64_REG_SP, 0);</div><div class="line">    writer_put_add_reg_reg_imm(writer, ARM64_REG_SP, ARM64_REG_SP, 16);</div><div class="line"></div><div class="line">    writer_put_bytes(writer, (void *)ctx_save, 26 * 4);</div><div class="line"></div><div class="line">    // call `function_context_begin_invocation`</div><div class="line">    writer_put_bytes(writer, (void *)pass_enter_func_args, 4 * 4);</div><div class="line">    writer_put_ldr_reg_address(</div><div class="line">        writer, ARM64_REG_X17,</div><div class="line">        (zaddr)(zpointer)function_context_begin_invocation);</div><div class="line">    writer_put_blr_reg(writer, ARM64_REG_X17);</div><div class="line"></div><div class="line">    writer_put_bytes(writer, (void *)ctx_restore, 23 * 4);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="3-æŒ‡ä»¤è¯»-æ¨¡å—"><a href="#3-æŒ‡ä»¤è¯»-æ¨¡å—" class="headerlink" title="3. æŒ‡ä»¤è¯» æ¨¡å—"></a>3. æŒ‡ä»¤è¯» æ¨¡å—</h4><p>è¿™ä¸€éƒ¨åˆ†å®é™…ä¸Šå°±æ˜¯ <code>disassembler</code>, è¿™ä¸€éƒ¨åˆ†å¯ä»¥ç›´æ¥ä½¿ç”¨ <code>capstone</code>, è¿™é‡Œéœ€è¦æŠŠ <code>capstone</code> ç¼–è¯‘æˆå¤šç§æ¶æ„.</p>
<h4 id="4-æŒ‡ä»¤ä¿®å¤-æ¨¡å—"><a href="#4-æŒ‡ä»¤ä¿®å¤-æ¨¡å—" class="headerlink" title="4. æŒ‡ä»¤ä¿®å¤ æ¨¡å—"></a>4. æŒ‡ä»¤ä¿®å¤ æ¨¡å—</h4><p>è¿™é‡Œçš„æŒ‡ä»¤ä¿®å¤ä¸»è¦æ˜¯å‘ç”Ÿåœ¨ hook å‡½æ•°å¤´å‡ æ¡æŒ‡ä»¤, ç”±äºå¤‡ä»½æŒ‡ä»¤åˆ°å¦ä¸€ä¸ªåœ°å€, è¿™å°±éœ€è¦å¯¹æ‰€æœ‰ <code>PC(IP)</code> ç›¸å…³æŒ‡ä»¤è¿›è¡Œä¿®å¤. å¯¹äºç¡®å®šçš„å“ªäº›æŒ‡ä»¤éœ€è¦ä¿®å¤å¯ä»¥å‚è€ƒ <a href="http://jmpews.github.io/2017/05/17/pwn/%E8%A7%A3%E6%9E%90ARM%E5%92%8Cx86_x64%E6%8C%87%E4%BB%A4%E6%A0%BC%E5%BC%8F/" target="_blank" rel="external">Move to &lt;è§£æARMå’Œx86_x64æŒ‡ä»¤æ ¼å¼&gt;</a>.</p>
<p>å¤§è‡´çš„æ€è·¯å°±æ˜¯: åˆ¤æ–­ <code>capstone</code> è¯»å–åˆ°çš„æŒ‡ä»¤ ID, é’ˆå¯¹ç‰¹å®šæŒ‡ä»¤å†™ä¸€ä¸ªå°å‡½æ•°è¿›è¡Œä¿®å¤.</p>
<p>ä¾‹å¦‚åœ¨ <code>frida-gum</code> ä¸­:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">frida-gum/gum/arch-arm64/gumarm64relocator.c</div><div class="line">static gboolean</div><div class="line">gum_arm64_relocator_rewrite_b (GumArm64Relocator * self,</div><div class="line">                               GumCodeGenCtx * ctx)</div><div class="line">&#123;</div><div class="line">  const cs_arm64_op * target = &amp;ctx-&gt;detail-&gt;operands[0];</div><div class="line"></div><div class="line">  (void) self;</div><div class="line"></div><div class="line">  gum_arm64_writer_put_ldr_reg_address (ctx-&gt;output, ARM64_REG_X16,</div><div class="line">      target-&gt;imm);</div><div class="line">  gum_arm64_writer_put_br_reg (ctx-&gt;output, ARM64_REG_X16);</div><div class="line"></div><div class="line">  return TRUE;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="5-è·³æ¿-æ¨¡å—"><a href="#5-è·³æ¿-æ¨¡å—" class="headerlink" title="5. è·³æ¿ æ¨¡å—"></a>5. è·³æ¿ æ¨¡å—</h4><p>è·³æ¿æ¨¡å—çš„è®¾è®¡æ˜¯å¸Œæœ›å„ä¸ªæ¨¡å—çš„å®ç°æ›´æµ…çš„è€¦åˆ, è·³æ¿å‡½æ•°ä¸»è¦ä½œç”¨å°±æ˜¯è¿›è¡Œè·³è½¬, å¹¶å‡†å¤‡ <code>è·³è½¬ç›®æ ‡</code> éœ€è¦çš„å‚æ•°. ä¸¾ä¸ªä¾‹å­, è¢« hook çš„å‡½æ•°ç»è¿‡å…¥å£è·³æ¿(<code>enter_trampoline</code>), è·³è½¬åˆ°è°ƒåº¦å‡½æ•°(<code>enter_chunk</code>), éœ€è¦è¢« hook çš„å‡½æ•°ç›¸å…³ä¿¡æ¯ç­‰, è¿™ä¸ªå°±éœ€è¦åœ¨æ„é€ è·³æ¿æ—¶å®Œæˆ.</p>
<h4 id="6-è°ƒåº¦-æ¨¡å—"><a href="#6-è°ƒåº¦-æ¨¡å—" class="headerlink" title="6. è°ƒåº¦ æ¨¡å—"></a>6. è°ƒåº¦ æ¨¡å—</h4><p>å¯ä»¥ç†è§£ä¸ºæ‰€æœ‰è¢« hook çš„å‡½æ•°éƒ½å¿…é¡»ç»è¿‡çš„å‡½æ•°, ç±»ä¼¼äº <code>objc_msgSend</code>, åœ¨è¿™é‡Œé€šè¿‡æ ˆè¿”å›å€¼æ¥æ§åˆ¶å‡½æ•°(<code>replace_call</code>, <code>pre_call</code>, <code>half_call</code>, <code>post_call</code>)è°ƒç”¨é¡ºåº.</p>
<p>æœ¬è´¨æœ‰äº›ç±»ä¼¼äº <code>objc_msgSend</code> æ‰€æœ‰çš„è¢« hook çš„å‡½æ•°éƒ½åœ¨ç»è¿‡ <code>enter_trampoline</code> è·³æ¿å, è·³è½¬åˆ° <code>enter_thunk</code>, åœ¨æ­¤è¿›è¡Œä¸‹ä¸€æ­¥çš„è·³è½¬åˆ¤æ–­å†³å®š, å¹¶ä¸æ˜¯ç›´æ¥è·³è½¬åˆ° <code>replace_call</code>.</p>
<h4 id="7-æ ˆæ¨¡å—"><a href="#7-æ ˆæ¨¡å—" class="headerlink" title="7. æ ˆæ¨¡å—"></a>7. æ ˆæ¨¡å—</h4><p>å¦‚æœå¸Œæœ›åœ¨ <code>pre_call</code> å’Œ <code>post_call</code>  ä½¿ç”¨åŒä¸€ä¸ªå±€éƒ¨å˜é‡, å°±æƒ³åœ¨åŒä¸€ä¸ªå‡½æ•°å†…ä¸€æ ·. åœ¨ <code>frida-js</code> ä¸­ä¹Ÿå°±æ˜¯ <code>this</code> è¿™ä¸ªå…³é”®å­—. è¿™å°±éœ€è¦è‡ªå»ºå‡½æ•°æ ˆ, æ¨¡æ‹Ÿæ ˆçš„è¡Œä¸º. åŒæ—¶è¿˜è¦é¿å…çº¿ç¨‹å†²çª, æ‰€ä»¥éœ€è¦ä½¿ç”¨ <code>thread local variable</code>, ä¸ºæ¯ä¸€ä¸ªçº¿ç¨‹ä¸­çš„æ¯ä¸€ä¸ª <code>hook-entry</code> æ·»åŠ çº¿ç¨‹æ ˆ, åŒæ—¶ä¸ºæ¯ä¸€æ¬¡è°ƒç”¨æ·»åŠ å‡½æ•°æ ˆ. æ‰€ä»¥è¿™é‡Œå­˜åœ¨ä¸¤ç§æ ˆ. 1. çº¿ç¨‹æ ˆ(ä¿å­˜äº†è¯¥ hook-entry çš„æ‰€æœ‰å½“å‰å‡½æ•°è°ƒç”¨æ ˆ) 2. å‡½æ•°è°ƒç”¨æ ˆ(æœ¬æ¬¡å‡½æ•°è°ƒç”¨æ—¶çš„æ ˆ)</p>
<h1 id="å‘"><a href="#å‘" class="headerlink" title="å‘"></a>å‘</h1><h2 id="ldr-æŒ‡ä»¤"><a href="#ldr-æŒ‡ä»¤" class="headerlink" title="ldr æŒ‡ä»¤"></a><code>ldr</code> æŒ‡ä»¤</h2><p>åœ¨è¿›è¡ŒæŒ‡ä»¤ä¿®å¤æ—¶, éœ€è¦éœ€è¦å°† PC ç›¸å…³çš„åœ°å€è½¬æ¢ä¸ºç»å¯¹åœ°å€, å…¶ä¸­æ¶‰åŠåˆ°ä¿å­˜åœ°å€åˆ°å¯„å­˜å™¨. ä¸€èˆ¬æ¥è¯´æ˜¯ä½¿ç”¨æŒ‡ä»¤ <code>ldr</code>. ä¹Ÿå°±æ˜¯è¯´å¦‚ä½•å®Œæˆè¯¥å‡½æ•° <code>writer_put_ldr_reg_address(relocate_writer, ARM64_REG_X17, target_addr);</code></p>
<p><code>frida-gum</code> çš„å®ç°åŸç†æ˜¯, æœ‰ä¸€ä¸ªç›¸å¯¹åœ°å€è¡¨, åœ¨æ•´ä½“ä¸€æ®µå†™å®Œåè¿›è¡Œä¿®å¤.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div></pre></td><td class="code"><pre><div class="line">void</div><div class="line">gum_arm64_writer_put_ldr_reg_u64 (GumArm64Writer * self,</div><div class="line">                                  arm64_reg reg,</div><div class="line">                                  guint64 val)</div><div class="line">&#123;</div><div class="line">  GumArm64RegInfo ri;</div><div class="line"></div><div class="line">  gum_arm64_writer_describe_reg (self, reg, &amp;ri);</div><div class="line"></div><div class="line">  g_assert_cmpuint (ri.width, ==, 64);</div><div class="line"></div><div class="line">  gum_arm64_writer_add_literal_reference_here (self, val);</div><div class="line">  gum_arm64_writer_put_instruction (self,</div><div class="line">      (ri.is_integer ? 0x58000000 : 0x5c000000) | ri.index);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>åœ¨ HookZz ä¸­çš„å®ç°, ç›´æ¥å°†åœ°å€å†™åœ¨æŒ‡ä»¤å, ä¹‹åä½¿ç”¨ <code>b</code> åˆ°æ­£å¸¸çš„ä¸‹ä¸€æ¡æŒ‡ä»¤, ä»è€Œå®ç°å°†åœ°å€ä¿å­˜åˆ°å¯„å­˜å™¨.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div></pre></td><td class="code"><pre><div class="line">void writer_put_ldr_reg_address(ZzWriter *self, arm64_reg reg, zaddr address)</div><div class="line">&#123;</div><div class="line">    writer_put_ldr_reg_imm(self, reg, (zuint)0x8);</div><div class="line">    writer_put_b_imm(self, (zaddr)0xc);</div><div class="line">    writer_put_bytes(self, (zpointer)&amp;address, sizeof(address));</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>ä¹Ÿå°±æ˜¯ä¸‹é¢çš„æ ·å­.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">__asm__ &#123;</div><div class="line">  &quot;ldr x17, #0x8\n&quot;</div><div class="line">  &quot;b #0xc\n&quot;</div><div class="line">  &quot;.long\n&quot;</div><div class="line">  &quot;.long\n&quot;</div><div class="line">  &quot;br x17&quot;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h2 id="å¯„å­˜å™¨æ±¡æŸ“"><a href="#å¯„å­˜å™¨æ±¡æŸ“" class="headerlink" title="å¯„å­˜å™¨æ±¡æŸ“"></a>å¯„å­˜å™¨æ±¡æŸ“</h2><p>åœ¨è¿›è¡Œ inlinehook éœ€è¦è¿›è¡Œå„ç§è·³è½¬, é€šå¸¸ä¼šä»¥ä»¥ä¸‹æ¨¡æ¿è¿›è¡Œè·³è½¬.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">0:  ldr x16, 8;</div><div class="line">4:  br x16;</div><div class="line">8:  0x12345678</div><div class="line">12: 0x00000000</div></pre></td></tr></table></figure>
<p>é—®é¢˜åœ¨äºè¿™ä¼šé€ æˆ x16 å¯„å­˜å™¨è¢«æ±¡æŸ“(åœ¨ arm64 ä¸­ <code>svc #0x80</code> ä½¿ç”¨ x16 ä¼ é€’ç³»ç»Ÿè°ƒç”¨å·) æ‰€ä»¥è¿™é‡Œæœ‰ä¸¤ç§æ€è·¯è§£å†³è¿™ä¸ªé—®é¢˜.</p>
<p>æ€è·¯ä¸€:</p>
<p>åœ¨ä½¿ç”¨å¯„å­˜å™¨ä¹‹å‰è¿›è¡Œ <code>push</code>, è·³è½¬å <code>pop</code>, è¿™é‡Œå­˜åœ¨ä¸€ä¸ªé—®é¢˜å°±æ˜¯åœ¨åŸåœ°å€çš„å‡ æ¡æŒ‡ä»¤è¿›è¡Œ <code>patch code</code> æ—¶ä¸€å®šä¼šæ±¡æŸ“ä¸€ä¸ªå¯„å­˜å™¨(ä¹Ÿä¸èƒ½è¯´ä¸€å®š, å¦‚æœè¿™æ—¶è¿›è¡Œå‹æ ˆ, åœ¨ä¹‹åçš„ <code>invoke_trampline</code> ä¼šå¯¼è‡´å‡½æ•°æ ˆå‘ç”Ÿæ”¹å˜, æ­¤æ—¶æœ‰ä¸ªè§£å†³æ–¹æ³•å¯ä»¥ <code>pop</code> å‡ºæ¥, ç”± hook-entry æˆ–è€…å…¶ä»–å˜é‡æš‚æ—¶ä¿å­˜, ä½†è¿™æ—¶éœ€è¦å¤„ç†é”çš„é—®é¢˜. )</p>
<p>æ€è·¯äºŒ:</p>
<p>æŒ‘é€‰åˆé€‚çš„å¯„å­˜å™¨, ä¸è€ƒè™‘æ±¡æŸ“é—®é¢˜. è¿™æ—¶å¯ä»¥å‚è€ƒ, ä¸‹é¢çš„èµ„æ–™, é€‰æ‹© x16 or x17, æˆ–è€…è‡ªå·±åšä¸€ä¸ªå®éªŒ <code>otool -tv ~/Downloads/DiSpecialDriver64 &gt; ~/Downloads/DiSpecialDriver64.txt</code> é€šè¿‡ dump ä¸€ä¸ª arm64 ç¨‹åºçš„æŒ‡ä»¤, æ¥åˆ¤æ–­å“ªä¸ªå¯„å­˜å™¨ç”¨çš„æœ€å°‘, ä½†æ˜¯ä¸è¦ä½¿ç”¨ <code>x18</code> å¯„å­˜å™¨, ä½ å¯¹è¯¥å¯„å­˜å™¨çš„ä¿®æ”¹æ˜¯æ— æ•ˆçš„.</p>
<p>Tips: ä¹‹å‰è¿˜æƒ³è¿‡ä¸ºå¯¹æ¯ä¸€ä¸ªå¯„å­˜å™¨éƒ½åšé€‚é…, ç”¨æˆ·å¯ä»¥é€‰æ‹©å½“å‰çš„ <code>hook-entry</code> é€‰æ‹©å“ªä¸€ä¸ªå¯„å­˜å™¨ä½œä¸ºä¸´æ—¶å¯„å­˜å™¨.</p>
<p>å‚è€ƒèµ„æ–™:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">PAGE: 9-3</div><div class="line">Programmerâ€™s Guide for ARMv8-A</div><div class="line">9.1 Register use in the AArch64 Procedure Call Standard </div><div class="line">9.1.1 Parameters in general-purpose registers</div></pre></td></tr></table></figure>
<p>è¿™é‡Œä¹Ÿæœ‰ä¸€ä¸ªé—®é¢˜,  è¿™ä¹Ÿæ˜¯ <code>frida-gum</code> ä¸­é‡åˆ°ä¸€ä¸ªé—®é¢˜, å°±æ˜¯å¯¹äº <code>svc #0x80</code> ç±»ç³»ç»Ÿè°ƒç”¨, ç³»ç»Ÿè°ƒç”¨å·(syscall number)çš„ä¼ é€’æ˜¯åˆ©ç”¨ <code>x16</code> å¯„å­˜å™¨è¿›è¡Œä¼ é€’çš„, æ‰€ä»¥æœ¬æ¡†æ¶ä½¿ç”¨ <code>x17</code> å¯„å­˜å™¨, å¹¶ä¸”åœ¨ä¼ é€’å‚æ•°æ—¶ä½¿ç”¨ <code>push</code> &amp; <code>pop</code>, åœ¨è·³è½¬åæ¢å¤ <code>x17</code>, é¿å…äº†ä¸€ä¸ªå¯„å­˜å™¨çš„ä½¿ç”¨.</p>
<h2 id="rwx-ä¸-codesigning"><a href="#rwx-ä¸-codesigning" class="headerlink" title="rwx ä¸ codesigning"></a><code>rwx</code> ä¸ <code>codesigning</code></h2><p>å¯¹äºéè¶Šç‹±, ä¸èƒ½åˆ†é…å¯æ‰§è¡Œå†…å­˜, ä¸èƒ½è¿›è¡Œ <code>code patch</code>.</p>
<p>ä¸¤ç¯‡åŸç†è®²è§£ codesign çš„åŸç†</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">https://papers.put.as/papers/ios/2011/syscan11_breaking_ios_code_signing.pdf</div><div class="line">http://www.newosxbook.com/articles/CodeSigning.pdf</div></pre></td></tr></table></figure>
<p>ä»¥åŠæºç åˆ†æå¦‚ä¸‹:</p>
<p>crash å¼‚å¸¸å¦‚ä¸‹, å…¶ä¸­ <code>0x0000000100714000</code> æ˜¯ mmap åˆ†é…çš„é¡µ.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">Exception Type:  EXC_BAD_ACCESS (SIGKILL - CODESIGNING)</div><div class="line">Exception Subtype: unknown at 0x0000000100714000</div><div class="line">Termination Reason: Namespace CODESIGNING, Code 0x2</div><div class="line">Triggered by Thread:  0</div></pre></td></tr></table></figure>
<p>å¯»æ‰¾å¯¹åº”çš„é”™è¯¯ç </p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div></pre></td><td class="code"><pre><div class="line">xnu-3789.41.3/bsd/sys/reason.h</div><div class="line">/*</div><div class="line"> * codesigning exit reasons</div><div class="line"> */</div><div class="line">#define CODESIGNING_EXIT_REASON_TASKGATED_INVALID_SIG 1</div><div class="line">#define CODESIGNING_EXIT_REASON_INVALID_PAGE          2</div><div class="line">#define CODESIGNING_EXIT_REASON_TASK_ACCESS_PORT      3</div></pre></td></tr></table></figure>
<p>æ‰¾åˆ°å¯¹åº”å¤„ç†å‡½æ•°, è¯·ä»”ç»†é˜…è¯»æ³¨é‡Šé‡Œå†…å®¹, ä¸åšè§£é‡Šäº†.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div></pre></td><td class="code"><pre><div class="line"># xnu-3789.41.3/osfmk/vm/vm_fault.c:2632</div><div class="line"></div><div class="line">  /* If the map is switched, and is switch-protected, we must protect</div><div class="line">   * some pages from being write-faulted: immutable pages because by </div><div class="line">   * definition they may not be written, and executable pages because that</div><div class="line">   * would provide a way to inject unsigned code.</div><div class="line">   * If the page is immutable, we can simply return. However, we can&apos;t</div><div class="line">   * immediately determine whether a page is executable anywhere. But,</div><div class="line">   * we can disconnect it everywhere and remove the executable protection</div><div class="line">   * from the current map. We do that below right before we do the </div><div class="line">   * PMAP_ENTER.</div><div class="line">   */</div><div class="line">  cs_enforcement_enabled = cs_enforcement(NULL);</div><div class="line"></div><div class="line">  if(cs_enforcement_enabled &amp;&amp; map_is_switched &amp;&amp; </div><div class="line">     map_is_switch_protected &amp;&amp; page_immutable(m, prot) &amp;&amp; </div><div class="line">     (prot &amp; VM_PROT_WRITE))</div><div class="line">  &#123;</div><div class="line">    return KERN_CODESIGN_ERROR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (cs_enforcement_enabled &amp;&amp; page_nx(m) &amp;&amp; (prot &amp; VM_PROT_EXECUTE)) &#123;</div><div class="line">    if (cs_debug)</div><div class="line">      printf(&quot;page marked to be NX, not letting it be mapped EXEC\n&quot;);</div><div class="line">    return KERN_CODESIGN_ERROR;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  if (cs_enforcement_enabled &amp;&amp;</div><div class="line">      !m-&gt;cs_validated &amp;&amp;</div><div class="line">      (prot &amp; VM_PROT_EXECUTE) &amp;&amp;</div><div class="line">      !(caller_prot &amp; VM_PROT_EXECUTE)) &#123;</div><div class="line">    /*</div><div class="line">     * FOURK PAGER:</div><div class="line">     * This page has not been validated and will not be</div><div class="line">     * allowed to be mapped for &quot;execute&quot;.</div><div class="line">     * But the caller did not request &quot;execute&quot; access for this</div><div class="line">     * fault, so we should not raise a code-signing violation</div><div class="line">     * (and possibly kill the process) below.</div><div class="line">     * Instead, let&apos;s just remove the &quot;execute&quot; access request.</div><div class="line">     * </div><div class="line">     * This can happen on devices with a 4K page size if a 16K</div><div class="line">     * page contains a mix of signed&amp;executable and</div><div class="line">     * unsigned&amp;non-executable 4K pages, making the whole 16K</div><div class="line">     * mapping &quot;executable&quot;.</div><div class="line">     */</div><div class="line">    prot &amp;= ~VM_PROT_EXECUTE;</div><div class="line">  &#125;</div><div class="line"></div><div class="line">  /* A page could be tainted, or pose a risk of being tainted later.</div><div class="line">   * Check whether the receiving process wants it, and make it feel</div><div class="line">   * the consequences (that hapens in cs_invalid_page()).</div><div class="line">   * For CS Enforcement, two other conditions will </div><div class="line">   * cause that page to be tainted as well: </div><div class="line">   * - pmapping an unsigned page executable - this means unsigned code;</div><div class="line">   * - writeable mapping of a validated page - the content of that page</div><div class="line">   *   can be changed without the kernel noticing, therefore unsigned</div><div class="line">   *   code can be created</div><div class="line">   */</div><div class="line">  if (!cs_bypass &amp;&amp;</div><div class="line">      (m-&gt;cs_tainted ||</div><div class="line">       (cs_enforcement_enabled &amp;&amp;</div><div class="line">        (/* The page is unsigned and wants to be executable */</div><div class="line">         (!m-&gt;cs_validated &amp;&amp; (prot &amp; VM_PROT_EXECUTE))  ||</div><div class="line">         /* The page should be immutable, but is in danger of being modified</div><div class="line">    * This is the case where we want policy from the code directory -</div><div class="line">    * is the page immutable or not? For now we have to assume that </div><div class="line">    * code pages will be immutable, data pages not.</div><div class="line">    * We&apos;ll assume a page is a code page if it has a code directory </div><div class="line">    * and we fault for execution.</div><div class="line">    * That is good enough since if we faulted the code page for</div><div class="line">    * writing in another map before, it is wpmapped; if we fault</div><div class="line">    * it for writing in this map later it will also be faulted for executing </div><div class="line">    * at the same time; and if we fault for writing in another map</div><div class="line">    * later, we will disconnect it from this pmap so we&apos;ll notice</div><div class="line">    * the change.</div><div class="line">    */</div><div class="line">        (page_immutable(m, prot) &amp;&amp; ((prot &amp; VM_PROT_WRITE) || m-&gt;wpmapped))</div><div class="line">        ))</div><div class="line">        )) </div><div class="line">  &#123;</div></pre></td></tr></table></figure>
<h4 id="å…¶ä»–æ–‡ç« "><a href="#å…¶ä»–æ–‡ç« " class="headerlink" title="å…¶ä»–æ–‡ç« :"></a>å…¶ä»–æ–‡ç« :</h4><p><a href="http://ddeville.me/2014/04/dynamic-linking" target="_blank" rel="external">http://ddeville.me/2014/04/dynamic-linking</a></p>
<blockquote>
<p>Later on, whenever a page fault occurs the vm_fault function in <code>vm_fault.c</code> is called. During the page fault the signature is validated if necessary. The signature will need to be validated if the page is mapped in user space, if the page belongs to a code-signed object, if the page will be writable or simply if it has not previously been validated. Validation happens in the <code>vm_page_validate_cs</code> function inside vm_fault.c (the validation process and how it is enforced continually and not only at load time is interesting, see Charlie Millerâ€™s book for more details).</p>
<p>If for some reason the page cannot be validated, the kernel checks whether the <code>CS_KILL</code> flag has been set and kills the process if necessary. There is a major distinction between iOS and OS X regarding this flag. All iOS processes have this flag set whereas on OS X, although code signing is checked it is not set and thus not enforced.</p>
<p>In our case we can safely assume that the (missing) code signature couldnâ€™t be verified leading to the kernel killing the process.</p>
</blockquote>
<hr>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-08-01</span><i class="fa fa-tag"></i><a href="/categories/pwn/" title="pwn" class="tag">pwn </a><a href="/tags/hook/" title="hook" class="tag">hook </a><a href="/tags/inline-hook/" title="inline-hook" class="tag">inline-hook </a><a href="/tags/pwn/" title="pwn" class="tag">pwn </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://jmpews.github.com/2017/08/01/pwn/HookZzæ¡†æ¶/,jmpews,HookZzæ¡†æ¶,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/06/27/pwn/frida-gumæºç è§£è¯»/" title="frida-gumæºç è§£è¯»" class="btn">ä¸Šä¸€ç¯‡</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/08/09/darwin/åè°ƒè¯•åŠç»•è¿‡/" title="åè°ƒè¯•åŠç»•è¿‡" class="btn">ä¸‹ä¸€ç¯‡</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>