<!DOCTYPE html>
<html style="display: none;" lang="en">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            macho完整加载过程(未完...) | 
        
        Zz
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="jmpews">
    <meta name="description" itemprop="description" content="pwn &amp; dev &amp; reverse">
    <meta name="keywords" content="null,darwin,交叉编译,darwin逆向">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Zz">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://jmpews.github.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="macho完整加载过程(未完...) | Zz">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="pwn &amp; dev &amp; reverse">
    <meta property="og:article:tag" content="darwin"> <meta property="og:article:tag" content="交叉编译"> <meta property="og:article:tag" content="darwin逆向"> 

    
        <meta property="article:published_time" content="Thu Apr 20 2017 16:33:09 GMT+0800" />
        <meta property="article:modified_time" content="Tue Jun 20 2017 16:06:55 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="macho完整加载过程(未完...) | Zz">
    <meta name="twitter:description" content="pwn &amp; dev &amp; reverse">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://jmpews.github.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Zz",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "jmpews",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "Zz..."
    },
    "headline": "macho完整加载过程(未完...)",
    "url": "http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/index.html",
    "datePublished": "Thu Apr 20 2017 16:33:09 GMT+0800",
    "dateModified": "Tue Jun 20 2017 16:06:55 GMT+0800",
    "description": "pwn &amp; dev &amp; reverse",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://jmpews.github.com"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    .footer-sns-twitter {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHptNTMyLjggMjA1YzEwIDQgMjMgMTAuOCAyOC44IDE1LjIgMTIuNiA5LjIgMTYuNiAxMC42IDI5LjQgOS40IDYuNi0uNiAxMy0zLjIgMjAuNC04LjIgMTEuMi03LjYgMTkuNC05LjIgMjMuNi01IDMuNiAzLjYgMi44IDktMi44IDE4LjYtNy4yIDEyLjQtNiAxOC44IDQuMiAyNC4yIDQuNCAyLjIgOC4yIDUuNiA4LjYgNy40IDEgNC44LTEyLjYgMjQuMi0yMiAzMS44LTExLjggOS4yLTE3LjIgMjIuNi0xOS42IDQ3LjgtNC44IDUwLjQtNy44IDY2LjYtMTYuNCA4NS40LTMgNy03IDE3LjgtOC44IDI0LTEuOCA2LjQtNSAxNC42LTcuNCAxOC40LTIuMiAzLjgtNy40IDEzLTExLjQgMjAuNC0xNy4yIDMwLjgtNDMuNCA2MS40LTcxLjQgODMuOC0yNS42IDIwLjQtNDYgMzMuMi02NC4yIDQwLjItOC40IDMuMi0xOCA3LjYtMjEuNCA5LjYtNy40IDQuNi0yMi40IDguNi01Ny4yIDE1LTYyLjIgMTEuNi03OS4yIDExLjQtMTM1LjYtMS0zMi40LTctMzguNi05LTUyLTE2LjgtMjEuNC0xMi42LTI0LjItMTQuOC0yNC4yLTE5LjQgMC02LjIgMTAuMi05LjIgMzUtMTAuNCAyMi40LTEgMjguNi0yLjYgNTctMTQuMiAyMy44LTkuOCAyOS40LTEyLjggMzAuNC0xNi44IDIuMi04LjItMy0xMy4yLTI2LjgtMjUuNC0yNS44LTEzLjItMzIuMi0xOC40LTQzLjgtMzUuOC05LTEzLjYtMTAtMjEuMi0zLjYtMzMuNiA1LjQtMTAuOCAzLjYtMTUtMTEuOC0yNS40LTktNi0xNC0xMS42LTIwLjgtMjIuNi0yMy40LTM3LjgtMjUtNTAuOC03LjItNTkuOCA0LjgtMi40IDkuNC01LjQgMTAuMi02LjYgMi44LTQuMi0uNC0xNS42LTguNC0yOS0xMS42LTE5LjYtMTMuMi0yNS44LTEzLjItNTUuMiAwLTI4LjggMi42LTM3LjggMTItNDAuMiA5LTIuMiAxNC44IDEgMzUuNiAyMC4yIDI0LjggMjIuOCA0My42IDM2LjYgNjIuOCA0NS44IDggMy44IDE3LjggOS4yIDIyIDEyIDQuMiAyLjggMTQuOCA3IDIzLjQgOS4yIDguNiAyLjIgMjQuMiA2LjggMzQuOCAxMC4yIDEzLjQgNC40IDIzLjYgNi40IDMzIDYuNiAxMi44LjIgMTQuMi0uMiAxOC42LTUuNCA0LTQuOCA0LjgtNy44IDQuOC0xOS4yIDAtMTQuNCA1LjYtMzkuNiAxMS4yLTUwLjYgNC4yLTguNCAyOS4yLTM0LjIgMzkuOC00MS40IDcuOC01LjQgMzUuNi0xNiA1Mi0yMCAxNC4yLTMuNiAzMi42LTEuMiA1Mi40IDYuOHoiLz48L3N2Zz4=);
    }
    
    
    
    .footer-sns-weibo {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzUuMiA3OWMtOC42IDMtMjIuOCAxMi40LTMyLjggMjEuOC04LjIgNy44LTIyLjIgMzEtMjQuNiA0MC42LTEgNC4yLTEuNiAxNjctMS42IDM2NC42IDAgMjg0LjguNCAzNTguNCAyLjYgMzY0IDEuNCAzLjggNi44IDEzIDEyIDIwLjQgOC44IDEyLjggMjQgMjUuNCA0MS44IDM1IDYgMy40IDI3IDMuNiAzNjcuNCAzLjYgMjg2LjIgMCAzNjIuNi0uNiAzNjktMi42IDE5LjgtNi4yIDUxLjItMzcuNiA1Ny40LTU3LjQgMi02LjQgMi42LTgyLjYgMi42LTM2OFYxNDFsLTQuMi05Yy0xMS42LTI0LTM5LjItNDkuOC01OC4yLTU0LjItNC4yLTEtMTY4LjYtMS42LTM2NS42LTEuNi0zMDAgMC0zNTkuMi40LTM2NS44IDIuOHptNTU4LjYgMTY5YzguNiAxLjIgMTYuNCA0IDI0IDguNiA2LjIgMy42IDE1LjIgOC4yIDIwLjIgMTAuMiA1LjggMi4yIDE0LjYgOC44IDI1IDE4LjggMjUuNCAyNC44IDMyLjggMzQuOCAzNy44IDUxIDIuNiA4IDcuNCAxOS44IDEwLjggMjYuNCA3LjggMTQuNiAxMS42IDQyLjYgOS40IDY5LTEgMTQuMi0yLjIgMTguNi03LjQgMjYuNC0zLjIgNS4yLTkgMTIuMi0xMi44IDE1LjYtMTMuOCAxMi0zNCA1LjgtMzguOC0xMi0xLjYtNi0xLjQtMTEuNCAxLjItMjMuNCA0LjItMjAgMy00Ni0yLjYtNTguNi0yLjItNS04LTEyLjYtMTIuOC0xNi44LTQuOC00LjItMTQuNi0xNi40LTIxLjgtMjYuOC03LjItMTAuNi0xNS4yLTIwLjgtMTgtMjIuOC0yLjgtMi0xMi42LTYtMjItOS0xNC40LTQuNC0yMC44LTUuNC00My01LjYtMjgtLjItMzEuNC0xLjItNDIuNC0xMS42LTcuNC03LTguNi0xNS42LTMuOC0yNS4yIDctMTMuMiAxNi40LTE2IDU0LjItMTYgMTYuNiAwIDM1LjguOCA0Mi44IDEuOHptLTIxMy42IDc1LjZjMjAuMiAxNS40IDIwLjYgMTYuNCAyMiA0OCAuNiAxNSAxLjggMjkgMi42IDMxIDIuOCA2LjIgMTEgNi42IDIxLjYuNiA1LjQtMy4yIDE0LTUuOCAyMC02LjQgNS44LS42IDE4LjgtMi40IDI5LTQuMiAxNy4yLTMgMTkuNC0zIDM2IC40IDMyIDYuNiAzNS44IDkuMiA0NC4yIDMxLjYgNS4yIDE0IDUuNCAyMS40IDEuMiAzMi44LTIuMiA1LjQtMi44IDExLTIgMTUuNCAxLjggMTAgMTcuNiAyMy40IDM1IDMwLjIgMTEuMiA0LjIgMTYuMiA3LjYgMjcgMTkgMTkuMiAxOS44IDIwLjIgMjMgMjAgNTktLjIgMzUtLjQgMzUuNC0xOS44IDYzLjYtMTMuOCAxOS44LTMyLjQgMzguNi00OSA1MC01IDMuNC0xMi4yIDguOC0xNS44IDEyLTMuOCAzLjItMTEuNiA4LTE3LjIgMTAuNC01LjYgMi42LTE0LjYgNy40LTE5LjggMTAuNi01LjIgMy40LTE1LjggNy42LTIzLjggOS40LTggMi0yMS4yIDYuNi0yOS42IDEwLjItMjIuNCAxMC0zNi4yIDExLjItMTIxLjggMTAuNGwtNzUtLjYtMTktOC40Yy0xMC42LTQuNi0yNS40LTkuOC0zMy0xMS42LTcuNi0xLjYtMTgtNS44LTIzLTlzLTE0LjItOC0yMC40LTEwLjhjLTE4LTgtNTkuNC00Ni4yLTY2LTYxLjItMi4yLTUtNy40LTE0LjQtMTEuNC0yMC44bC03LjItMTJWNTQ5bDcuNi0xMy42YzQuMi03LjQgOS40LTE4LjYgMTEuNi0yNC44IDMuOC0xMS40IDEzLjQtMjcuOCAyNC44LTQyLjYgMjAuMi0yNi4yIDM4LjQtNDYuOCA1My02MCA5LjItOC4yIDIxLTE4LjYgMjYtMjMuMiA1LTQuNCAxMy4yLTExIDE4LjYtMTQuNiA1LjItMy40IDkuNC03LjIgOS40LTggMC0xIDUuNi00LjYgMTIuNi04LjIgNi44LTMuOCAxNi40LTkuNiAyMS40LTEzLjIgNS0zLjYgMTQuNC04IDIxLTkuOCA2LjYtMiAxNy44LTYuNiAyNS0xMC4yIDEyLTYuMiAxNC40LTYuOCAzMi40LTYuOGgxOS40bDEyLjQgOS42em0yMDMuNiAxMy4yYzMgMS42IDYuNiA0LjQgOCA2IDEuNiAxLjggOS40IDcgMTcuNCAxMS42IDE3IDkuNiAxOSAxMyAyNCA0MiAzLjQgMjAuNCAyLjYgMzIuMi0zLjQgNDMuOC03LjYgMTUuMi0yMi44IDIwLjYtMzEuMiAxMS4yLTctNy42LTkuMi0xMy44LTEwLjYtMjkuNi0xLjItMTMuMi0yLjQtMTYuNC05LjYtMjcuMi0xMS0xNi0xNi44LTIwLjYtMjcuMi0yMC42LTEwIDAtMjQtNi4yLTI3LTExLjYtNS44LTEwLjguNC0yNC42IDEyLjQtMjguNCA4LjYtMi42IDQwLjItLjggNDcuMiAyLjh6Ii8+PHBhdGggZD0iTTQyNCA0NzcuNGMtMzIuNiAzLjYtNDcuOCA3LTYxLjggMTMuOC04IDQtMTkgOC40LTI0LjIgMTAtNS4yIDEuNi0xMi40IDUtMTYuMiA3LjgtMy44IDIuNi0xMSA3LjYtMTYuMiAxMS0xMy40IDguOC0zNSAzMy4yLTM4LjggNDQtMS44IDUtNS40IDE0LjQtOC4yIDIxLTguOCAyMS4yLTguMiAyNi44IDQgNTMgMTAuNiAyMi42IDExIDIzLjIgMjcuNiAzNi40IDIxIDE2LjggMjMuNiAxOC40IDUwLjggMjguMiAyMC4yIDcuMiAyNC42IDggNTQgMTAgMTcuNiAxLjIgNDUuNiAyLjIgNjIgMi4ybDMwIC4yIDE3LjQtOC40YzkuNi00LjYgMjIuNC05LjYgMjguMi0xMS40IDYtMS44IDE1LjQtNi4yIDIwLjgtMTAgNS40LTMuNiAxMy40LTguNiAxNy42LTEwLjggOS4yLTQuNiAzOS0zNC40IDM5LTM5IDAtMS42IDMuOC0xMC4yIDguNC0xOC44IDcuOC0xNC4yIDguNi0xNi44IDguNC0yOS42LS4yLTEyLjgtMS0xNS44LTEwLjYtMzQuNi0xMy40LTI2LjItMzAuNC00My42LTUwLjItNTEuNC03LjItMi44LTE2LjItNy0yMC05LjYtMTEuNC03LjYtMTcuNi05LjItNDguOC0xMi40LTI3LjYtMi44LTU2LjYtMy40LTczLjItMS42em0zOS40IDQ0LjRjMTEuMiAyLjIgMjIuNiA1IDI1IDYuNCA3IDMuNiAyNiAyMS44IDMwLjggMjkuNCA4LjYgMTMuNCAxMSA1NCA0LjYgNzctMi42IDkuNi0xOC44IDI3LjYtMzkuNCA0NC4yLTE1LjYgMTIuNC0xNyAxMy0yOS44IDE0LTcuNi44LTIyLjQgMi4yLTMzIDMuNi0yMi42IDIuNi00NS42IDEtNTMuOC0zLjgtMy4yLTItOC02LjgtMTAuOC0xMC44LTIuNi00LjItOC40LTEwLjQtMTIuOC0xMy44LTguMi02LjgtMTMuNC0xNi40LTE5LjQtMzctMy44LTEzLjItMi44LTIxLjggNS4yLTQ3LjYgMy4yLTEwLjQgNi0xNC42IDE3LjQtMjUuOCAxMi40LTEyLjIgMjMuOC0yMi4yIDMzLjItMjkuNiA0LTMgMzguNi05LjQgNTMuNC05LjggNSAwIDE4LjIgMS42IDI5LjQgMy42eiIvPjxwYXRoIGQ9Ik0zODcuMiA2MDZjLTEyLjIgMy44LTE4LjIgMTMuNC0xNSAyNC42IDUuOCAyMS4yIDI3LjggMjUuOCA0MC42IDguNiA2LjYtOC44IDcuOC0xNi4yIDQuMi0yNC00LjgtMTAuMi0xNS40LTEzLjQtMjkuOC05LjJ6Ii8+PC9zdmc+);
    }
    
    
    
    .footer-sns-tumblr {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi4yIDEuNC0yNi4yIDE0LjItMzYuMiAyMi44LTIuNiAyLjQtOSAxMC44LTE0LjIgMTguOC03LjQgMTEtMTAgMTcuMi0xMSAyNS0uNiA1LjgtMSAxNzAuNi0uNiAzNjYuNC42IDI5Ni44IDEgMzU2LjggMy40IDM2MSAxMSAyMC4yIDIxLjYgMzIuNCAzNy4yIDQzIDE1LjYgMTAuNiAxNy4yIDExLjIgMzQuMiAxMy4yIDExLjQgMS4yIDE0My4yIDEuOCAzNjQuOCAxLjQgMzEzLjgtLjYgMzQ3LjYtMSAzNTQtMy44IDIzLjItMTAuNiA0Mi40LTI5LjIgNTMuNi01MS44bDUuNC0xMSAuNi0zNDdjLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy4yLTM0LjItMTAuNi0xNS44LTIyLjQtMjUuOC00My0zNy00LjItMi40LTY1LjQtMi44LTM2Ni0zLjItMTk4LjYgMC0zNjQgLjQtMzY3LjYgMS40em00MDAuNCAxMzEuOGw1LjIgNC44djQ3LjhjMCAzNS40LjYgNDkuNCAyLjYgNTQuMiA1LjQgMTIuNCA0LjggMTIuNCA2Mi42IDEyLjYgNTcuNi4yIDU3IDAgNjIuMiAxMi4yIDMuMiA4IDMuOCA5My42LjYgMTA1LTEuMiA0LTQuNiA5LjQtNy40IDExLjYtNS4yIDQtNy4yIDQuMi01NiAzLjZMNTU4IDQ2MWwtNiA2LjJjLTkuMiA5LjItMTAuNCAyMi42LTkuNiAxMTMuNi42IDcxLjQgMSA3OC44IDQuMiA4NSA1IDkgMTguOCAyMy44IDI1LjYgMjcuNCA2LjYgMy4yIDQyLjYgNCA1MC44LjggMi44LTEgOS42LTYgMTUtMTEuMiA4LjQtNy44IDEwLjYtOSAxNy4yLTguNCA5LjIuOCAxNC44IDcuNiAxNyAyMSAyLjggMTYuOCAyLjIgNjgtMSA3NS4yLTQgOS42LTI1LjIgMjguOC0zMy40IDMwLjQtMy44LjYtNDEuNC44LTgzLjguNi04My42LS42LTgwLjgtLjItOTQtMTIuNi0zLjgtMy42LTEyLTguMi0xOC0xMC0xOC4yLTYtMjctMTguNi0yOS44LTQzLjYtMS4yLTguNi00LTE5LjItNy40LTI2LjQtNy0xNC44LTctMTYuNi03LjgtMTQ1LjgtLjYtMTA4LjguOC0xMDEuMi0xNy40LTEwMS4yLTUuNCAwLTEyLjItMS4yLTE1LjItMi44LTEwLjQtNS40LTExLjQtMTAtMTEuNC01NS4yIDAtMzUuNi42LTQyIDMuNi00Ni42IDUtNy42IDExLTEzIDIzLjQtMjEgMTEuNi03LjQgMjkuMi0yNC42IDM3LTM2LjQgMi40LTMuOCA3LjgtMTAuMiAxMS44LTEzLjggNi42LTYuNCA3LjItOCA3LjItMTguMiAwLTYuMiAxLjItMTUuOCAyLjgtMjEuMiAxLjYtNS40IDMuNC0xMy44IDQuMi0xOC44IDMuMi0yMS42IDktMjQuMiA1NS40LTIzLjQgMzQuMi40IDM1LjQuNiA0MC40IDUuMnoiLz48L3N2Zz4=);
    }
    
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">1.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#xnu-层工作分析之初始化阶段"><span class="post-toc-number">2.</span> <span class="post-toc-text">xnu 层工作分析之初始化阶段</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#xnu-层工作分析之加载解析"><span class="post-toc-number">3.</span> <span class="post-toc-text">xnu 层工作分析之加载解析</span></a></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                macho完整加载过程(未完...)
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>jmpews</strong>
        <span>Apr 20, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/darwin/">darwin</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/darwin逆向/">darwin逆向</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/交叉编译/">交叉编译</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=macho完整加载过程(未完...)&url=http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                Share to Weibo
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=macho完整加载过程(未完...)&url=http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/index.html&via=jmpews" target="_blank">
            <li class="mdl-menu__item">
                Share to Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近需要做一些 macho 的解析, 定制的工具, 所以打算读一下 xnu, dyld, objc 的源码.</p>
<p>所有的参考资料都可以在 <a href="http://github.com/jmpews/pwn2exploit" target="_blank" rel="external">pwn2exploit/refs</a> 中找到.</p>
<p>对于注释前缀为 <code>-</code> 表示这一部分代码用注释表示</p>
<p>还没有分析完, 待续…</p>
<h2 id="xnu-层工作分析之初始化阶段"><a href="#xnu-层工作分析之初始化阶段" class="headerlink" title="xnu 层工作分析之初始化阶段"></a>xnu 层工作分析之初始化阶段</h2><p><img src="/images/Sequence-of-Step-in-Executing-an-Image.png" alt=""></p>
<p>这一部分处理并不是 parser 的处理.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span></div><div class="line">__mac_execve(<span class="keyword">proc_t</span> p, <span class="keyword">struct</span> __mac_execve_args *uap, <span class="keyword">int32_t</span> *retval)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// -Allocate a big chunk for locals instead of using stack since these structures a pretty big.</span></div><div class="line">    </div><div class="line">    <span class="comment">// -Initialize the common data in the image_params structure</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line">    <span class="title">exec_activate_image</span><span class="params">(<span class="keyword">struct</span> image_params *imgp)</span></div><div class="line">    &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// -继续初始化 image_params 成员属性</span></div><div class="line">        </div><div class="line">        <span class="comment">// 读取-页的数据到内存</span></div><div class="line">        error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</div><div class="line">                        UIO_SYSSPACE, IO_NODELOCKED,</div><div class="line">                        vfs_context_ucred(imgp-&gt;ip_vfs_context),</div><div class="line">                        &amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; error == <span class="number">-1</span> &amp;&amp; execsw[i].ex_imgact != <span class="literal">NULL</span>; i++) &#123;</div><div class="line">            <span class="comment">// 根据 imgp-&gt;ip_vdata 判断文件类型, 对于不懂返回值表示含义建议参考源码</span></div><div class="line">            <span class="comment">// error = (*execsw[i].ex_imgact)(imgp);</span></div><div class="line">            <span class="comment">// 关于 execsw 的定义参考附1,因此替换为 exec_activate_image</span></div><div class="line">            <span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line">            <span class="title">exec_activate_image</span><span class="params">(<span class="keyword">struct</span> image_params *imgp)</span></div><div class="line">            &#123;</div><div class="line">                <span class="comment">// 开始加载mahco</span></div><div class="line">                <span class="keyword">load_return_t</span></div><div class="line">                load_machfile(</div><div class="line">                              <span class="keyword">struct</span> image_params	*imgp,</div><div class="line">                              <span class="keyword">struct</span> mach_header	*header,</div><div class="line">                              <span class="keyword">thread_t</span> 		thread,</div><div class="line">                              <span class="keyword">vm_map_t</span> 		*mapp,</div><div class="line">                              <span class="keyword">load_result_t</span>		*result</div><div class="line">                              );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>附1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Our image activator table; this is the table of the image types we are</div><div class="line"> * capable of loading.  We list them in order of preference to ensure the</div><div class="line"> * fastest image load speed.</div><div class="line"> *</div><div class="line"> * XXX hardcoded, for now; should use linker sets</div><div class="line"> */</div><div class="line">struct execsw &#123;</div><div class="line">    int (*ex_imgact)(struct image_params *);</div><div class="line">    const char *ex_name;</div><div class="line">&#125; execsw[] = &#123;</div><div class="line">    &#123; exec_mach_imgact,		&quot;Mach-o Binary&quot; &#125;,</div><div class="line">    &#123; exec_fat_imgact,		&quot;Fat Binary&quot; &#125;,</div><div class="line">    &#123; exec_shell_imgact,		&quot;Interpreter Script&quot; &#125;,</div><div class="line">    &#123; NULL, NULL&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="xnu-层工作分析之加载解析"><a href="#xnu-层工作分析之加载解析" class="headerlink" title="xnu 层工作分析之加载解析"></a>xnu 层工作分析之加载解析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load_return_t</span></div><div class="line">load_machfile(</div><div class="line">              <span class="keyword">struct</span> image_params   *imgp,</div><div class="line">              <span class="keyword">struct</span> mach_header    *header,</div><div class="line">              <span class="keyword">thread_t</span>      thread,</div><div class="line">              <span class="keyword">vm_map_t</span>      *mapp,</div><div class="line">              <span class="keyword">load_result_t</span>     *result</div><div class="line">              )</div><div class="line">&#123;</div><div class="line">    <span class="keyword">mach_vm_offset_t</span>    aslr_offset = <span class="number">0</span>;</div><div class="line">    <span class="keyword">mach_vm_offset_t</span>    dyld_aslr_offset = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/*</span></div><div class="line">     map = vm_map_create(pmap,</div><div class="line">     0,</div><div class="line">     vm_compute_max_offset(result-&gt;is64bit),</div><div class="line">     TRUE);</div><div class="line">     */</div><div class="line">    <span class="keyword">vm_map_t</span></div><div class="line">    vm_map_create(</div><div class="line">                  <span class="keyword">pmap_t</span>            pmap,</div><div class="line">                  <span class="keyword">vm_map_offset_t</span>   min,</div><div class="line">                  <span class="keyword">vm_map_offset_t</span>   max,</div><div class="line">                  <span class="keyword">boolean_t</span>     pageable);</div><div class="line"><span class="comment">// 默认未定义 CONFIG_ENFORCE_SIGNED_CODE,</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_ENFORCE_SIGNED_CODE</span></div><div class="line">    <span class="comment">/* This turns off faulting for executable pages, which allows</span></div><div class="line">     * to circumvent Code Signing Enforcement. The per process</div><div class="line">     * flag (CS_ENFORCEMENT) is not set yet, but we can use the</div><div class="line">     * global flag.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> ( !cs_enforcement(<span class="literal">NULL</span>) &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION) )</div><div class="line">        vm_map_disable_NX(<span class="built_in">map</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC))</div><div class="line">        vm_map_disallow_data_exec(<span class="built_in">map</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 这一块关于 aslr 的启用判断见附2</span></div><div class="line">    <span class="comment">// 这里关于 aslr 的随机范围见附3</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Compute a random offset for ASLR, and an independent random offset for dyld.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</div><div class="line">        <span class="keyword">uint64_t</span> max_slide_pages;</div><div class="line">        </div><div class="line">        max_slide_pages = vm_map_get_max_aslr_slide_pages(<span class="built_in">map</span>);</div><div class="line">        </div><div class="line">        aslr_offset = random();</div><div class="line">        aslr_offset %= max_slide_pages;</div><div class="line">        aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line">        </div><div class="line">        dyld_aslr_offset = random();</div><div class="line">        dyld_aslr_offset %= max_slide_pages;</div><div class="line">        dyld_aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 开始解析文件</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     lret = parse_machfile(vp, map, thread, header, file_offset, macho_size,</div><div class="line">                          0, (int64_t)aslr_offset, (int64_t)dyld_aslr_offset, result,</div><div class="line">                          NULL, imgp);</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span></span></div><div class="line">    load_return_t</div><div class="line">    <span class="title">parse_machfile</span><span class="params">(</span></div><div class="line">                   <span class="keyword">struct</span> vnode         *vp,</div><div class="line">                   <span class="keyword">vm_map_t</span>     <span class="built_in">map</span>,</div><div class="line">                   <span class="keyword">thread_t</span>     thread,</div><div class="line">                   <span class="keyword">struct</span> mach_header   *header,</div><div class="line">                   <span class="keyword">off_t</span>            file_offset,</div><div class="line">                   <span class="keyword">off_t</span>            macho_size,</div><div class="line">                   <span class="keyword">int</span>          depth,</div><div class="line">                   <span class="keyword">int64_t</span>          aslr_offset,</div><div class="line">                   <span class="keyword">int64_t</span>          dyld_aslr_offset,</div><div class="line">                   <span class="keyword">load_result_t</span>        *result,</div><div class="line">                   <span class="keyword">load_result_t</span>        *binresult,</div><div class="line">                   <span class="keyword">struct</span> image_params  *imgp</div><div class="line">                   )</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 可以通过对 header 的 MH_PIE 标志位进行修改绕过 aslr, 但是 dyld 没有办法绕过</span></div><div class="line">        <span class="comment">/*</span></div><div class="line">         *  For PIE and dyld, slide everything by the ASLR offset.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> ((header-&gt;flags &amp; MH_PIE) || is_dyld) &#123;</div><div class="line">            slide = aslr_offset;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">/*</span></div><div class="line">         这里为什么分三次进行加载?</div><div class="line">         需要先初始化一些特殊的加载命令(LOAD_COMMAND), 比如 LC_MAIN, LC_UUID, LC_CODE_SIGNATURE</div><div class="line">         */</div><div class="line">        <span class="comment">/*</span></div><div class="line">         *  Scan through the commands, processing each one as necessary.</div><div class="line">         *  We parse in three passes through the headers:</div><div class="line">         *  0: determine if TEXT and DATA boundary can be page-aligned</div><div class="line">         *  1: thread state, uuid, code signature</div><div class="line">         *  2: segments</div><div class="line">         *  3: dyld, encryption, check entry point</div><div class="line">         */</div><div class="line">        <span class="keyword">boolean_t</span> slide_realign = FALSE;</div><div class="line">        <span class="keyword">for</span> (pass = <span class="number">0</span>; pass &lt;= <span class="number">3</span>; pass++) &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (pass == <span class="number">0</span> &amp;&amp; !slide_realign &amp;&amp; !is_dyld) &#123;</div><div class="line">                <span class="comment">/* if we dont need to realign the slide or determine dyld's load</span></div><div class="line">                 * address, pass 0 can be skipped */</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pass == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 这一块是针对 dyld 处理, 对于 binresult 在加载二进制文件时该值为 NULL. 在加载 dyld 时, 默认是加载在二进制文件之后, 这有利于爆破 dyld 的地址.</div><div class="line">                */</div><div class="line">                <span class="keyword">if</span> (dyld_no_load_addr &amp;&amp; binresult) &#123;</div><div class="line">                    <span class="comment">// 这里我们在获取到二进制内存地址的所有的 segment 的最大虚拟地址</span></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * The dyld Mach-O does not specify a load address. Try to locate</div><div class="line">                     * it right after the main binary. If binresult == NULL, load</div><div class="line">                     * directly to the given slide.</div><div class="line">                     */</div><div class="line">                    slide = vm_map_round_page(slide + binresult-&gt;max_vm_addr, effective_page_mask);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Check that the entry point is contained in an executable segments</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (!result-&gt;using_lcmain &amp;&amp; result-&gt;validentry == <span class="number">0</span>)) &#123;</div><div class="line">                thread_state_initialize(thread);</div><div class="line">                ret = LOAD_FAILURE;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Check that some segment maps the start of the mach-o file, which is</div><div class="line">             * needed by the dynamic loader to read the mach headers, etc.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (found_header_segment == FALSE)) &#123;</div><div class="line">                ret = LOAD_BADMACHO;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Loop through each of the load_commands indicated by the</div><div class="line">             * Mach-O header; if an absurd value is provided, we just</div><div class="line">             * run off the end of the reserved section by incrementing</div><div class="line">             * the offset too far, so we are implicitly fail-safe.</div><div class="line">             */</div><div class="line">            offset = mach_header_sz;</div><div class="line">            ncmds = header-&gt;ncmds;</div><div class="line">            </div><div class="line">            <span class="keyword">while</span> (ncmds--) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 *  Get a pointer to the command.</div><div class="line">                 */</div><div class="line">                lcp = (<span class="keyword">struct</span> load_command *)(addr + offset);</div><div class="line">                oldoffset = offset;</div><div class="line">                offset += lcp-&gt;cmdsize;</div><div class="line">                </div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Perform prevalidation of the struct load_command</div><div class="line">                 * before we attempt to use its contents.  Invalid</div><div class="line">                 * values are ones which result in an overflow, or</div><div class="line">                 * which can not possibly be valid commands, or which</div><div class="line">                 * straddle or exist past the reserved section at the</div><div class="line">                 * start of the image.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (oldoffset &gt; offset ||</div><div class="line">                    lcp-&gt;cmdsize &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> load_command) ||</div><div class="line">                    offset &gt; header-&gt;sizeofcmds + mach_header_sz) &#123;</div><div class="line">                    ret = LOAD_BADMACHO;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Act on struct load_command's for which kernel</div><div class="line">                 * intervention is required.</div><div class="line">                 */</div><div class="line">                <span class="keyword">switch</span>(lcp-&gt;cmd) &#123;</div><div class="line">                    <span class="comment">// -这里删除了 LC_SEGMENT 的 case</span></div><div class="line">                        </div><div class="line">                    <span class="keyword">case</span> LC_SEGMENT_64: &#123;</div><div class="line">                        <span class="keyword">struct</span> segment_command_64 *scp64 = (<span class="keyword">struct</span> segment_command_64 *) lcp;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</div><div class="line">                            <span class="keyword">if</span> (is_dyld &amp;&amp; scp64-&gt;vmaddr == <span class="number">0</span> &amp;&amp; scp64-&gt;fileoff == <span class="number">0</span>) &#123;</div><div class="line">                                dyld_no_load_addr = TRUE;</div><div class="line">                                <span class="keyword">if</span> (!slide_realign) &#123;</div><div class="line">                                    <span class="comment">/* got what we need, bail early on pass 0 */</span></div><div class="line">                                    <span class="keyword">continue</span>;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; !<span class="built_in">strncmp</span>(scp64-&gt;segname, <span class="string">"__XHDR"</span>, <span class="keyword">sizeof</span>(scp64-&gt;segname))) &#123;</div><div class="line">                            found_xhdr = TRUE;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">2</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (!abi64) &#123;</div><div class="line">                            <span class="comment">/*</span></div><div class="line">                             * Having an LC_SEGMENT_64 command for the</div><div class="line">                             * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</div><div class="line">                             */</div><div class="line">                            ret = LOAD_BADMACHO;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        ret = load_segment(lcp,</div><div class="line">                                           header-&gt;filetype,</div><div class="line">                                           control,</div><div class="line">                                           file_offset,</div><div class="line">                                           macho_size,</div><div class="line">                                           vp,</div><div class="line">                                           <span class="built_in">map</span>,</div><div class="line">                                           slide,</div><div class="line">                                           result);</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (ret == LOAD_SUCCESS &amp;&amp; scp64-&gt;fileoff == <span class="number">0</span> &amp;&amp; scp64-&gt;filesize &gt; <span class="number">0</span>) &#123;</div><div class="line">                            <span class="comment">/* Enforce a single segment mapping offset zero, with R+X</span></div><div class="line">                             * protection. */</div><div class="line">                            <span class="keyword">if</span> (found_header_segment ||</div><div class="line">                                ((scp64-&gt;initprot &amp; (VM_PROT_READ|VM_PROT_EXECUTE)) != (VM_PROT_READ|VM_PROT_EXECUTE))) &#123;</div><div class="line">                                ret = LOAD_BADMACHO;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                            found_header_segment = TRUE;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">case</span> LC_UNIXTHREAD:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        ret = load_unixthread(</div><div class="line">                                              (<span class="keyword">struct</span> thread_command *) lcp,</div><div class="line">                                              thread,</div><div class="line">                                              slide,</div><div class="line">                                              result);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// -设置入口点</span></div><div class="line">                    <span class="keyword">case</span> LC_MAIN:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="keyword">if</span> (depth != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        ret = load_main(</div><div class="line">                                        (<span class="keyword">struct</span> entry_point_command *) lcp,</div><div class="line">                                        thread,</div><div class="line">                                        slide,</div><div class="line">                                        result);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// 这个比较重要 表明需要加载 dyld, 但是是在三次解析加载完成后</span></div><div class="line">                    <span class="keyword">case</span> LC_LOAD_DYLINKER:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="keyword">if</span> ((depth == <span class="number">1</span>) &amp;&amp; (dlp == <span class="number">0</span>)) &#123;</div><div class="line">                            dlp = (<span class="keyword">struct</span> dylinker_command *)lcp;</div><div class="line">                            dlarchbits = (header-&gt;cputype &amp; CPU_ARCH_MASK);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            ret = LOAD_FAILURE;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// 没啥好说, 读取并保存 uuid</span></div><div class="line">                    <span class="keyword">case</span> LC_UUID:</div><div class="line">                        <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; depth == <span class="number">1</span>) &#123;</div><div class="line">                            ret = load_uuid((<span class="keyword">struct</span> uuid_command *) lcp,</div><div class="line">                                            (<span class="keyword">char</span> *)addr + mach_header_sz + header-&gt;sizeofcmds,</div><div class="line">                                            result);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// <span class="doctag">TODO:</span> 这里暂时没有情景没有分析</span></div><div class="line">                    <span class="keyword">case</span> LC_CODE_SIGNATURE:</div><div class="line">                        <span class="comment">/* CODE SIGNING */</span></div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="comment">/* pager -&gt; uip -&gt;</span></div><div class="line">                         load signatures &amp; store in uip</div><div class="line">                         set VM object "signed_pages"</div><div class="line">                         */</div><div class="line">                        ret = load_code_signature(</div><div class="line">                                                  (<span class="keyword">struct</span> linkedit_data_command *) lcp,</div><div class="line">                                                  vp,</div><div class="line">                                                  file_offset,</div><div class="line">                                                  macho_size,</div><div class="line">                                                  header-&gt;cputype,</div><div class="line">                                                  result,</div><div class="line">                                                  imgp);</div><div class="line">                        <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">                            <span class="built_in">printf</span>(<span class="string">"proc %d: load code signature error %d "</span></div><div class="line">                                   <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">                                   p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">                            <span class="comment">/*</span></div><div class="line">                             * Allow injections to be ignored on devices w/o enforcement enabled</div><div class="line">                             */</div><div class="line">                            <span class="keyword">if</span> (!cs_enforcement(<span class="literal">NULL</span>))</div><div class="line">                                ret = LOAD_SUCCESS; <span class="comment">/* ignore error */</span></div><div class="line">                            </div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            got_code_signatures = TRUE;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (got_code_signatures) &#123;</div><div class="line">                            <span class="keyword">unsigned</span> tainted = CS_VALIDATE_TAINTED;</div><div class="line">                            <span class="keyword">boolean_t</span> valid = FALSE;</div><div class="line">                            <span class="keyword">vm_size_t</span> off = <span class="number">0</span>;</div><div class="line">                            </div><div class="line">                            </div><div class="line">                            <span class="keyword">if</span> (cs_debug &gt; <span class="number">10</span>)</div><div class="line">                                <span class="built_in">printf</span>(<span class="string">"validating initial pages of %s\n"</span>, vp-&gt;v_name);</div><div class="line">                            </div><div class="line">                            <span class="keyword">while</span> (off &lt; size &amp;&amp; ret == LOAD_SUCCESS) &#123;</div><div class="line">                                tainted = CS_VALIDATE_TAINTED;</div><div class="line">                                </div><div class="line">                                valid = cs_validate_range(vp,</div><div class="line">                                                          <span class="literal">NULL</span>,</div><div class="line">                                                          file_offset + off,</div><div class="line">                                                          addr + off,</div><div class="line">                                                          PAGE_SIZE,</div><div class="line">                                                          &amp;tainted);</div><div class="line">                                <span class="keyword">if</span> (!valid || (tainted &amp; CS_VALIDATE_TAINTED)) &#123;</div><div class="line">                                    <span class="keyword">if</span> (cs_debug)</div><div class="line">                                        <span class="built_in">printf</span>(<span class="string">"CODE SIGNING: %s[%d]: invalid initial page at offset %lld validated:%d tainted:%d csflags:0x%x\n"</span>, </div><div class="line">                                               vp-&gt;v_name, p-&gt;p_pid, (<span class="keyword">long</span> <span class="keyword">long</span>)(file_offset + off), valid, tainted, result-&gt;csflags);</div><div class="line">                                    <span class="keyword">if</span> (cs_enforcement(<span class="literal">NULL</span>) ||</div><div class="line">                                        (result-&gt;csflags &amp; (CS_HARD|CS_KILL|CS_ENFORCEMENT))) &#123;</div><div class="line">                                        ret = LOAD_FAILURE;</div><div class="line">                                    &#125;</div><div class="line">                                    result-&gt;csflags &amp;= ~CS_VALID;</div><div class="line">                                &#125;</div><div class="line">                                off += PAGE_SIZE;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     app store 上架的加密</div><div class="line">                     该LOAD_COMMAND 的解析是先于 SEGMENT_64 解析, 目前砸壳的思路, 是找到 runtime 的对应内存内容替换原来加密的文件内容</div><div class="line">                     */</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_CODE_DECRYPTION</span></div><div class="line">                    <span class="keyword">case</span> LC_ENCRYPTION_INFO:</div><div class="line">                    <span class="keyword">case</span> LC_ENCRYPTION_INFO_64:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         ret = set_code_unprotect(</div><div class="line">                                                 (struct encryption_info_command *) lcp,</div><div class="line">                                                 addr, map, slide, vp, file_offset,</div><div class="line">                                                 header-&gt;cputype, header-&gt;cpusubtype);</div><div class="line">                         */</div><div class="line">                        <span class="function"><span class="keyword">static</span> load_return_t</span></div><div class="line">                        <span class="title">set_code_unprotect</span><span class="params">(</span></div><div class="line">                                           <span class="keyword">struct</span> encryption_info_command *eip,</div><div class="line">                                           <span class="keyword">caddr_t</span> addr,</div><div class="line">                                           <span class="keyword">vm_map_t</span> <span class="built_in">map</span>,</div><div class="line">                                           <span class="keyword">int64_t</span> slide,</div><div class="line">                                           <span class="keyword">struct</span> vnode *vp,</div><div class="line">                                           <span class="keyword">off_t</span> macho_offset,</div><div class="line">                                           <span class="keyword">cpu_type_t</span> cputype,</div><div class="line">                                           <span class="keyword">cpu_subtype_t</span> cpusubtype)</div><div class="line">                        &#123;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">                            <span class="keyword">os_reason_t</span> load_failure_reason = OS_REASON_NULL;</div><div class="line">                            <span class="built_in">printf</span>(<span class="string">"proc %d: set_code_unprotect() error %d "</span></div><div class="line">                                   <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">                                   p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">                            <span class="comment">/* </span></div><div class="line">                             * Don't let the app run if it's </div><div class="line">                             * encrypted but we failed to set up the</div><div class="line">                             * decrypter. If the keys are missing it will</div><div class="line">                             * return LOAD_DECRYPTFAIL.</div><div class="line">                             */</div><div class="line">                            <span class="keyword">if</span> (ret == LOAD_DECRYPTFAIL) &#123;</div><div class="line">                                <span class="comment">/* failed to load due to missing FP keys */</span></div><div class="line">                                proc_lock(p);</div><div class="line">                                p-&gt;p_lflag |= P_LTERM_DECRYPTFAIL;</div><div class="line">                                proc_unlock(p);</div><div class="line">                                </div><div class="line">                                KERNEL_DEBUG_CONSTANT(BSDDBG_CODE(DBG_BSD_PROC, BSD_PROC_EXITREASON_CREATE) | DBG_FUNC_NONE,</div><div class="line">                                                      p-&gt;p_pid, OS_REASON_EXEC, EXEC_EXIT_REASON_FAIRPLAY_DECRYPT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                                load_failure_reason = os_reason_create(OS_REASON_EXEC, EXEC_EXIT_REASON_FAIRPLAY_DECRYPT);</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                </div><div class="line">                                KERNEL_DEBUG_CONSTANT(BSDDBG_CODE(DBG_BSD_PROC, BSD_PROC_EXITREASON_CREATE) | DBG_FUNC_NONE,</div><div class="line">                                                      p-&gt;p_pid, OS_REASON_EXEC, EXEC_EXIT_REASON_DECRYPT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                                load_failure_reason = os_reason_create(OS_REASON_EXEC, EXEC_EXIT_REASON_DECRYPT);</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            assert(load_failure_reason != OS_REASON_NULL);</div><div class="line">                            psignal_with_reason(p, SIGKILL, load_failure_reason);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                    <span class="keyword">default</span>:</div><div class="line">                        <span class="comment">/* Other commands are ignored by the kernel */</span></div><div class="line">                        ret = LOAD_SUCCESS;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// 附2: 这里 ip_flags 默认的标记为 IMGPF_NONE, 所以之后会生成 aslr, 可以重新编译内核绕过</div><div class="line">// kern/kern_exec.c</div><div class="line">int</div><div class="line">__mac_execve(proc_t p, struct __mac_execve_args *uap, int32_t *retval)</div><div class="line">&#123;</div><div class="line">    imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// sys/imgact.h</div><div class="line">/*</div><div class="line"> * Image flags</div><div class="line"> */</div><div class="line">#define IMGPF_NONE      0x00000000  /* No flags */</div><div class="line">#define IMGPF_INTERPRET     0x00000001  /* Interpreter invoked */</div><div class="line">#define IMGPF_RESERVED      0x00000002</div><div class="line">#define IMGPF_WAS_64BIT     0x00000004  /* exec from a 64Bit binary */</div><div class="line">#define IMGPF_IS_64BIT      0x00000008  /* exec to a 64Bit binary */</div><div class="line">#define IMGPF_SPAWN     0x00000010  /* spawn (without setexec) */</div><div class="line">#define IMGPF_DISABLE_ASLR  0x00000020  /* disable ASLR */</div><div class="line">#define IMGPF_ALLOW_DATA_EXEC   0x00000040  /* forcibly disallow data execution */</div><div class="line">#define IMGPF_VFORK_EXEC    0x00000080  /* vfork followed by exec */</div><div class="line">#define IMGPF_EXEC      0x00000100  /* exec */</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">// 附3:</div><div class="line">// 为什么需要知道 aslr_offset 的范围, 这样就可以爆破 dyld 地址, 从而拿到 dyld_all_image_infos 结构体, 其实我们还可以通过 task_info+TASK_DYLD_INFO 获取到 dyld 地址.</div><div class="line"></div><div class="line">// 下面已经贴出了相关参考, 都可以找到.</div><div class="line"></div><div class="line">// bsd/kern/mach_loader.c</div><div class="line">load_return_t</div><div class="line">load_machfile(</div><div class="line">              struct image_params   *imgp,</div><div class="line">              struct mach_header    *header,</div><div class="line">              thread_t      thread,</div><div class="line">              vm_map_t      *mapp,</div><div class="line">              load_result_t     *result</div><div class="line">              )</div><div class="line">&#123;</div><div class="line">    map = vm_map_create(pmap,</div><div class="line">                        0,</div><div class="line">                        vm_compute_max_offset(result-&gt;is64bit),</div><div class="line">                        TRUE);</div><div class="line">    if (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</div><div class="line">        uint64_t max_slide_pages;</div><div class="line">        </div><div class="line">        max_slide_pages = vm_map_get_max_aslr_slide_pages(map);</div><div class="line">        /*</div><div class="line">         最大的 aslr_offset 的计算</div><div class="line">         aslr_offset = 1 &lt;&lt; 16</div><div class="line">         aslr_offset &lt;&lt;= 12</div><div class="line">         所以最大的 aslr_offset = 0x10000000</div><div class="line">         同样对于最小的 aslr_offset = 0x1000</div><div class="line">         */</div><div class="line">        aslr_offset = random();</div><div class="line">        aslr_offset %= max_slide_pages;</div><div class="line">        aslr_offset &lt;&lt;= vm_map_page_shift(map);</div><div class="line">        </div><div class="line">        dyld_aslr_offset = random();</div><div class="line">        dyld_aslr_offset %= max_slide_pages;</div><div class="line">        dyld_aslr_offset &lt;&lt;= vm_map_page_shift(map);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// osfmk/vm/vm_map.c</div><div class="line">vm_map_t</div><div class="line">vm_map_create(</div><div class="line">              pmap_t            pmap,</div><div class="line">              vm_map_offset_t   min,</div><div class="line">              vm_map_offset_t   max,</div><div class="line">              boolean_t     pageable)</div><div class="line">&#123;</div><div class="line">    result-&gt;hdr.page_shift = PAGE_SHIFT;</div><div class="line">&#125;</div><div class="line"></div><div class="line">vm_map_offset_t</div><div class="line">vm_compute_max_offset(boolean_t is64)</div><div class="line">&#123;</div><div class="line">    return (is64 ? (vm_map_offset_t)MACH_VM_MAX_ADDRESS : (vm_map_offset_t)VM_MAX_ADDRESS);</div><div class="line">&#125;</div><div class="line"></div><div class="line">uint64_t</div><div class="line">vm_map_get_max_aslr_slide_pages(vm_map_t map)</div><div class="line">&#123;</div><div class="line">    return (1 &lt;&lt; (vm_map_is_64bit(map) ? 16 : 8));</div><div class="line">&#125;</div><div class="line"></div><div class="line">boolean_t</div><div class="line">vm_map_is_64bit(</div><div class="line">                vm_map_t map)</div><div class="line">&#123;</div><div class="line">    return map-&gt;max_offset &gt; ((vm_map_offset_t)VM_MAX_ADDRESS);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int</div><div class="line">vm_map_page_shift(</div><div class="line">                  vm_map_t map)</div><div class="line">&#123;</div><div class="line">    return VM_MAP_PAGE_SHIFT(map);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// osfmk/vm/vm_map.h</div><div class="line">#define VM_MAP_PAGE_SHIFT(map) ((map) ? (map)-&gt;hdr.page_shift : PAGE_SHIFT)</div><div class="line"></div><div class="line">// osfmk/mach/i386/vm_param.h</div><div class="line">#define I386_PGBYTES        4096        /* bytes per 80386 page */</div><div class="line">#define I386_PGSHIFT        12      /* bitshift for pages */</div><div class="line"></div><div class="line">#define PAGE_SIZE       I386_PGBYTES</div><div class="line">#define PAGE_SHIFT      I386_PGSHIFT</div></pre></td></tr></table></figure>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/04/17/darwin/ojbc学习笔记/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/04/23/darwin/ios的反调试与绕过/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="jmpews's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        jmpews@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: jmpews@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                Home
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    Archives
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">February 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">January 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">December 2016<span class="sidebar_archives-count">42</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                Categories
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/backend/">backend<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/darwin/">darwin<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/categories/dev/">dev<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/notes/">notes<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/pwn/">pwn<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/python/">python<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/categories/test/">test<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                Tags
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                Number of articles
                <span class="sidebar-badge">71</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/jmpews" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/winter1ife" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    
        <a href="[object Object]" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-tumblr">
                <span class="visuallyhidden">Tumblr</span>
            </button><!--
     --></a>
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Zz
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
