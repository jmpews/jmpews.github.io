<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="jmpews,jmpews@gmail.com"><title>macho完整加载过程(未完...) · jmpews</title><meta name="description" content="前言最近需要做一些 macho 的解析, 定制的工具, 所以打算读一下 xnu, dyld, objc 的源码.
所有的参考资料都可以在 pwn2exploit/refs 中找到.
对于注释前缀为 - 表示这一部分代码用注释表示
还没有分析完, 待续…
xnu 层工作分析之初始化阶段
这一部分处理并"><meta name="keywords" content="py,go,pwn,reverse"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">jmpews</a></h3><div class="description"><p>py &amp; go &amp; pwn &amp; reverse</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/jmpews"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/winter1ife"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/jmpews"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>macho完整加载过程(未完...)</a></h3></div><div class="post-content"><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>最近需要做一些 macho 的解析, 定制的工具, 所以打算读一下 xnu, dyld, objc 的源码.</p>
<p>所有的参考资料都可以在 <a href="http://github.com/jmpews/pwn2exploit" target="_blank" rel="external">pwn2exploit/refs</a> 中找到.</p>
<p>对于注释前缀为 <code>-</code> 表示这一部分代码用注释表示</p>
<p>还没有分析完, 待续…</p>
<h2 id="xnu-层工作分析之初始化阶段"><a href="#xnu-层工作分析之初始化阶段" class="headerlink" title="xnu 层工作分析之初始化阶段"></a>xnu 层工作分析之初始化阶段</h2><p><img src="/images/Sequence-of-Step-in-Executing-an-Image.png" alt=""></p>
<p>这一部分处理并不是 parser 的处理.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">int</span></div><div class="line">__mac_execve(<span class="keyword">proc_t</span> p, <span class="keyword">struct</span> __mac_execve_args *uap, <span class="keyword">int32_t</span> *retval)</div><div class="line">&#123;</div><div class="line">    <span class="comment">// -Allocate a big chunk for locals instead of using stack since these structures a pretty big.</span></div><div class="line">    </div><div class="line">    <span class="comment">// -Initialize the common data in the image_params structure</span></div><div class="line">    </div><div class="line">    <span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line">    <span class="title">exec_activate_image</span><span class="params">(<span class="keyword">struct</span> image_params *imgp)</span></div><div class="line">    &#123;</div><div class="line">        </div><div class="line">        <span class="comment">// -继续初始化 image_params 成员属性</span></div><div class="line">        </div><div class="line">        <span class="comment">// 读取-页的数据到内存</span></div><div class="line">        error = vn_rdwr(UIO_READ, imgp-&gt;ip_vp, imgp-&gt;ip_vdata, PAGE_SIZE, <span class="number">0</span>,</div><div class="line">                        UIO_SYSSPACE, IO_NODELOCKED,</div><div class="line">                        vfs_context_ucred(imgp-&gt;ip_vfs_context),</div><div class="line">                        &amp;resid, vfs_context_proc(imgp-&gt;ip_vfs_context));</div><div class="line">        </div><div class="line">        <span class="keyword">for</span>(i = <span class="number">0</span>; error == <span class="number">-1</span> &amp;&amp; execsw[i].ex_imgact != <span class="literal">NULL</span>; i++) &#123;</div><div class="line">            <span class="comment">// 根据 imgp-&gt;ip_vdata 判断文件类型, 对于不懂返回值表示含义建议参考源码</span></div><div class="line">            <span class="comment">// error = (*execsw[i].ex_imgact)(imgp);</span></div><div class="line">            <span class="comment">// 关于 execsw 的定义参考附1,因此替换为 exec_activate_image</span></div><div class="line">            <span class="function"><span class="keyword">static</span> <span class="keyword">int</span></span></div><div class="line">            <span class="title">exec_activate_image</span><span class="params">(<span class="keyword">struct</span> image_params *imgp)</span></div><div class="line">            &#123;</div><div class="line">                <span class="comment">// 开始加载mahco</span></div><div class="line">                <span class="keyword">load_return_t</span></div><div class="line">                load_machfile(</div><div class="line">                              <span class="keyword">struct</span> image_params	*imgp,</div><div class="line">                              <span class="keyword">struct</span> mach_header	*header,</div><div class="line">                              <span class="keyword">thread_t</span> 		thread,</div><div class="line">                              <span class="keyword">vm_map_t</span> 		*mapp,</div><div class="line">                              <span class="keyword">load_result_t</span>		*result</div><div class="line">                              );</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>附1:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">/*</div><div class="line"> * Our image activator table; this is the table of the image types we are</div><div class="line"> * capable of loading.  We list them in order of preference to ensure the</div><div class="line"> * fastest image load speed.</div><div class="line"> *</div><div class="line"> * XXX hardcoded, for now; should use linker sets</div><div class="line"> */</div><div class="line">struct execsw &#123;</div><div class="line">    int (*ex_imgact)(struct image_params *);</div><div class="line">    const char *ex_name;</div><div class="line">&#125; execsw[] = &#123;</div><div class="line">    &#123; exec_mach_imgact,		&quot;Mach-o Binary&quot; &#125;,</div><div class="line">    &#123; exec_fat_imgact,		&quot;Fat Binary&quot; &#125;,</div><div class="line">    &#123; exec_shell_imgact,		&quot;Interpreter Script&quot; &#125;,</div><div class="line">    &#123; NULL, NULL&#125;</div><div class="line">&#125;;</div></pre></td></tr></table></figure>
<h2 id="xnu-层工作分析之加载解析"><a href="#xnu-层工作分析之加载解析" class="headerlink" title="xnu 层工作分析之加载解析"></a>xnu 层工作分析之加载解析</h2><figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div><div class="line">167</div><div class="line">168</div><div class="line">169</div><div class="line">170</div><div class="line">171</div><div class="line">172</div><div class="line">173</div><div class="line">174</div><div class="line">175</div><div class="line">176</div><div class="line">177</div><div class="line">178</div><div class="line">179</div><div class="line">180</div><div class="line">181</div><div class="line">182</div><div class="line">183</div><div class="line">184</div><div class="line">185</div><div class="line">186</div><div class="line">187</div><div class="line">188</div><div class="line">189</div><div class="line">190</div><div class="line">191</div><div class="line">192</div><div class="line">193</div><div class="line">194</div><div class="line">195</div><div class="line">196</div><div class="line">197</div><div class="line">198</div><div class="line">199</div><div class="line">200</div><div class="line">201</div><div class="line">202</div><div class="line">203</div><div class="line">204</div><div class="line">205</div><div class="line">206</div><div class="line">207</div><div class="line">208</div><div class="line">209</div><div class="line">210</div><div class="line">211</div><div class="line">212</div><div class="line">213</div><div class="line">214</div><div class="line">215</div><div class="line">216</div><div class="line">217</div><div class="line">218</div><div class="line">219</div><div class="line">220</div><div class="line">221</div><div class="line">222</div><div class="line">223</div><div class="line">224</div><div class="line">225</div><div class="line">226</div><div class="line">227</div><div class="line">228</div><div class="line">229</div><div class="line">230</div><div class="line">231</div><div class="line">232</div><div class="line">233</div><div class="line">234</div><div class="line">235</div><div class="line">236</div><div class="line">237</div><div class="line">238</div><div class="line">239</div><div class="line">240</div><div class="line">241</div><div class="line">242</div><div class="line">243</div><div class="line">244</div><div class="line">245</div><div class="line">246</div><div class="line">247</div><div class="line">248</div><div class="line">249</div><div class="line">250</div><div class="line">251</div><div class="line">252</div><div class="line">253</div><div class="line">254</div><div class="line">255</div><div class="line">256</div><div class="line">257</div><div class="line">258</div><div class="line">259</div><div class="line">260</div><div class="line">261</div><div class="line">262</div><div class="line">263</div><div class="line">264</div><div class="line">265</div><div class="line">266</div><div class="line">267</div><div class="line">268</div><div class="line">269</div><div class="line">270</div><div class="line">271</div><div class="line">272</div><div class="line">273</div><div class="line">274</div><div class="line">275</div><div class="line">276</div><div class="line">277</div><div class="line">278</div><div class="line">279</div><div class="line">280</div><div class="line">281</div><div class="line">282</div><div class="line">283</div><div class="line">284</div><div class="line">285</div><div class="line">286</div><div class="line">287</div><div class="line">288</div><div class="line">289</div><div class="line">290</div><div class="line">291</div><div class="line">292</div><div class="line">293</div><div class="line">294</div><div class="line">295</div><div class="line">296</div><div class="line">297</div><div class="line">298</div><div class="line">299</div><div class="line">300</div><div class="line">301</div><div class="line">302</div><div class="line">303</div><div class="line">304</div><div class="line">305</div><div class="line">306</div><div class="line">307</div><div class="line">308</div><div class="line">309</div><div class="line">310</div><div class="line">311</div><div class="line">312</div><div class="line">313</div><div class="line">314</div><div class="line">315</div><div class="line">316</div><div class="line">317</div><div class="line">318</div><div class="line">319</div><div class="line">320</div><div class="line">321</div><div class="line">322</div><div class="line">323</div><div class="line">324</div><div class="line">325</div><div class="line">326</div><div class="line">327</div><div class="line">328</div><div class="line">329</div><div class="line">330</div><div class="line">331</div><div class="line">332</div><div class="line">333</div><div class="line">334</div><div class="line">335</div><div class="line">336</div><div class="line">337</div><div class="line">338</div><div class="line">339</div><div class="line">340</div><div class="line">341</div><div class="line">342</div><div class="line">343</div><div class="line">344</div><div class="line">345</div><div class="line">346</div><div class="line">347</div><div class="line">348</div><div class="line">349</div><div class="line">350</div><div class="line">351</div><div class="line">352</div><div class="line">353</div><div class="line">354</div><div class="line">355</div><div class="line">356</div><div class="line">357</div><div class="line">358</div><div class="line">359</div><div class="line">360</div><div class="line">361</div><div class="line">362</div><div class="line">363</div><div class="line">364</div><div class="line">365</div><div class="line">366</div><div class="line">367</div><div class="line">368</div><div class="line">369</div><div class="line">370</div><div class="line">371</div><div class="line">372</div><div class="line">373</div><div class="line">374</div><div class="line">375</div><div class="line">376</div><div class="line">377</div><div class="line">378</div><div class="line">379</div><div class="line">380</div><div class="line">381</div><div class="line">382</div><div class="line">383</div><div class="line">384</div><div class="line">385</div><div class="line">386</div><div class="line">387</div><div class="line">388</div><div class="line">389</div><div class="line">390</div><div class="line">391</div><div class="line">392</div><div class="line">393</div><div class="line">394</div><div class="line">395</div><div class="line">396</div><div class="line">397</div><div class="line">398</div><div class="line">399</div><div class="line">400</div><div class="line">401</div><div class="line">402</div><div class="line">403</div><div class="line">404</div><div class="line">405</div><div class="line">406</div><div class="line">407</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">load_return_t</span></div><div class="line">load_machfile(</div><div class="line">              <span class="keyword">struct</span> image_params   *imgp,</div><div class="line">              <span class="keyword">struct</span> mach_header    *header,</div><div class="line">              <span class="keyword">thread_t</span>      thread,</div><div class="line">              <span class="keyword">vm_map_t</span>      *mapp,</div><div class="line">              <span class="keyword">load_result_t</span>     *result</div><div class="line">              )</div><div class="line">&#123;</div><div class="line">    <span class="keyword">mach_vm_offset_t</span>    aslr_offset = <span class="number">0</span>;</div><div class="line">    <span class="keyword">mach_vm_offset_t</span>    dyld_aslr_offset = <span class="number">0</span>;</div><div class="line">    </div><div class="line">    <span class="comment">/*</span></div><div class="line">     map = vm_map_create(pmap,</div><div class="line">     0,</div><div class="line">     vm_compute_max_offset(result-&gt;is64bit),</div><div class="line">     TRUE);</div><div class="line">     */</div><div class="line">    <span class="keyword">vm_map_t</span></div><div class="line">    vm_map_create(</div><div class="line">                  <span class="keyword">pmap_t</span>            pmap,</div><div class="line">                  <span class="keyword">vm_map_offset_t</span>   min,</div><div class="line">                  <span class="keyword">vm_map_offset_t</span>   max,</div><div class="line">                  <span class="keyword">boolean_t</span>     pageable);</div><div class="line"><span class="comment">// 默认未定义 CONFIG_ENFORCE_SIGNED_CODE,</span></div><div class="line"><span class="meta">#<span class="meta-keyword">ifndef</span> CONFIG_ENFORCE_SIGNED_CODE</span></div><div class="line">    <span class="comment">/* This turns off faulting for executable pages, which allows</span></div><div class="line">     * to circumvent Code Signing Enforcement. The per process</div><div class="line">     * flag (CS_ENFORCEMENT) is not set yet, but we can use the</div><div class="line">     * global flag.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> ( !cs_enforcement(<span class="literal">NULL</span>) &amp;&amp; (header-&gt;flags &amp; MH_ALLOW_STACK_EXECUTION) )</div><div class="line">        vm_map_disable_NX(<span class="built_in">map</span>);</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">    </div><div class="line">    <span class="keyword">if</span> ((header-&gt;flags &amp; MH_NO_HEAP_EXECUTION) &amp;&amp; !(imgp-&gt;ip_flags &amp; IMGPF_ALLOW_DATA_EXEC))</div><div class="line">        vm_map_disallow_data_exec(<span class="built_in">map</span>);</div><div class="line">    </div><div class="line">    <span class="comment">// 这一块关于 aslr 的启用判断见附2</span></div><div class="line">    <span class="comment">// 这里关于 aslr 的随机范围见附3</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     * Compute a random offset for ASLR, and an independent random offset for dyld.</div><div class="line">     */</div><div class="line">    <span class="keyword">if</span> (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</div><div class="line">        <span class="keyword">uint64_t</span> max_slide_pages;</div><div class="line">        </div><div class="line">        max_slide_pages = vm_map_get_max_aslr_slide_pages(<span class="built_in">map</span>);</div><div class="line">        </div><div class="line">        aslr_offset = random();</div><div class="line">        aslr_offset %= max_slide_pages;</div><div class="line">        aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line">        </div><div class="line">        dyld_aslr_offset = random();</div><div class="line">        dyld_aslr_offset %= max_slide_pages;</div><div class="line">        dyld_aslr_offset &lt;&lt;= vm_map_page_shift(<span class="built_in">map</span>);</div><div class="line">    &#125;</div><div class="line">    </div><div class="line">    <span class="comment">// 开始解析文件</span></div><div class="line">    <span class="comment">/*</span></div><div class="line">     lret = parse_machfile(vp, map, thread, header, file_offset, macho_size,</div><div class="line">                          0, (int64_t)aslr_offset, (int64_t)dyld_aslr_offset, result,</div><div class="line">                          NULL, imgp);</div><div class="line">     */</div><div class="line">    <span class="function"><span class="keyword">static</span></span></div><div class="line">    load_return_t</div><div class="line">    <span class="title">parse_machfile</span><span class="params">(</span></div><div class="line">                   <span class="keyword">struct</span> vnode         *vp,</div><div class="line">                   <span class="keyword">vm_map_t</span>     <span class="built_in">map</span>,</div><div class="line">                   <span class="keyword">thread_t</span>     thread,</div><div class="line">                   <span class="keyword">struct</span> mach_header   *header,</div><div class="line">                   <span class="keyword">off_t</span>            file_offset,</div><div class="line">                   <span class="keyword">off_t</span>            macho_size,</div><div class="line">                   <span class="keyword">int</span>          depth,</div><div class="line">                   <span class="keyword">int64_t</span>          aslr_offset,</div><div class="line">                   <span class="keyword">int64_t</span>          dyld_aslr_offset,</div><div class="line">                   <span class="keyword">load_result_t</span>        *result,</div><div class="line">                   <span class="keyword">load_result_t</span>        *binresult,</div><div class="line">                   <span class="keyword">struct</span> image_params  *imgp</div><div class="line">                   )</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// 可以通过对 header 的 MH_PIE 标志位进行修改绕过 aslr, 但是 dyld 没有办法绕过</span></div><div class="line">        <span class="comment">/*</span></div><div class="line">         *  For PIE and dyld, slide everything by the ASLR offset.</div><div class="line">         */</div><div class="line">        <span class="keyword">if</span> ((header-&gt;flags &amp; MH_PIE) || is_dyld) &#123;</div><div class="line">            slide = aslr_offset;</div><div class="line">        &#125;</div><div class="line">        </div><div class="line">        <span class="comment">/*</span></div><div class="line">         这里为什么分三次进行加载?</div><div class="line">         需要先初始化一些特殊的加载命令(LOAD_COMMAND), 比如 LC_MAIN, LC_UUID, LC_CODE_SIGNATURE</div><div class="line">         */</div><div class="line">        <span class="comment">/*</span></div><div class="line">         *  Scan through the commands, processing each one as necessary.</div><div class="line">         *  We parse in three passes through the headers:</div><div class="line">         *  0: determine if TEXT and DATA boundary can be page-aligned</div><div class="line">         *  1: thread state, uuid, code signature</div><div class="line">         *  2: segments</div><div class="line">         *  3: dyld, encryption, check entry point</div><div class="line">         */</div><div class="line">        <span class="keyword">boolean_t</span> slide_realign = FALSE;</div><div class="line">        <span class="keyword">for</span> (pass = <span class="number">0</span>; pass &lt;= <span class="number">3</span>; pass++) &#123;</div><div class="line">            </div><div class="line">            <span class="keyword">if</span> (pass == <span class="number">0</span> &amp;&amp; !slide_realign &amp;&amp; !is_dyld) &#123;</div><div class="line">                <span class="comment">/* if we dont need to realign the slide or determine dyld's load</span></div><div class="line">                 * address, pass 0 can be skipped */</div><div class="line">                <span class="keyword">continue</span>;</div><div class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (pass == <span class="number">1</span>) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 这一块是针对 dyld 处理, 对于 binresult 在加载二进制文件时该值为 NULL. 在加载 dyld 时, 默认是加载在二进制文件之后, 这有利于爆破 dyld 的地址.</div><div class="line">                */</div><div class="line">                <span class="keyword">if</span> (dyld_no_load_addr &amp;&amp; binresult) &#123;</div><div class="line">                    <span class="comment">// 这里我们在获取到二进制内存地址的所有的 segment 的最大虚拟地址</span></div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     * The dyld Mach-O does not specify a load address. Try to locate</div><div class="line">                     * it right after the main binary. If binresult == NULL, load</div><div class="line">                     * directly to the given slide.</div><div class="line">                     */</div><div class="line">                    slide = vm_map_round_page(slide + binresult-&gt;max_vm_addr, effective_page_mask);</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Check that the entry point is contained in an executable segments</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (!result-&gt;using_lcmain &amp;&amp; result-&gt;validentry == <span class="number">0</span>)) &#123;</div><div class="line">                thread_state_initialize(thread);</div><div class="line">                ret = LOAD_FAILURE;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Check that some segment maps the start of the mach-o file, which is</div><div class="line">             * needed by the dynamic loader to read the mach headers, etc.</div><div class="line">             */</div><div class="line">            <span class="keyword">if</span> ((pass == <span class="number">3</span>) &amp;&amp; (found_header_segment == FALSE)) &#123;</div><div class="line">                ret = LOAD_BADMACHO;</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            </div><div class="line">            <span class="comment">/*</span></div><div class="line">             * Loop through each of the load_commands indicated by the</div><div class="line">             * Mach-O header; if an absurd value is provided, we just</div><div class="line">             * run off the end of the reserved section by incrementing</div><div class="line">             * the offset too far, so we are implicitly fail-safe.</div><div class="line">             */</div><div class="line">            offset = mach_header_sz;</div><div class="line">            ncmds = header-&gt;ncmds;</div><div class="line">            </div><div class="line">            <span class="keyword">while</span> (ncmds--) &#123;</div><div class="line">                <span class="comment">/*</span></div><div class="line">                 *  Get a pointer to the command.</div><div class="line">                 */</div><div class="line">                lcp = (<span class="keyword">struct</span> load_command *)(addr + offset);</div><div class="line">                oldoffset = offset;</div><div class="line">                offset += lcp-&gt;cmdsize;</div><div class="line">                </div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Perform prevalidation of the struct load_command</div><div class="line">                 * before we attempt to use its contents.  Invalid</div><div class="line">                 * values are ones which result in an overflow, or</div><div class="line">                 * which can not possibly be valid commands, or which</div><div class="line">                 * straddle or exist past the reserved section at the</div><div class="line">                 * start of the image.</div><div class="line">                 */</div><div class="line">                <span class="keyword">if</span> (oldoffset &gt; offset ||</div><div class="line">                    lcp-&gt;cmdsize &lt; <span class="keyword">sizeof</span>(<span class="keyword">struct</span> load_command) ||</div><div class="line">                    offset &gt; header-&gt;sizeofcmds + mach_header_sz) &#123;</div><div class="line">                    ret = LOAD_BADMACHO;</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                </div><div class="line">                <span class="comment">/*</span></div><div class="line">                 * Act on struct load_command's for which kernel</div><div class="line">                 * intervention is required.</div><div class="line">                 */</div><div class="line">                <span class="keyword">switch</span>(lcp-&gt;cmd) &#123;</div><div class="line">                    <span class="comment">// -这里删除了 LC_SEGMENT 的 case</span></div><div class="line">                        </div><div class="line">                    <span class="keyword">case</span> LC_SEGMENT_64: &#123;</div><div class="line">                        <span class="keyword">struct</span> segment_command_64 *scp64 = (<span class="keyword">struct</span> segment_command_64 *) lcp;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (pass == <span class="number">0</span>) &#123;</div><div class="line">                            <span class="keyword">if</span> (is_dyld &amp;&amp; scp64-&gt;vmaddr == <span class="number">0</span> &amp;&amp; scp64-&gt;fileoff == <span class="number">0</span>) &#123;</div><div class="line">                                dyld_no_load_addr = TRUE;</div><div class="line">                                <span class="keyword">if</span> (!slide_realign) &#123;</div><div class="line">                                    <span class="comment">/* got what we need, bail early on pass 0 */</span></div><div class="line">                                    <span class="keyword">continue</span>;</div><div class="line">                                &#125;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; !<span class="built_in">strncmp</span>(scp64-&gt;segname, <span class="string">"__XHDR"</span>, <span class="keyword">sizeof</span>(scp64-&gt;segname))) &#123;</div><div class="line">                            found_xhdr = TRUE;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">2</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (!abi64) &#123;</div><div class="line">                            <span class="comment">/*</span></div><div class="line">                             * Having an LC_SEGMENT_64 command for the</div><div class="line">                             * wrong ABI is invalid &lt;rdar://problem/11021230&gt;</div><div class="line">                             */</div><div class="line">                            ret = LOAD_BADMACHO;</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        ret = load_segment(lcp,</div><div class="line">                                           header-&gt;filetype,</div><div class="line">                                           control,</div><div class="line">                                           file_offset,</div><div class="line">                                           macho_size,</div><div class="line">                                           vp,</div><div class="line">                                           <span class="built_in">map</span>,</div><div class="line">                                           slide,</div><div class="line">                                           result);</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (ret == LOAD_SUCCESS &amp;&amp; scp64-&gt;fileoff == <span class="number">0</span> &amp;&amp; scp64-&gt;filesize &gt; <span class="number">0</span>) &#123;</div><div class="line">                            <span class="comment">/* Enforce a single segment mapping offset zero, with R+X</span></div><div class="line">                             * protection. */</div><div class="line">                            <span class="keyword">if</span> (found_header_segment ||</div><div class="line">                                ((scp64-&gt;initprot &amp; (VM_PROT_READ|VM_PROT_EXECUTE)) != (VM_PROT_READ|VM_PROT_EXECUTE))) &#123;</div><div class="line">                                ret = LOAD_BADMACHO;</div><div class="line">                                <span class="keyword">break</span>;</div><div class="line">                            &#125;</div><div class="line">                            found_header_segment = TRUE;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    &#125;</div><div class="line">                    <span class="keyword">case</span> LC_UNIXTHREAD:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        ret = load_unixthread(</div><div class="line">                                              (<span class="keyword">struct</span> thread_command *) lcp,</div><div class="line">                                              thread,</div><div class="line">                                              slide,</div><div class="line">                                              result);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// -设置入口点</span></div><div class="line">                    <span class="keyword">case</span> LC_MAIN:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="keyword">if</span> (depth != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        ret = load_main(</div><div class="line">                                        (<span class="keyword">struct</span> entry_point_command *) lcp,</div><div class="line">                                        thread,</div><div class="line">                                        slide,</div><div class="line">                                        result);</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// 这个比较重要 表明需要加载 dyld, 但是是在三次解析加载完成后</span></div><div class="line">                    <span class="keyword">case</span> LC_LOAD_DYLINKER:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="keyword">if</span> ((depth == <span class="number">1</span>) &amp;&amp; (dlp == <span class="number">0</span>)) &#123;</div><div class="line">                            dlp = (<span class="keyword">struct</span> dylinker_command *)lcp;</div><div class="line">                            dlarchbits = (header-&gt;cputype &amp; CPU_ARCH_MASK);</div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            ret = LOAD_FAILURE;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// 没啥好说, 读取并保存 uuid</span></div><div class="line">                    <span class="keyword">case</span> LC_UUID:</div><div class="line">                        <span class="keyword">if</span> (pass == <span class="number">1</span> &amp;&amp; depth == <span class="number">1</span>) &#123;</div><div class="line">                            ret = load_uuid((<span class="keyword">struct</span> uuid_command *) lcp,</div><div class="line">                                            (<span class="keyword">char</span> *)addr + mach_header_sz + header-&gt;sizeofcmds,</div><div class="line">                                            result);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">// <span class="doctag">TODO:</span> 这里暂时没有情景没有分析</span></div><div class="line">                    <span class="keyword">case</span> LC_CODE_SIGNATURE:</div><div class="line">                        <span class="comment">/* CODE SIGNING */</span></div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">1</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="comment">/* pager -&gt; uip -&gt;</span></div><div class="line">                         load signatures &amp; store in uip</div><div class="line">                         set VM object "signed_pages"</div><div class="line">                         */</div><div class="line">                        ret = load_code_signature(</div><div class="line">                                                  (<span class="keyword">struct</span> linkedit_data_command *) lcp,</div><div class="line">                                                  vp,</div><div class="line">                                                  file_offset,</div><div class="line">                                                  macho_size,</div><div class="line">                                                  header-&gt;cputype,</div><div class="line">                                                  result,</div><div class="line">                                                  imgp);</div><div class="line">                        <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">                            <span class="built_in">printf</span>(<span class="string">"proc %d: load code signature error %d "</span></div><div class="line">                                   <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">                                   p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">                            <span class="comment">/*</span></div><div class="line">                             * Allow injections to be ignored on devices w/o enforcement enabled</div><div class="line">                             */</div><div class="line">                            <span class="keyword">if</span> (!cs_enforcement(<span class="literal">NULL</span>))</div><div class="line">                                ret = LOAD_SUCCESS; <span class="comment">/* ignore error */</span></div><div class="line">                            </div><div class="line">                        &#125; <span class="keyword">else</span> &#123;</div><div class="line">                            got_code_signatures = TRUE;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">if</span> (got_code_signatures) &#123;</div><div class="line">                            <span class="keyword">unsigned</span> tainted = CS_VALIDATE_TAINTED;</div><div class="line">                            <span class="keyword">boolean_t</span> valid = FALSE;</div><div class="line">                            <span class="keyword">vm_size_t</span> off = <span class="number">0</span>;</div><div class="line">                            </div><div class="line">                            </div><div class="line">                            <span class="keyword">if</span> (cs_debug &gt; <span class="number">10</span>)</div><div class="line">                                <span class="built_in">printf</span>(<span class="string">"validating initial pages of %s\n"</span>, vp-&gt;v_name);</div><div class="line">                            </div><div class="line">                            <span class="keyword">while</span> (off &lt; size &amp;&amp; ret == LOAD_SUCCESS) &#123;</div><div class="line">                                tainted = CS_VALIDATE_TAINTED;</div><div class="line">                                </div><div class="line">                                valid = cs_validate_range(vp,</div><div class="line">                                                          <span class="literal">NULL</span>,</div><div class="line">                                                          file_offset + off,</div><div class="line">                                                          addr + off,</div><div class="line">                                                          PAGE_SIZE,</div><div class="line">                                                          &amp;tainted);</div><div class="line">                                <span class="keyword">if</span> (!valid || (tainted &amp; CS_VALIDATE_TAINTED)) &#123;</div><div class="line">                                    <span class="keyword">if</span> (cs_debug)</div><div class="line">                                        <span class="built_in">printf</span>(<span class="string">"CODE SIGNING: %s[%d]: invalid initial page at offset %lld validated:%d tainted:%d csflags:0x%x\n"</span>, </div><div class="line">                                               vp-&gt;v_name, p-&gt;p_pid, (<span class="keyword">long</span> <span class="keyword">long</span>)(file_offset + off), valid, tainted, result-&gt;csflags);</div><div class="line">                                    <span class="keyword">if</span> (cs_enforcement(<span class="literal">NULL</span>) ||</div><div class="line">                                        (result-&gt;csflags &amp; (CS_HARD|CS_KILL|CS_ENFORCEMENT))) &#123;</div><div class="line">                                        ret = LOAD_FAILURE;</div><div class="line">                                    &#125;</div><div class="line">                                    result-&gt;csflags &amp;= ~CS_VALID;</div><div class="line">                                &#125;</div><div class="line">                                off += PAGE_SIZE;</div><div class="line">                            &#125;</div><div class="line">                        &#125;</div><div class="line">                        </div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                    <span class="comment">/*</span></div><div class="line">                     app store 上架的加密</div><div class="line">                     该LOAD_COMMAND 的解析是先于 SEGMENT_64 解析, 目前砸壳的思路, 是找到 runtime 的对应内存内容替换原来加密的文件内容</div><div class="line">                     */</div><div class="line"><span class="meta">#<span class="meta-keyword">if</span> CONFIG_CODE_DECRYPTION</span></div><div class="line">                    <span class="keyword">case</span> LC_ENCRYPTION_INFO:</div><div class="line">                    <span class="keyword">case</span> LC_ENCRYPTION_INFO_64:</div><div class="line">                        <span class="keyword">if</span> (pass != <span class="number">3</span>)</div><div class="line">                            <span class="keyword">break</span>;</div><div class="line">                        <span class="comment">/*</span></div><div class="line">                         ret = set_code_unprotect(</div><div class="line">                                                 (struct encryption_info_command *) lcp,</div><div class="line">                                                 addr, map, slide, vp, file_offset,</div><div class="line">                                                 header-&gt;cputype, header-&gt;cpusubtype);</div><div class="line">                         */</div><div class="line">                        <span class="function"><span class="keyword">static</span> load_return_t</span></div><div class="line">                        <span class="title">set_code_unprotect</span><span class="params">(</span></div><div class="line">                                           <span class="keyword">struct</span> encryption_info_command *eip,</div><div class="line">                                           <span class="keyword">caddr_t</span> addr,</div><div class="line">                                           <span class="keyword">vm_map_t</span> <span class="built_in">map</span>,</div><div class="line">                                           <span class="keyword">int64_t</span> slide,</div><div class="line">                                           <span class="keyword">struct</span> vnode *vp,</div><div class="line">                                           <span class="keyword">off_t</span> macho_offset,</div><div class="line">                                           <span class="keyword">cpu_type_t</span> cputype,</div><div class="line">                                           <span class="keyword">cpu_subtype_t</span> cpusubtype)</div><div class="line">                        &#123;</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">if</span> (ret != LOAD_SUCCESS) &#123;</div><div class="line">                            <span class="keyword">os_reason_t</span> load_failure_reason = OS_REASON_NULL;</div><div class="line">                            <span class="built_in">printf</span>(<span class="string">"proc %d: set_code_unprotect() error %d "</span></div><div class="line">                                   <span class="string">"for file \"%s\"\n"</span>,</div><div class="line">                                   p-&gt;p_pid, ret, vp-&gt;v_name);</div><div class="line">                            <span class="comment">/* </span></div><div class="line">                             * Don't let the app run if it's </div><div class="line">                             * encrypted but we failed to set up the</div><div class="line">                             * decrypter. If the keys are missing it will</div><div class="line">                             * return LOAD_DECRYPTFAIL.</div><div class="line">                             */</div><div class="line">                            <span class="keyword">if</span> (ret == LOAD_DECRYPTFAIL) &#123;</div><div class="line">                                <span class="comment">/* failed to load due to missing FP keys */</span></div><div class="line">                                proc_lock(p);</div><div class="line">                                p-&gt;p_lflag |= P_LTERM_DECRYPTFAIL;</div><div class="line">                                proc_unlock(p);</div><div class="line">                                </div><div class="line">                                KERNEL_DEBUG_CONSTANT(BSDDBG_CODE(DBG_BSD_PROC, BSD_PROC_EXITREASON_CREATE) | DBG_FUNC_NONE,</div><div class="line">                                                      p-&gt;p_pid, OS_REASON_EXEC, EXEC_EXIT_REASON_FAIRPLAY_DECRYPT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                                load_failure_reason = os_reason_create(OS_REASON_EXEC, EXEC_EXIT_REASON_FAIRPLAY_DECRYPT);</div><div class="line">                            &#125; <span class="keyword">else</span> &#123;</div><div class="line">                                </div><div class="line">                                KERNEL_DEBUG_CONSTANT(BSDDBG_CODE(DBG_BSD_PROC, BSD_PROC_EXITREASON_CREATE) | DBG_FUNC_NONE,</div><div class="line">                                                      p-&gt;p_pid, OS_REASON_EXEC, EXEC_EXIT_REASON_DECRYPT, <span class="number">0</span>, <span class="number">0</span>);</div><div class="line">                                load_failure_reason = os_reason_create(OS_REASON_EXEC, EXEC_EXIT_REASON_DECRYPT);</div><div class="line">                            &#125;</div><div class="line">                            </div><div class="line">                            assert(load_failure_reason != OS_REASON_NULL);</div><div class="line">                            psignal_with_reason(p, SIGKILL, load_failure_reason);</div><div class="line">                        &#125;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line"><span class="meta">#<span class="meta-keyword">endif</span></span></div><div class="line">                    <span class="keyword">default</span>:</div><div class="line">                        <span class="comment">/* Other commands are ignored by the kernel */</span></div><div class="line">                        ret = LOAD_SUCCESS;</div><div class="line">                        <span class="keyword">break</span>;</div><div class="line">                &#125;</div><div class="line">                <span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">                    <span class="keyword">break</span>;</div><div class="line">            &#125;</div><div class="line">            <span class="keyword">if</span> (ret != LOAD_SUCCESS)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div></pre></td><td class="code"><pre><div class="line">// 附2: 这里 ip_flags 默认的标记为 IMGPF_NONE, 所以之后会生成 aslr, 可以重新编译内核绕过</div><div class="line">// kern/kern_exec.c</div><div class="line">int</div><div class="line">__mac_execve(proc_t p, struct __mac_execve_args *uap, int32_t *retval)</div><div class="line">&#123;</div><div class="line">    imgp-&gt;ip_flags = (is_64 ? IMGPF_WAS_64BIT : IMGPF_NONE) | ((p-&gt;p_flag &amp; P_DISABLE_ASLR) ? IMGPF_DISABLE_ASLR : IMGPF_NONE);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// sys/imgact.h</div><div class="line">/*</div><div class="line"> * Image flags</div><div class="line"> */</div><div class="line">#define IMGPF_NONE      0x00000000  /* No flags */</div><div class="line">#define IMGPF_INTERPRET     0x00000001  /* Interpreter invoked */</div><div class="line">#define IMGPF_RESERVED      0x00000002</div><div class="line">#define IMGPF_WAS_64BIT     0x00000004  /* exec from a 64Bit binary */</div><div class="line">#define IMGPF_IS_64BIT      0x00000008  /* exec to a 64Bit binary */</div><div class="line">#define IMGPF_SPAWN     0x00000010  /* spawn (without setexec) */</div><div class="line">#define IMGPF_DISABLE_ASLR  0x00000020  /* disable ASLR */</div><div class="line">#define IMGPF_ALLOW_DATA_EXEC   0x00000040  /* forcibly disallow data execution */</div><div class="line">#define IMGPF_VFORK_EXEC    0x00000080  /* vfork followed by exec */</div><div class="line">#define IMGPF_EXEC      0x00000100  /* exec */</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div></pre></td><td class="code"><pre><div class="line">// 附3:</div><div class="line">// 为什么需要知道 aslr_offset 的范围, 这样就可以爆破 dyld 地址, 从而拿到 dyld_all_image_infos 结构体, 其实我们还可以通过 task_info+TASK_DYLD_INFO 获取到 dyld 地址.</div><div class="line"></div><div class="line">// 下面已经贴出了相关参考, 都可以找到.</div><div class="line"></div><div class="line">// bsd/kern/mach_loader.c</div><div class="line">load_return_t</div><div class="line">load_machfile(</div><div class="line">              struct image_params   *imgp,</div><div class="line">              struct mach_header    *header,</div><div class="line">              thread_t      thread,</div><div class="line">              vm_map_t      *mapp,</div><div class="line">              load_result_t     *result</div><div class="line">              )</div><div class="line">&#123;</div><div class="line">    map = vm_map_create(pmap,</div><div class="line">                        0,</div><div class="line">                        vm_compute_max_offset(result-&gt;is64bit),</div><div class="line">                        TRUE);</div><div class="line">    if (!(imgp-&gt;ip_flags &amp; IMGPF_DISABLE_ASLR)) &#123;</div><div class="line">        uint64_t max_slide_pages;</div><div class="line">        </div><div class="line">        max_slide_pages = vm_map_get_max_aslr_slide_pages(map);</div><div class="line">        /*</div><div class="line">         最大的 aslr_offset 的计算</div><div class="line">         aslr_offset = 1 &lt;&lt; 16</div><div class="line">         aslr_offset &lt;&lt;= 12</div><div class="line">         所以最大的 aslr_offset = 0x10000000</div><div class="line">         同样对于最小的 aslr_offset = 0x1000</div><div class="line">         */</div><div class="line">        aslr_offset = random();</div><div class="line">        aslr_offset %= max_slide_pages;</div><div class="line">        aslr_offset &lt;&lt;= vm_map_page_shift(map);</div><div class="line">        </div><div class="line">        dyld_aslr_offset = random();</div><div class="line">        dyld_aslr_offset %= max_slide_pages;</div><div class="line">        dyld_aslr_offset &lt;&lt;= vm_map_page_shift(map);</div><div class="line">    &#125;</div><div class="line">&#125;</div><div class="line"></div><div class="line">// osfmk/vm/vm_map.c</div><div class="line">vm_map_t</div><div class="line">vm_map_create(</div><div class="line">              pmap_t            pmap,</div><div class="line">              vm_map_offset_t   min,</div><div class="line">              vm_map_offset_t   max,</div><div class="line">              boolean_t     pageable)</div><div class="line">&#123;</div><div class="line">    result-&gt;hdr.page_shift = PAGE_SHIFT;</div><div class="line">&#125;</div><div class="line"></div><div class="line">vm_map_offset_t</div><div class="line">vm_compute_max_offset(boolean_t is64)</div><div class="line">&#123;</div><div class="line">    return (is64 ? (vm_map_offset_t)MACH_VM_MAX_ADDRESS : (vm_map_offset_t)VM_MAX_ADDRESS);</div><div class="line">&#125;</div><div class="line"></div><div class="line">uint64_t</div><div class="line">vm_map_get_max_aslr_slide_pages(vm_map_t map)</div><div class="line">&#123;</div><div class="line">    return (1 &lt;&lt; (vm_map_is_64bit(map) ? 16 : 8));</div><div class="line">&#125;</div><div class="line"></div><div class="line">boolean_t</div><div class="line">vm_map_is_64bit(</div><div class="line">                vm_map_t map)</div><div class="line">&#123;</div><div class="line">    return map-&gt;max_offset &gt; ((vm_map_offset_t)VM_MAX_ADDRESS);</div><div class="line">&#125;</div><div class="line"></div><div class="line">int</div><div class="line">vm_map_page_shift(</div><div class="line">                  vm_map_t map)</div><div class="line">&#123;</div><div class="line">    return VM_MAP_PAGE_SHIFT(map);</div><div class="line">&#125;</div><div class="line"></div><div class="line">// osfmk/vm/vm_map.h</div><div class="line">#define VM_MAP_PAGE_SHIFT(map) ((map) ? (map)-&gt;hdr.page_shift : PAGE_SHIFT)</div><div class="line"></div><div class="line">// osfmk/mach/i386/vm_param.h</div><div class="line">#define I386_PGBYTES        4096        /* bytes per 80386 page */</div><div class="line">#define I386_PGSHIFT        12      /* bitshift for pages */</div><div class="line"></div><div class="line">#define PAGE_SIZE       I386_PGBYTES</div><div class="line">#define PAGE_SHIFT      I386_PGSHIFT</div></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-04-20</span><i class="fa fa-tag"></i><a href="/categories/darwin/" title="darwin" class="tag">darwin </a><a href="/tags/darwin/" title="darwin" class="tag">darwin </a><a href="/tags/交叉编译/" title="交叉编译" class="tag">交叉编译 </a><a href="/tags/darwin逆向/" title="darwin逆向" class="tag">darwin逆向 </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://jmpews.github.com/2017/04/20/darwin/macho完整加载过程/,jmpews,macho完整加载过程(未完...),;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/04/17/darwin/ojbc学习笔记/" title="objc学习笔记" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/04/23/darwin/IOS的反调试与绕过/" title="IOS的反调试与绕过" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>