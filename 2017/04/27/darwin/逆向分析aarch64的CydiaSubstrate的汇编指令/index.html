<!DOCTYPE html>
<html lang="en">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            逆向分析aarch64的CydiaSubstrate的汇编指令 | 
        
        Zz
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="jmpews">
    <meta name="description" content="pwn &amp; dev &amp; reverse">
    <meta name="keywords" content="null,darwin,macho">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Zz">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://jmpews.github.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="逆向分析aarch64的CydiaSubstrate的汇编指令 | Zz">
    <meta property="og:description" content="pwn &amp; dev &amp; reverse">
    <meta property="og:article:tag" content="darwin"> <meta property="og:article:tag" content="macho"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #607D8B !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #607D8B !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #607D8B !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#逆向分析-aarch64-的-CydiaSubstrate-的汇编指令"><span class="post-toc-number">1.</span> <span class="post-toc-text">逆向分析 aarch64 的 CydiaSubstrate 的汇编指令</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">2.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#分析-CydiaSubstrate"><span class="post-toc-number">3.</span> <span class="post-toc-text">分析 CydiaSubstrate</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#如何调用新函数"><span class="post-toc-number">3.0.1.</span> <span class="post-toc-text">如何调用新函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#如何返回旧函数"><span class="post-toc-number">3.0.2.</span> <span class="post-toc-text">如何返回旧函数</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#指令修复"><span class="post-toc-number">3.0.3.</span> <span class="post-toc-text">指令修复</span></a></li></ol></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                逆向分析aarch64的CydiaSubstrate的汇编指令
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpeg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>jmpews</strong>
        <span>Apr 27, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/darwin/">darwin</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/macho/">macho</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=逆向分析aarch64的CydiaSubstrate的汇编指令&url=http://jmpews.github.com//2017/04/27/darwin/逆向分析aarch64的CydiaSubstrate的汇编指令/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                Share to Weibo
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=逆向分析aarch64的CydiaSubstrate的汇编指令&url=http://jmpews.github.com//2017/04/27/darwin/逆向分析aarch64的CydiaSubstrate的汇编指令/index.html&via=jmpews" target="_blank">
            <li class="mdl-menu__item">
                Share to Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://jmpews.github.com//2017/04/27/darwin/逆向分析aarch64的CydiaSubstrate的汇编指令/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://jmpews.github.com//2017/04/27/darwin/逆向分析aarch64的CydiaSubstrate的汇编指令/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h2 id="逆向分析-aarch64-的-CydiaSubstrate-的汇编指令"><a href="#逆向分析-aarch64-的-CydiaSubstrate-的汇编指令" class="headerlink" title="逆向分析 aarch64 的 CydiaSubstrate 的汇编指令"></a>逆向分析 aarch64 的 CydiaSubstrate 的汇编指令</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>网上对于 aarch64 的指令资料不是很多, 并且大部分的 inlinehook 都是实现在 arm 32 下, 对于 32 位的 arm 指令, 可以访问 pc 寄存器, 可以通过 <code>ldr pc, [pc, #-4]</code> 实现跳转. </p>
<p>参考资料:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">http://blog.csdn.net/forever_2015/article/details/50285865</div><div class="line">http://infocenter.arm.com/help/index.jsp?topic=/com.arm.doc.faqs/ka16240.html</div><div class="line"></div><div class="line">https://www.arm.com/zh/products/processors/armv8-architecture.php</div><div class="line"></div><div class="line">https://www.element14.com/community/servlet/JiveServlet/previewBody/41836-102-1-229511/ARM.Reference_Manual.pdf</div><div class="line"></div><div class="line">&lt;ARM Architecture Reference Manual-ARMv8, for ARMv8-A architecture profile&gt;</div></pre></td></tr></table></figure>
<p>关于 <code>ldr</code> 指令可以参考 <code>&lt;ARM Architecture Reference Manual-ARMv8, for ARMv8-A architecture profile&gt;</code>. 这里介绍下如何解释的 <code>ldr</code> 对应的机器码. 具体参考 <code>C6.2.102 LDR (literal)</code> 一小节, 位于 <code>P673</code>.</p>
<p><img src="/images/LDR-literal.png" alt=""></p>
<p>对于 aarch64, <code>opc == 01</code>, 这里关键在于 <code>offset</code> 的计算, 其实很简单, 对 <code>imm19:&#39;00&#39;</code> 操作, 相当于左移 2 位, 后进行 64 补齐. 同时也可以看到下面的 data 的计算是取当前 <code>PC + offset</code> 的内容.</p>
<h2 id="分析-CydiaSubstrate"><a href="#分析-CydiaSubstrate" class="headerlink" title="分析 CydiaSubstrate"></a>分析 CydiaSubstrate</h2><p>所以通过 aarch64 , 可以用 ldr + br 进行跳转, ldr 的寄存器应该选哪个?</p>
<p>这里以一段很简单的 tweak 代码为例子.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div></pre></td><td class="code"><pre><div class="line">#import &lt;substrate.h&gt;</div><div class="line">FILE *(*old_fopen)(const char *path, const char *mode);</div><div class="line">FILE *my_fopen(const char *path, const char *mode)</div><div class="line">&#123;</div><div class="line">    return old_fopen(path, mode);</div><div class="line">&#125;</div><div class="line"></div><div class="line">%ctor</div><div class="line">&#123;</div><div class="line">    NSLog(@&quot;hello world===================================&quot;);</div><div class="line">    MSHookFunction((void *)fopen, (void *)my_fopen, (void **)&amp;old_fopen);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="如何调用新函数"><a href="#如何调用新函数" class="headerlink" title="如何调用新函数"></a>如何调用新函数</h4><p>可以看到 <code>fopen</code> 前几条指令改为, 以实现跳转至 <code>my_fopen</code>.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">0x18354ea60 &lt;+0&gt;:  0x58000050   ldr    x16, #0x8                 ; &lt;+8&gt;</div><div class="line">0x18354ea64 &lt;+4&gt;:  0xd61f0200   br     x16</div></pre></td></tr></table></figure>
<p>完整调试说明如下:</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div></pre></td><td class="code"><pre><div class="line">(lldb) disassemble -n my_fopen -c 10 -b</div><div class="line">TestApp002.dylib`my_fopen:</div><div class="line">    0x104417ebc &lt;+0&gt;:  0xd10083ff   sub    sp, sp, #0x20             ; =0x20</div><div class="line">    0x104417ec0 &lt;+4&gt;:  0xa9017bfd   stp    x29, x30, [sp, #0x10]</div><div class="line">    0x104417ec4 &lt;+8&gt;:  0x910043fd   add    x29, sp, #0x10            ; =0x10</div><div class="line">    0x104417ec8 &lt;+12&gt;: 0xb0000008   adrp   x8, 1</div><div class="line">    0x104417ecc &lt;+16&gt;: 0x91016108   add    x8, x8, #0x58             ; =0x58</div><div class="line">    0x104417ed0 &lt;+20&gt;: 0xf90007e0   str    x0, [sp, #0x8]</div><div class="line">    0x104417ed4 &lt;+24&gt;: 0xf90003e1   str    x1, [sp]</div><div class="line">    0x104417ed8 &lt;+28&gt;: 0xf9400108   ldr    x8, [x8]</div><div class="line">    0x104417edc &lt;+32&gt;: 0xf94007e0   ldr    x0, [sp, #0x8]</div><div class="line">    0x104417ee0 &lt;+36&gt;: 0xf94003e1   ldr    x1, [sp]</div><div class="line"></div><div class="line">(lldb) disassemble -n fopen -c 10 -b</div><div class="line">libsystem_c.dylib`fopen:</div><div class="line">    ---------------------------------------------------------------------------</div><div class="line">    0x18354ea60 &lt;+0&gt;:  0x58000050   ldr    x16, #0x8                 ; &lt;+8&gt;</div><div class="line">    0x18354ea64 &lt;+4&gt;:  0xd61f0200   br     x16</div><div class="line">    ---------------------------------------------------------------------------</div><div class="line">    0x18354ea68 &lt;+8&gt;:  0x04417ebc   .long  0x04417ebc                ; unknown opcode</div><div class="line">    0x18354ea6c &lt;+12&gt;: 0x00000001   .long  0x00000001                ; unknown opcode</div><div class="line">    ---------------------------------------------------------------------------</div><div class="line">    0x18354ea70 &lt;+16&gt;: 0xd10043ff   sub    sp, sp, #0x10             ; =0x10</div><div class="line">    0x18354ea74 &lt;+20&gt;: 0xaa0103e8   mov    x8, x1</div><div class="line">    0x18354ea78 &lt;+24&gt;: 0xaa0003f5   mov    x21, x0</div><div class="line">    0x18354ea7c &lt;+28&gt;: 0x910033e1   add    x1, sp, #0xc              ; =0xc</div><div class="line">    0x18354ea80 &lt;+32&gt;: 0xaa0803e0   mov    x0, x8</div><div class="line">    0x18354ea84 &lt;+36&gt;: 0x9401b788   bl     0x1835bc8a4               ; symbol stub for: getdate</div><div class="line"></div><div class="line">(lldb) x/xg 0x18354ea68</div><div class="line">0x18354ea68: 0x0000000104417ebc</div></pre></td></tr></table></figure>
<h4 id="如何返回旧函数"><a href="#如何返回旧函数" class="headerlink" title="如何返回旧函数"></a>如何返回旧函数</h4><p>先执行之前备份的指令, 之后跳转到原 <code>open</code> 的后续代码.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div></pre></td><td class="code"><pre><div class="line">(lldb) p old_fopen</div><div class="line">(FILE *(*)(const char *, const char *)) $0 = 0x0000000104490000</div><div class="line">(lldb) disassemble -s 0x0000000104490000 -c 10 -b</div><div class="line">    0x104490000: 0xa9bd57f6   stp    x22, x21, [sp, #-0x30]!</div><div class="line">    0x104490004: 0xa9014ff4   stp    x20, x19, [sp, #0x10]</div><div class="line">    0x104490008: 0xa9027bfd   stp    x29, x30, [sp, #0x20]</div><div class="line">    0x10449000c: 0x910083fd   add    x29, sp, #0x20            ; =0x20</div><div class="line">    ---------------------------------------------------------------------------</div><div class="line">    0x104490010: 0x58000050   ldr    x16, #0x8</div><div class="line">    0x104490014: 0xd61f0200   br     x16</div><div class="line">    ---------------------------------------------------------------------------</div><div class="line">    0x104490018: 0x8354ea70   .long  0x8354ea70                ; unknown opcode</div><div class="line">    0x10449001c: 0x00000001   .long  0x00000001                ; unknown opcode</div><div class="line">    ---------------------------------------------------------------------------</div><div class="line">    0x104490020: 0x00000000   .long  0x00000000                ; unknown opcode</div><div class="line">    0x104490024: 0x00000000   .long  0x00000000                ; unknown opcode</div><div class="line">(lldb) x/xg 0x104490018</div><div class="line">0x104490018: 0x000000018354ea70</div></pre></td></tr></table></figure>
<h4 id="指令修复"><a href="#指令修复" class="headerlink" title="指令修复"></a>指令修复</h4><p>这里提一下, 假如刚才备份的指令涉及到与 pc 寄存器相关的指令, 由于存放备份指令的地址发生修改, 需要对其进行修复. </p>
<p>需要找一个可以统一的修复机制, 首先想到的解决方案就是修改指令的偏移为新的偏移.</p>
<p>举个例子, 对于地址 addressA 存在 <code>b.le #8</code> 指令, 现在将指令备份到地址 addressB, 按理说应该修改指令为 <code>b.le #8+(addressB-addressA)</code>, 但是假如 (addressB-addressA) 超过偏移可以表示的范围, 这样的方法就不可以. 所以必须保证 <code>b.le #offset</code> 其中的偏移在可以表示的范围内.</p>
<p>所以有这样一个解决方案, <code>b.le</code> 先跳转到一个近的地址, 之后该地址利用</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">ldr    x16, #0x8</div><div class="line">br     x16</div><div class="line">target_address</div><div class="line">target_address</div></pre></td></tr></table></figure>
<p>实现任意地址跳转. </p>
<p>但是这里涉及很多细节的地方</p>
<ol>
<li>解析指令, 获得偏移</li>
<li>重新设置偏移组成新的指令</li>
<li>利用任意地址跳转进行正确跳转</li>
</ol>
<p>这里以一个 hook 住函数 objc_msgSend 举例子.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div></pre></td><td class="code"><pre><div class="line">// 原指令</div><div class="line">(lldb) disassemble -n objc_msgSend -c 5 -b</div><div class="line">libobjc.A.dylib`objc_msgSend:</div><div class="line">    0x18047db80 &lt;+0&gt;:  0xf100001f   cmp    x0, #0x0                  ; =0x0</div><div class="line">    0x18047db84 &lt;+4&gt;:  0x5400034d   b.le   0x18047dbec               ; &lt;+108&gt;</div><div class="line">    0x18047db88 &lt;+8&gt;:  0xf940000d   ldr    x13, [x0]</div><div class="line">    0x18047db8c &lt;+12&gt;: 0x927d75a9   and    x9, x13, #0x1fffffff8</div><div class="line">    0x18047db90 &lt;+16&gt;: 0xa9412d2a   ldp    x10, x11, [x9, #0x10]</div><div class="line">// 修改后的原指令</div><div class="line">(lldb) disassemble -n objc_msgSend -c 5 -b</div><div class="line">libobjc.A.dylib`objc_msgSend:</div><div class="line">    0x18047db80 &lt;+0&gt;:  0x58000050   ldr    x16, #0x8                 ; &lt;+8&gt;</div><div class="line">    0x18047db84 &lt;+4&gt;:  0xd61f0200   br     x16</div><div class="line">    0x18047db88 &lt;+8&gt;:  0x00524000   .long  0x00524000                ; unknown opcode</div><div class="line">    0x18047db8c &lt;+12&gt;: 0x00000001   .long  0x00000001                ; unknown opcode</div><div class="line">    0x18047db90 &lt;+16&gt;: 0xa9412d2a   ldp    x10, x11, [x9, #0x10]</div><div class="line">// 跳转至 stub 桩</div><div class="line">(lldb) x/xg 0x18047db88</div><div class="line">0x18047db88: 0x0000000100524000</div><div class="line">// 由 stub 桩跳转至 fake_objc_msgSend_safe</div><div class="line">(lldb) disassemble -s 0x0000000100524000 -c 16 -b</div><div class="line">    0x100524000: 0xd503201f   nop</div><div class="line">    0x100524004: 0xd503201f   nop</div><div class="line">    0x100524008: 0xd503201f   nop</div><div class="line">    0x10052400c: 0xd503201f   nop</div><div class="line">    0x100524010: 0xd503201f   nop</div><div class="line">    0x100524014: 0x58000050   ldr    x16, #0x8</div><div class="line">    0x100524018: 0xd61f0200   br     x16</div><div class="line">    0x10052401c: 0x08466520   .long  0x08466520                ; unknown opcode</div><div class="line">    0x100524020: 0x00000001   .long  0x00000001                ; unknown opcode</div><div class="line">    0x100524024: 0x58000050   ldr    x16, #0x8</div><div class="line">    0x100524028: 0xd61f0200   br     x16</div><div class="line">    0x10052402c: 0x00000000   .long  0x00000000                ; unknown opcode</div><div class="line">    0x100524030: 0x00000000   .long  0x00000000                ; unknown opcode</div><div class="line">    0x100524034: 0x58000050   ldr    x16, #0x8</div><div class="line">    0x100524038: 0xd61f0200   br     x16</div><div class="line">    0x10052403c: 0x00000000   .long  0x00000000                ; unknown opcode</div><div class="line">// fake_objc_msgSend_safe 的地址</div><div class="line">(lldb) x/xg 0x10052401c</div><div class="line">0x10052401c: 0x0000000108466520</div><div class="line">// fake_objc_msgSend_safe 的实现</div><div class="line">(lldb) disassemble -n fake_objc_msgSend_safe -c 5 -b</div><div class="line">libobjcmsgsend.dylib`fake_objc_msgSend_safe:</div><div class="line">    0x108466520 &lt;+0&gt;:  0xa9bf7bfd   stp    x29, x30, [sp, #-0x10]!</div><div class="line">    0x108466524 &lt;+4&gt;:  0x910003fd   mov    x29, sp</div><div class="line">    0x108466528 &lt;+8&gt;:  0xd10383ff   sub    sp, sp, #0xe0             ; =0xe0</div><div class="line">    0x10846652c &lt;+12&gt;: 0xa9007bfd   stp    x29, x30, [sp]</div><div class="line">    0x108466530 &lt;+16&gt;: 0xa90107e0   stp    x0, x1, [sp, #0x10]</div><div class="line">// 原指令的备份, 以及指令修复, 用于跳转至原函数.</div><div class="line">(lldb) disassemble -s orig_objc_msgSend -c 16 -b</div><div class="line">    0x1006e8000: 0xf100001f   cmp    x0, #0x0                  ; =0x0</div><div class="line">    // 这里指令做了修改, 跳转至 0x1006e8024, 之后由 0x1006e8024 替代 b.le 做跳转工作</div><div class="line">    0x1006e8004: 0x5400010d   b.le   0x1006e8024</div><div class="line">    0x1006e8008: 0xf940000d   ldr    x13, [x0]</div><div class="line">    0x1006e800c: 0x927d75a9   and    x9, x13, #0x1fffffff8</div><div class="line">    0x1006e8010: 0xd503201f   nop</div><div class="line">    0x1006e8014: 0x58000050   ldr    x16, #0x8</div><div class="line">    0x1006e8018: 0xd61f0200   br     x16</div><div class="line">    // 由这里跳转至原函数的剩余指令</div><div class="line">    0x1006e801c: 0x8047db90   .long  0x8047db90                ; unknown opcode</div><div class="line">    0x1006e8020: 0x00000001   .long  0x00000001                ; unknown opcode</div><div class="line">    0x1006e8024: 0x58000050   ldr    x16, #0x8</div><div class="line">    0x1006e8028: 0xd61f0200   br     x16</div><div class="line">    // 修复指令的跳转地址</div><div class="line">    0x1006e802c: 0x8047dbec   .long  0x8047dbec                ; unknown opcode</div><div class="line">    0x1006e8030: 0x00000001   .long  0x00000001                ; unknown opcode</div><div class="line">// objc_msgSend 的剩余指令的地址</div><div class="line">(lldb) x/xg 0x1006e801c</div><div class="line">0x1006e801c: 0x000000018047db90</div><div class="line">(lldb) image lookup -a 0x000000018047db90</div><div class="line">      Address: libobjc.A.dylib[0x00000001800b9b90] (libobjc.A.dylib.__TEXT.__text + 88976)</div><div class="line">      Summary: libobjc.A.dylib`objc_msgSend + 16</div></pre></td></tr></table></figure>

    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/04/23/darwin/ios的反调试与绕过/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/05/01/darwin/如何正确的hook方法objc_msgSend/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpeg" alt="jmpews's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        jmpews@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: jmpews@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                Home
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    Archives
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">February 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">January 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">December 2016<span class="sidebar_archives-count">42</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                Categories
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/backend/">backend<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/darwin/">darwin<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/categories/dev/">dev<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/notes/">notes<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/pwn/">pwn<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/python/">python<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/categories/test/">test<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                Tags
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                Number of articles
                <span class="sidebar-badge">71</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/jmpews" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/winter1ife" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-weibo.svg);">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/jmpews" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.svg);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Zz
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
