<!DOCTYPE html>
<html lang="en">
    <head>
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.3.4 -->

    <!-- Title -->
    
    <title>
        
            如何正确的hook方法objc_msgSend | 
        
        Zz
    </title>

    <!-- Meta & Info -->
    <meta charset="utf-8">

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    

    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="jmpews">
    <meta name="description" content="pwn &amp; dev &amp; reverse">
    <meta name="keywords" content="null,darwin,macho">

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Zz">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://jmpews.github.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="如何正确的hook方法objc_msgSend | Zz">
    <meta property="og:description" content="pwn &amp; dev &amp; reverse">
    <meta property="og:article:tag" content="darwin"> <meta property="og:article:tag" content="macho"> 

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import CSS & jQuery -->
    
        <link rel="stylesheet" href="/css/material.min.css">
        <link rel="stylesheet" href="/css/style.min.css">
        <!-- Config CSS -->


<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #607D8B !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #607D8B !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #607D8B !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->


        <script src="/js/jquery.min.js"></script>
        <script src="/js/queue.js"></script>
    

    <!-- UC Browser Compatible -->
    <script>
        var agent = navigator.userAgent.toLowerCase();
        if(agent.indexOf('ucbrowser')>0) {
            document.write("<link rel=\"stylesheet\" href=\"/css/uc.css\">");
            alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
        }
    </script>

    

    


    <!-- Bing Background -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如何正确的hook方法objc-msgSend"><span class="post-toc-number">1.</span> <span class="post-toc-text">如何正确的hook方法objc_msgSend</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">2.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Hook-思路"><span class="post-toc-number">3.</span> <span class="post-toc-text">Hook 思路</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#构建-fake-objc-msgSend"><span class="post-toc-number">4.</span> <span class="post-toc-text">构建 fake_objc_msgSend</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#构建-hookBefore"><span class="post-toc-number">4.0.1.</span> <span class="post-toc-text">构建 hookBefore</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#构建-hookAfter"><span class="post-toc-number">4.0.2.</span> <span class="post-toc-text">构建 hookAfter</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#hookBefore-与-hookAfter-的数据传递"><span class="post-toc-number">4.0.3.</span> <span class="post-toc-text">hookBefore 与 hookAfter 的数据传递.</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如何正确过滤-objc-msgSend"><span class="post-toc-number">5.</span> <span class="post-toc-text">如何正确过滤 objc_msgSend</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#过滤函数地址"><span class="post-toc-number">5.0.1.</span> <span class="post-toc-text">过滤函数地址</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#限制函数调用栈深度"><span class="post-toc-number">5.0.2.</span> <span class="post-toc-text">限制函数调用栈深度</span></a></li></ol></li></ol></li></ol>

        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>




<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script>
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                如何正确的hook方法objc_msgSend
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.jpeg" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>jmpews</strong>
        <span>May 01, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/darwin/">darwin</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/macho/">macho</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=如何正确的hook方法objc_msgSend&url=http://jmpews.github.com//2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                Share to Weibo
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=如何正确的hook方法objc_msgSend&url=http://jmpews.github.com//2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html&via=jmpews" target="_blank">
            <li class="mdl-menu__item">
                Share to Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://jmpews.github.com//2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://jmpews.github.com//2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h2 id="如何正确的hook方法objc-msgSend"><a href="#如何正确的hook方法objc-msgSend" class="headerlink" title="如何正确的hook方法objc_msgSend"></a>如何正确的hook方法objc_msgSend</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果希望对 Objective-C 的方法调用进行 log, 一个很好的解决方法就是 hook 方法 <code>objc_msgSend</code>, 当然想到的就是利用 InlinkHook 直接 hook 完事, 然而 <code>objc_msgSend</code> 是一个可变参数函数, 这就有点蛋疼了.</p>
<p>以下 ojbc 对应版本 <code>objc4-680</code>, 和目前的 <code>objc4-709</code> 木有很大出入. </p>
<p>整个代码使用 c++, 所以有些地方需要参考 objc 的源码去造一个轮子, 比如 <code>object_getClass</code> 等.</p>
<p>这篇文章假设读者对以下有了解.</p>
<ol>
<li>OC类的内存布局模型</li>
<li>OC实例的内存布局模型</li>
<li>OC函数调用与消息传递机制</li>
<li>macho文件格式</li>
<li>基本aarch64汇编指令</li>
<li>函数调用与参数传递的 aarch64 汇编实现机制</li>
<li>inlinehook机制</li>
</ol>
<h2 id="Hook-思路"><a href="#Hook-思路" class="headerlink" title="Hook 思路"></a>Hook 思路</h2><p>这里首先明确, objc_msgSend 的第三个参数是不定参数, ,无法确定 <code>objc_msgSend</code> 的具体函数签名, 也就无法通过传参来调用原函数, 所以只能上暴力的方法, 通过保存/恢复栈和寄存器方法调用原函数, 之后在 arm 指令中实现原函数的跳转调用.</p>
<p> <code>objc_msgSend</code> 的函数声明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// runtime/message.h</div><div class="line">OBJC_EXPORT id objc_msgSend(id self, SEL op, ...)</div></pre></td></tr></table></figure>
<p><code>objc_msgSend</code> 的函数实现, 这里以 arm64 举例, <code>_objc_msgSend</code> 首先会取得基本的参数, 比如 isa, class, 之后会使用宏 <code>CacheLookup</code> 先进行缓存查找, 如果没有命中, 会触发 <code>JumpMiss</code> 宏处理, 跳转到 <code>__objc_msgSend_uncached_impcache</code>, 这个方法是了解如何正确 hook 的关键.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">// objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">.macro JumpMiss</div><div class="line">.if $0 == NORMAL</div><div class="line">	b	__objc_msgSend_uncached_impcache</div><div class="line">.else</div><div class="line">	b	LGetImpMiss</div><div class="line">.endif</div><div class="line">.endmacro</div><div class="line"></div><div class="line">.macro CacheLookup</div><div class="line">	// x1 = SEL, x9 = isa</div><div class="line">	ldp	x10, x11, [x9, #CACHE]	// x10 = buckets, x11 = occupied|mask</div><div class="line">	and	w12, w1, w11		// x12 = _cmd &amp; mask</div><div class="line">	add	x12, x10, x12, LSL #4	// x12 = buckets + ((_cmd &amp; mask)&lt;&lt;4)</div><div class="line"></div><div class="line">	ldp	x16, x17, [x12]		// &#123;x16, x17&#125; = *bucket</div><div class="line">1:	cmp	x16, x1			// if (bucket-&gt;sel != _cmd)</div><div class="line">	b.ne	2f			//     scan more</div><div class="line">	CacheHit $0			// call or return imp</div><div class="line">	</div><div class="line">2:	// not hit: x12 = not-hit bucket</div><div class="line">	CheckMiss $0			// miss if bucket-&gt;cls == 0</div><div class="line">	cmp	x12, x10		// wrap if bucket == buckets</div><div class="line">	b.eq	3f</div><div class="line">	ldp	x16, x17, [x12, #-16]!	// &#123;x16, x17&#125; = *--bucket</div><div class="line">	b	1b			// loop</div><div class="line"></div><div class="line">3:	// wrap: x12 = first bucket, w11 = mask</div><div class="line">	add	x12, x12, w11, UXTW #4	// x12 = buckets+(mask&lt;&lt;4)</div><div class="line"></div><div class="line">	// Clone scanning loop to miss instead of hang when cache is corrupt.</div><div class="line">	// The slow path may detect any corruption and halt later.</div><div class="line"></div><div class="line">	ldp	x16, x17, [x12]		// &#123;x16, x17&#125; = *bucket</div><div class="line">1:	cmp	x16, x1			// if (bucket-&gt;sel != _cmd)</div><div class="line">	b.ne	2f			//     scan more</div><div class="line">	CacheHit $0			// call or return imp</div><div class="line">	</div><div class="line">2:	// not hit: x12 = not-hit bucket</div><div class="line">	CheckMiss $0			// miss if bucket-&gt;cls == 0</div><div class="line">	cmp	x12, x10		// wrap if bucket == buckets</div><div class="line">	b.eq	3f</div><div class="line">	ldp	x16, x17, [x12, #-16]!	// &#123;x16, x17&#125; = *--bucket</div><div class="line">	b	1b			// loop</div><div class="line"></div><div class="line">3:	// double wrap</div><div class="line">	JumpMiss $0</div><div class="line">	</div><div class="line">.endmacro</div><div class="line"></div><div class="line">/*** ignore... ***/</div><div class="line"></div><div class="line">	ENTRY _objc_msgSend</div><div class="line">	MESSENGER_START</div><div class="line"></div><div class="line">	cmp	x0, #0			// nil check and tagged pointer check</div><div class="line">	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)</div><div class="line">	ldr	x13, [x0]		// x13 = isa</div><div class="line">	and	x9, x13, #ISA_MASK	// x9 = class	</div><div class="line">LGetIsaDone:</div><div class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</div></pre></td></tr></table></figure>
<p>具体解析下 <code>__objc_msgSend_uncached_impcache</code>  这个函数, 在函数入口保存寄存器和返回地址, 在调用 <code>__class_lookupMethodAndLoadCache3</code> 之后进行恢复. <code>__class_lookupMethodAndLoadCache3</code> 函数返回需要调用函数的地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div></pre></td><td class="code"><pre><div class="line"> // objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line"></div><div class="line">STATIC_ENTRY __objc_msgSend_uncached_impcache</div><div class="line"></div><div class="line">// THIS IS NOT A CALLABLE C FUNCTION</div><div class="line">// Out-of-band x9 is the class to search</div><div class="line"></div><div class="line">MESSENGER_START</div><div class="line"></div><div class="line">// push frame</div><div class="line">stp	fp, lr, [sp, #-16]!</div><div class="line">mov	fp, sp</div><div class="line"></div><div class="line">MESSENGER_END_SLOW</div><div class="line"></div><div class="line">// save parameter registers: x0..x8, q0..q7</div><div class="line">sub	sp, sp, #(10*8 + 8*16)</div><div class="line">stp	q0, q1, [sp, #(0*16)]</div><div class="line">stp	q2, q3, [sp, #(2*16)]</div><div class="line">stp	q4, q5, [sp, #(4*16)]</div><div class="line">stp	q6, q7, [sp, #(6*16)]</div><div class="line">stp	x0, x1, [sp, #(8*16+0*8)]</div><div class="line">stp	x2, x3, [sp, #(8*16+2*8)]</div><div class="line">stp	x4, x5, [sp, #(8*16+4*8)]</div><div class="line">stp	x6, x7, [sp, #(8*16+6*8)]</div><div class="line">str	x8,     [sp, #(8*16+8*8)]</div><div class="line"></div><div class="line">// receiver and selector already in x0 and x1</div><div class="line">mov	x2, x9</div><div class="line">bl	__class_lookupMethodAndLoadCache3</div><div class="line"></div><div class="line">// imp in x0</div><div class="line">mov	x17, x0</div><div class="line"></div><div class="line">// restore registers and return</div><div class="line">ldp	q0, q1, [sp, #(0*16)]</div><div class="line">ldp	q2, q3, [sp, #(2*16)]</div><div class="line">ldp	q4, q5, [sp, #(4*16)]</div><div class="line">ldp	q6, q7, [sp, #(6*16)]</div><div class="line">ldp	x0, x1, [sp, #(8*16+0*8)]</div><div class="line">ldp	x2, x3, [sp, #(8*16+2*8)]</div><div class="line">ldp	x4, x5, [sp, #(8*16+4*8)]</div><div class="line">ldp	x6, x7, [sp, #(8*16+6*8)]</div><div class="line">ldr	x8,     [sp, #(8*16+8*8)]</div><div class="line"></div><div class="line">mov	sp, fp</div><div class="line">ldp	fp, lr, [sp], #16</div><div class="line"></div><div class="line">br	x17</div><div class="line"></div><div class="line">END_ENTRY __objc_msgSend_uncached_impcache</div></pre></td></tr></table></figure>
<p>举个例子演示下, 这里可以仔细观察 lldb 的输出.</p>
<p><img src="/images/debug-objc_msgSend.png" alt=""></p>
<h2 id="构建-fake-objc-msgSend"><a href="#构建-fake-objc-msgSend" class="headerlink" title="构建 fake_objc_msgSend"></a>构建 fake_objc_msgSend</h2><p>在了解了 objc_msgSend 的流程, 接下来构建 <code>fake_objc_msgSend</code>, 需要保存保存寄存器状态, 以正确调用原 <code>objc_msgSend</code>, 这里解释下为什么需要保存寄存器状态, 因为参数个数不定, 所以可能会同时用到多个寄存器和栈来同时传参, 所以这里需要将可能会用到的所有寄存器以及 sp 都保存, 以确保多参数不被修改. 其实把这里的保护寄存器实现在 hook 层可能会更好一些. (下面的代码加了一些注释, 和参考资料). 最终通过把寄存器参数保存在栈中, 并以栈指针作为参数, 传给 <code>hookBefore</code>.</p>
<p>ok, 说完了函数的参数(寄存器)保存和恢复部分, 接下来谈一谈函数调用栈的问题. 首先需要明确, 并不希望记录所有函数的调用, 所以在记录函数调用栈时希望只有经过过滤的函数才能进行调用记录. 这必须要保证调用栈的 push 和 pop 操作必须对应. 这与 InspectiveC 不同, 这里使用 sp 区分函数, 以确保 push 和 pop 的对应正确.</p>
<p>这里总结一下 fake_objc_msgSend_safe 的工作</p>
<ol>
<li>保存寄存器/参数</li>
<li>解析参数, 判断类和函数是否符合标准, 打印 “类名:函数”,</li>
<li>函数调用入栈 </li>
<li>恢复寄存器/参数</li>
<li>如果经过判断不需要追踪, 使用 br 指令调用原 ojbc_msgSend</li>
<li>如果需要追踪 则使用 blr 指令调用 objc_msgSend<br>// 以上为 hookBefore 的工作, 以下为 hookAfter 的工作</li>
<li>保存寄存器/参数</li>
<li>函数调用出栈, 确保两次 fp 值相同</li>
<li>解析函数返回值</li>
<li>恢复寄存器/参数</li>
<li>ret 之前保存的 lr</li>
</ol>
<p>下面列出 fake_objc_msgSend_safe 的核心代码, 这里关于调用栈的操作主要放在 <code>hookBefore</code> 和 <code>hookAfter</code>, 关于在内联汇编中调用 c 函数这里也使用了两种方法, 一种使用 <code>nm</code> 导出符号, 一种使用内联汇编传参. 使用 ‘横线’ 分割了 <code>hookBefore</code> 和 <code>hookAfter</code> 相关处理代码, 大部分代码我都已经加了注释.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div></pre></td><td class="code"><pre><div class="line"></div><div class="line">void *func_ptr = (void *)hookAfter;</div><div class="line"></div><div class="line">// unsigned long func_ptr = reinterpret_cast&lt;unsigned long&gt;((void *)hookBefore);</div><div class="line"></div><div class="line">/*</div><div class="line"> * &lt;ARM Architecture Reference Manual - ARMv8, for ARMv8-A architecture profile&gt;</div><div class="line"> * or &lt;Programmer’s Guide for ARMv8-A&gt;</div><div class="line"> *</div><div class="line"> * C1.3.3: Load/Store addressing modes</div><div class="line"> *</div><div class="line"> * pay attention!!! all the below instructions will write back to base register!!!</div><div class="line"> * Pre-indexed [base, #imm]!</div><div class="line"> * Post-indexed [base], #imm</div><div class="line"> *</div><div class="line"> */</div><div class="line"></div><div class="line">__attribute__((__naked__)) static void fake_objc_msgSend_safe()</div><div class="line">&#123;</div><div class="line">    // backup registers</div><div class="line">    __asm__ volatile(</div><div class="line">        // NONEED: actually we not need this code, but must delete the same in the `hookBefore` and `hookAfter`</div><div class="line">        "stp fp, lr, [sp, #-16]!\n"</div><div class="line">        "mov fp, sp\n"</div><div class="line"></div><div class="line">        "sub sp, sp, #(6*2*8+4*2*16)\n"</div><div class="line"></div><div class="line">        /*</div><div class="line">                may be we can leave several register-size blank, to store return value. -.-</div><div class="line">             */</div><div class="line"></div><div class="line">        // push fp(sp), lr</div><div class="line">        "stp fp, lr, [sp, #(0*8)]\n"</div><div class="line"></div><div class="line">        // push &#123;x0-x8&#125;</div><div class="line">        "stp x0, x1, [sp, #(2*8+0*8)]\n"</div><div class="line">        "stp x2, x3, [sp, #(2*8+2*8)]\n"</div><div class="line">        "stp x4, x5, [sp, #(2*8+4*8)]\n"</div><div class="line">        "stp x6, x7, [sp, #(2*8+6*8)]\n"</div><div class="line">        // NONEED: just a thought trick.</div><div class="line">        "mov x0, sp\n"</div><div class="line">        "stp x8, x0, [sp, #(2*8+8*8)]\n"</div><div class="line"></div><div class="line">        // push &#123;q0-q7&#125;</div><div class="line">        "stp q0, q1, [sp, #(12*8+0*16)]\n"</div><div class="line">        "stp q2, q3, [sp, #(12*8+2*16)]\n"</div><div class="line">        "stp q4, q5, [sp, #(12*8+4*16)]\n"</div><div class="line">        "stp q6, q7, [sp, #(12*8+6*16)]\n");</div><div class="line"></div><div class="line">    // prepare args for func</div><div class="line">    __asm__ volatile(</div><div class="line">        "mov x0, sp\n"</div><div class="line">        "bl __Z10hookBeforeP9RegState_\n"</div><div class="line">        "mov x9, x0");</div><div class="line"></div><div class="line">    // get value from `ReturnPayload`</div><div class="line">    __asm__ volatile(</div><div class="line">        "ldp x10, x9, [x9]\n");</div><div class="line"></div><div class="line">    // restore registers</div><div class="line">    __asm__ volatile(</div><div class="line">        // pop fp, lr</div><div class="line">        "ldp fp, lr, [sp], #16\n"</div><div class="line"></div><div class="line">        // pop &#123;x0-x8&#125;</div><div class="line">        "ldp x0, x1, [sp], #16\n"</div><div class="line">        "ldp x2, x3, [sp], #16\n"</div><div class="line">        "ldp x4, x5, [sp], #16\n"</div><div class="line">        "ldp x6, x7, [sp], #16\n"</div><div class="line">        "ldr x8, [sp], #16\n"</div><div class="line">        // "ldr x8, x8, [sp], #16\n" wrong???</div><div class="line"></div><div class="line">        // pop &#123;q0-q7&#125;</div><div class="line">        "ldp q0, q1, [sp], #32\n"</div><div class="line">        "ldp q2, q3, [sp], #32\n"</div><div class="line">        "ldp q4, q5, [sp], #32\n"</div><div class="line">        "ldp q6, q7, [sp], #32\n"</div><div class="line"></div><div class="line">        // NONEED: actually we not need this code.</div><div class="line">        "mov sp, fp\n"</div><div class="line">        "ldp fp, lr, [sp], #16");</div><div class="line"></div><div class="line">    // go to the original objc_msgSend</div><div class="line">    __asm__ volatile(</div><div class="line">        // "br x9\n"</div><div class="line">        "cbnz x9, Lthroughx\n"</div><div class="line">        "br x10\n"</div><div class="line">        "Lthroughx:\n"</div><div class="line">        "blr x10");</div><div class="line"></div><div class="line">    //-----------------------------------------------------------------------------</div><div class="line">    // after objc_msgSend we parse the result.</div><div class="line">    /*</div><div class="line">        ATTENTION:</div><div class="line">        we need to build ourself callstack(only the function that we want to trace).As the callstack only contain the functions that we want to trace, </div><div class="line">        so the operation `push` and `pop` must be mutually corresponding operation. int other words, just make sure `hookBefore` and `hookAfter` is invoked by the same function.</div><div class="line"></div><div class="line">        trick is: use the register `sp`(yes, system call stack) to determine the function. use `fp` to save `lr`.</div><div class="line"></div><div class="line">     */</div><div class="line">    __asm__ volatile(</div><div class="line">        // NONEED: actually we not need this code.</div><div class="line">        "stp fp, lr, [sp, #-16]!\n"</div><div class="line">        "mov fp, sp\n"</div><div class="line"></div><div class="line">        "sub sp, sp, #(6*2*8+4*2*16)\n"</div><div class="line"></div><div class="line">        /*</div><div class="line">                may be we can leave several register-size blank, to store return value. -.-</div><div class="line">             */</div><div class="line"></div><div class="line">        // push fp(sp), lr</div><div class="line">        "stp fp, lr, [sp, #(0*8)]\n"</div><div class="line"></div><div class="line">        // push &#123;x0-x8&#125;</div><div class="line">        "stp x0, x1, [sp, #(2*8+0*8)]\n"</div><div class="line">        "stp x2, x3, [sp, #(2*8+2*8)]\n"</div><div class="line">        "stp x4, x5, [sp, #(2*8+4*8)]\n"</div><div class="line">        "stp x6, x7, [sp, #(2*8+6*8)]\n"</div><div class="line">        // NONEED: just a thought trick.</div><div class="line">        "mov x0, sp \n"</div><div class="line">        "stp x8, x0, [sp, #(2*8+8*8)]\n"</div><div class="line"></div><div class="line">        // push &#123;q0-q7&#125;</div><div class="line">        "stp q0, q1, [sp, #(12*8+0*16)]\n"</div><div class="line">        "stp q2, q3, [sp, #(12*8+2*16)]\n"</div><div class="line">        "stp q4, q5, [sp, #(12*8+4*16)]\n"</div><div class="line">        "stp q6, q7, [sp, #(12*8+6*16)]\n");</div><div class="line"></div><div class="line">    // prepare args for func</div><div class="line">    __asm__ volatile(</div><div class="line">        "mov x0, sp\n"</div><div class="line">        "mov x9, %[func]\n"</div><div class="line">        "blr x9\n"</div><div class="line">        "mov x9, x0\n"</div><div class="line">        :</div><div class="line">        : [func] "r"(func_ptr));</div><div class="line"></div><div class="line">    // restore registers</div><div class="line">    __asm__ volatile(</div><div class="line">        // pop fp, lr</div><div class="line">        "ldp fp, lr, [sp], #16\n"</div><div class="line"></div><div class="line">        // pop &#123;x0-x8&#125;</div><div class="line">        "ldp x0, x1, [sp], #16\n"</div><div class="line">        "ldp x2, x3, [sp], #16\n"</div><div class="line">        "ldp x4, x5, [sp], #16\n"</div><div class="line">        "ldp x6, x7, [sp], #16\n"</div><div class="line">        "ldr x8, [sp], #16\n"</div><div class="line"></div><div class="line">        // pop &#123;q0-q7&#125;</div><div class="line">        "ldp q0, q1, [sp], #32\n"</div><div class="line">        "ldp q2, q3, [sp], #32\n"</div><div class="line">        "ldp q4, q5, [sp], #32\n"</div><div class="line">        "ldp q6, q7, [sp], #32\n"</div><div class="line"></div><div class="line">        // NONEED: actually we not need this code.</div><div class="line">        "mov sp, fp\n"</div><div class="line">        "ldp fp, lr, [sp], #16\n"</div><div class="line"></div><div class="line">        // go to the original objc_msgSend</div><div class="line">        "mov lr, x9\n"</div><div class="line">        "ret\n");</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然现在已经可以 hook 到 objc_msgSend.</p>
<p>利用下面的数据结构获取之前保存在栈中的参数, ps: 这个结构是参考 InspectiveC, 实现的很精巧, 在此基础上做了一些修改.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div></pre></td><td class="code"><pre><div class="line">// http://infocenter.arm.com/help/topic/com.arm.doc.den0024a/DEN0024A_v8_architecture_PG.pdf (7.2.1 Floating-point) (4.6.1 Floating-point register organization in AArch64)</div><div class="line">// use struct and union to describe diagram in the above link, nice!</div><div class="line"></div><div class="line">// to handle arm64 args</div><div class="line"></div><div class="line">typedef union FPReg_ &#123;</div><div class="line">    __int128_t q;</div><div class="line">    struct &#123;</div><div class="line">        double d1; // Holds the double (LSB).</div><div class="line">        double d2;</div><div class="line">    &#125; d;</div><div class="line">    struct &#123;</div><div class="line">        float f1; // Holds the float (LSB).</div><div class="line">        float f2;</div><div class="line">        float f3;</div><div class="line">        float f4;</div><div class="line">    &#125; f;</div><div class="line">&#125; FPReg;</div><div class="line"></div><div class="line">// just ref how to backup/restore registers</div><div class="line">struct RegState_ &#123;</div><div class="line">    uint64_t fp;</div><div class="line">    uint64_t lr;</div><div class="line"></div><div class="line">    union &#123;</div><div class="line">        uint64_t arr[10];</div><div class="line">        struct &#123;</div><div class="line">            uint64_t x0;</div><div class="line">            uint64_t x1;</div><div class="line">            uint64_t x2;</div><div class="line">            uint64_t x3;</div><div class="line">            uint64_t x4;</div><div class="line">            uint64_t x5;</div><div class="line">            uint64_t x6;</div><div class="line">            uint64_t x7;</div><div class="line">            uint64_t x8;</div><div class="line">            uint64_t x9;</div><div class="line">        &#125; regs;</div><div class="line">    &#125; general;</div><div class="line"></div><div class="line">    union &#123;</div><div class="line">        FPReg arr[8];</div><div class="line">        struct &#123;</div><div class="line">            FPReg q0;</div><div class="line">            FPReg q1;</div><div class="line">            FPReg q2;</div><div class="line">            FPReg q3;</div><div class="line">            FPReg q4;</div><div class="line">            FPReg q5;</div><div class="line">            FPReg q6;</div><div class="line">            FPReg q7;</div><div class="line">        &#125; regs;</div><div class="line">    &#125; floating;</div><div class="line">&#125;;</div><div class="line"></div><div class="line">typedef struct pa_list_ &#123;</div><div class="line">    struct RegState_ *regs; // Registers saved when function is called.</div><div class="line">    unsigned char *stack; // Address of current argument.</div><div class="line">    int ngrn; // The Next General-purpose Register Number.</div><div class="line">    int nsrn; // The Next SIMD and Floating-point Register Number.</div><div class="line">&#125; pa_list;</div></pre></td></tr></table></figure>
<h4 id="构建-hookBefore"><a href="#构建-hookBefore" class="headerlink" title="构建 hookBefore"></a>构建 hookBefore</h4><p><code>hookBefore</code> 实现了函数调用前的 trace 工作, 将函数压进调用栈, 解析类实例对象, 解析不定参数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vm_address_t</span> hookBefore(<span class="keyword">struct</span> RegState_ *rs)</div><div class="line">&#123;</div><div class="line">    pa_list args = (pa_list)&#123;</div><div class="line">        rs,</div><div class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span> *&gt;(rs-&gt;fp),</div><div class="line">        <span class="number">2</span>,</div><div class="line">        <span class="number">0</span>&#125;;</div><div class="line"></div><div class="line">    ThreadCallStack *cs = getThreadCallStack();</div><div class="line"></div><div class="line">    ReturnPayload *rp = cs-&gt;rp;</div><div class="line"></div><div class="line">    <span class="comment">// Xinfo("-:%ld", objc_msgSend_count++);</span></div><div class="line"></div><div class="line">    <span class="keyword">vm_address_t</span> xaddr = (<span class="keyword">uint64_t</span>)orig_objc_msgSend;</div><div class="line"></div><div class="line">    rp-&gt;addr = xaddr;</div><div class="line">    rp-&gt;lr = rs-&gt;lr;</div><div class="line">    rp-&gt;fp = rs-&gt;fp;</div><div class="line">    rp-&gt;isTrace = <span class="number">0</span>;</div><div class="line">    rp-&gt;key = rs-&gt;lr &amp; rs-&gt;fp;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> || pthread_main_np())</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// msg_count++;</span></div><div class="line">        <span class="comment">// Xinfo("--%ld\n", msg_count);</span></div><div class="line">        <span class="keyword">char</span> *methodSelector = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span> *&gt;(rs-&gt;general.regs.x1);</div><div class="line">        <span class="keyword">objc_class_info_t</span> *xobjc_class_info;</div><div class="line">        xobjc_class_info = mem-&gt;parse_OBJECT(rs-&gt;general.regs.x0);</div><div class="line">        <span class="keyword">if</span> (xobjc_class_info)</div><div class="line">        &#123;</div><div class="line">            <span class="keyword">if</span> (search_method(xobjc_class_info, methodSelector))</div><div class="line">            &#123;</div><div class="line">                CallRecord *cr = pushCallRecord(xobjc_class_info-&gt;class_name, methodSelector, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> *&gt;(rs-&gt;fp), <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> *&gt;(rs-&gt;lr), cs);</div><div class="line">                <span class="keyword">if</span>(cr) &#123;</div><div class="line">                    printCallRcord(cr, cs);</div><div class="line">                    rp-&gt;isTrace = <span class="number">1</span>;</div><div class="line">                &#125;</div><div class="line">            &#125;</div><div class="line">        &#125;</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(rp);</div><div class="line">    <span class="comment">// return xaddr;</span></div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>hookBefore 的参数其实之前备份寄存器后的 sp 地址, 再通过 <code>RegState_</code> 格式, 就可以取得所有寄存器的值. <code>rs-&gt;general.regs.x0</code> 存放的是实例地址, 但是按理说应该通过 <code>object_getClass(rs-&gt;general.regs.x0)</code> 应该取得类地址, 但是这里避免使用 Objective-C 就直接使用了 c++ 去实现 <code>objc4-680</code> 源码中对应的函数. <code>rs-&gt;general.regs.x1</code> 存放的是函数签名字符串.</p>
<p>用到了个人之前实现的 macho 的 parser 模块, 大致介绍下这个模块, 可以通过三种状态对 macho 格式进行解析: 1. 文件 2. pid 3. 自身进程, 这里使用第三种, 对自身进程进行解析. (这个模块实现也挺有意思, 需要考虑到 ‘文件偏移’, ‘虚拟地址’, ‘内存地址’ 三种地址的处理)</p>
<p><img src="/images/macho-parser.png" alt=""></p>
<p>对于类实例的解析, 比较复杂, 这里简单介绍下, 具体可以参照 macho-ABI 文档.</p>
<h4 id="构建-hookAfter"><a href="#构建-hookAfter" class="headerlink" title="构建 hookAfter"></a>构建 hookAfter</h4><p><code>hookAfter</code> 实现了 <code>objc_msgSend</code> 执行后, 函数的出栈工作, 并解析函数返回值.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div></pre></td><td class="code"><pre><div class="line">vm_address_t hookAfter(struct RegState_ *rs)</div><div class="line">&#123;</div><div class="line">    pa_list args = (pa_list)&#123;</div><div class="line">        rs,</div><div class="line">        reinterpret_cast&lt;unsigned char *&gt;(rs-&gt;fp),</div><div class="line">        2,</div><div class="line">        0&#125;;</div><div class="line">    ThreadCallStack *cs = getThreadCallStack();</div><div class="line">    CallRecord *cr = popCallRecordSafe(cs, (void *)rs-&gt;fp);</div><div class="line">    if (cr)</div><div class="line">    &#123;</div><div class="line">        return reinterpret_cast&lt;unsigned long&gt;(cr-&gt;lr);</div><div class="line">    &#125;</div><div class="line">    else</div><div class="line">    &#123;</div><div class="line">        cr = popCallRecord(cs);</div><div class="line">        return reinterpret_cast&lt;unsigned long&gt;(cr-&gt;lr);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="hookBefore-与-hookAfter-的数据传递"><a href="#hookBefore-与-hookAfter-的数据传递" class="headerlink" title="hookBefore 与 hookAfter 的数据传递."></a>hookBefore 与 hookAfter 的数据传递.</h4><p>其实关键在于 lr 寄存器值的传递, 由于需要获取 <code>objc_msgSend</code> 的返回值, 所以必须以 <code>blr objc_msgSend</code> 的方式调用, 此时之前 lr 寄存器的值被覆盖, 此时也不能进行 push 操作, 因为栈中可能已经保存了可变参数的值, 需要维持 sp 和 栈中内容不变, 那这里的 lr 如何保存恢复成了问题.</p>
<p>最后采用了线程私有变量的方法解决, 为每一个 <code>CallRecord</code> 添加 <code>lr</code> 成员, 在 <code>hookAfter</code> 是进行安全 pop, 也就是说同时需要校验 <code>rs-&gt;fp</code> 的值, 是否一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div></pre></td><td class="code"><pre><div class="line">// Shared structures.</div><div class="line">typedef struct CallRecord_ &#123;</div><div class="line">    void *objc;</div><div class="line">    void *method;</div><div class="line">    void *fp;</div><div class="line">    void *lr;</div><div class="line">&#125; CallRecord;</div><div class="line"></div><div class="line">typedef struct ThreadCallStack_ &#123;</div><div class="line">    CallRecord *stack;</div><div class="line">    ReturnPayload *rp;</div><div class="line">    int allocatedLength;</div><div class="line">    int index;</div><div class="line">&#125; ThreadCallStack;</div></pre></td></tr></table></figure>
<h2 id="如何正确过滤-objc-msgSend"><a href="#如何正确过滤-objc-msgSend" class="headerlink" title="如何正确过滤 objc_msgSend"></a>如何正确过滤 objc_msgSend</h2><p>目前我是通过<strong>过滤类地址和限制函数调用栈深度</strong>来避免 log 太复杂.</p>
<h4 id="过滤函数地址"><a href="#过滤函数地址" class="headerlink" title="过滤函数地址"></a>过滤函数地址</h4><p>目前仅跟踪类地址为二进制内存范围.</p>
<p>在 MachoParser 进行如下限制</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div></pre></td><td class="code"><pre><div class="line">if(class_addr &gt; m_load_addr &amp;&amp; class_addr &lt; m_load_end_addr) &#123;</div><div class="line">    xobjc_class_info = new objc_class_info_t();</div><div class="line">    xobjc_class_info-&gt;class_addr = class_addr;</div><div class="line">    parse_CLASS(xobjc_class_info);</div><div class="line">&#125; else &#123;</div><div class="line">    Sdebug(&quot;out of self memory.&quot;);</div><div class="line">    return NULL;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="限制函数调用栈深度"><a href="#限制函数调用栈深度" class="headerlink" title="限制函数调用栈深度"></a>限制函数调用栈深度</h4>
    

    
</div>


                

                <!-- Post Comments -->
                
                    







                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/04/28/darwin/反调试与绕过/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/05/11/darwin/ios应用安全审计思路/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.jpeg" alt="jmpews's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        jmpews@email.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: jmpews@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/" target="_self">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                Home
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    Archives
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">2</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">9</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">February 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">January 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">December 2016<span class="sidebar_archives-count">42</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                Categories
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/backend/">backend<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/darwin/">darwin<span class="sidebar_archives-count">12</span></a></li><li><a class="sidebar_archives-link" href="/categories/notes/">notes<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/pwn/">pwn<span class="sidebar_archives-count">15</span></a></li><li><a class="sidebar_archives-link" href="/categories/python/">python<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/categories/test/">test<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                Tags
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                Number of articles
                <span class="sidebar-badge">68</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/jmpews" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-twitter.svg);">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/winter1ife" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-weibo.svg);">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    

    <!-- Github -->
    
        <a href="https://github.com/jmpews" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn" style="background-image: url(/img/footer/footer_ico-github.svg);">
                <span class="visuallyhidden">Github</span>
            </button><!--
     --></a>
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©&nbsp;
            <script type="text/javascript">
                var fd = new Date();
                document.write(fd.getFullYear());
            </script>
            &nbsp;Zz
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->

    <script src="/js/lazyload.min.js"></script>
    <script src="/js/js.min.js"></script>



    <script src="/js/nprogress.js"></script>


<script type="text/javascript">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>
















<!-- Window Load-->
<script>
    $(window).load(function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script>
    <!-- Offer LazyLoad -->
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    <!-- Start Queue -->
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

                </main>
            </div>
        </body>
    
</html>
