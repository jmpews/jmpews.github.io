<!DOCTYPE html>
<html style="display: none;" lang="en">
    <head>
    <meta charset="utf-8">
    <!--
        © Material Theme
        https://github.com/viosey/hexo-theme-material
        Version: 1.4.0 -->
    <script>window.materialVersion = "1.4.0"</script>

    <!-- Title -->
    
    <title>
        
            如何正确的hook方法objc_msgSend | 
        
        Zz
    </title>

    <!-- dns prefetch -->
    <meta http-equiv="x-dns-prefetch-control" content="on">
    
    
    
    
    
    
    
    
    
    

    <!-- Meta & Info -->
    <meta http-equiv="X-UA-Compatible">
    <meta name="viewport" content="width=device-width, initial-scale=1, user-scalable=no">
    <meta name="theme-color" content="#0097A7">
    <meta name="author" content="jmpews">
    <meta name="description" itemprop="description" content="pwn &amp; dev &amp; reverse">
    <meta name="keywords" content="null,darwin,macho">

    <!-- Site Verification -->
    
    

    <!-- Favicons -->
    <link rel="icon shortcut" type="image/ico" href="/img/favicon.png">
    <link rel="icon" sizes="192x192" href="/img/favicon.png">
    <link rel="apple-touch-icon" href="/img/favicon.png">

    <!--iOS -->
    <meta name="apple-mobile-web-app-title" content="Title">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="HandheldFriendly" content="True">
    <meta name="MobileOptimized" content="480">

    <!-- Add to homescreen for Chrome on Android -->
    <meta name="mobile-web-app-capable" content="yes">

    <!-- Add to homescreen for Safari on iOS -->
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black">
    <meta name="apple-mobile-web-app-title" content="Zz">

    <!-- The Open Graph protocol -->
    <meta property="og:url" content="http://jmpews.github.com">
    <meta property="og:type" content="blog">
    <meta property="og:title" content="如何正确的hook方法objc_msgSend | Zz">
    <meta property="og:image" content="/img/favicon.png" />
    <meta property="og:description" content="pwn &amp; dev &amp; reverse">
    <meta property="og:article:tag" content="darwin"> <meta property="og:article:tag" content="macho"> 

    
        <meta property="article:published_time" content="Mon May 01 2017 14:38:13 GMT+0800" />
        <meta property="article:modified_time" content="Tue Jun 20 2017 16:10:42 GMT+0800" />
    

    <!-- The Twitter Card protocol -->
    <meta name="twitter:title" content="如何正确的hook方法objc_msgSend | Zz">
    <meta name="twitter:description" content="pwn &amp; dev &amp; reverse">
    <meta name="twitter:image" content="/img/favicon.png">
    <meta name="twitter:card" content="summary_large_image" />
    <meta name="twitter:url" content="http://jmpews.github.com" />

    <!-- Add canonical link for SEO -->
    
        <link rel="canonical" href="http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html" />
    

    <!-- Structured-data for SEO -->
    
        


<script type="application/ld+json">
{
    "@context": "https://schema.org",
    "@type": "Article",
    "publisher": {
        "@type": "Organization",
        "name": "Zz",
        "logo": "/img/favicon.png"
    },
    "author": {
        "@type": "Person",
        "name": "jmpews",
        "image": {
            "@type": "ImageObject",
            "url": "/img/favicon.png"
        },
        "description": "Zz..."
    },
    "headline": "如何正确的hook方法objc_msgSend",
    "url": "http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html",
    "datePublished": "Mon May 01 2017 14:38:13 GMT+0800",
    "dateModified": "Tue Jun 20 2017 16:10:42 GMT+0800",
    "description": "pwn &amp; dev &amp; reverse",
    "mainEntityOfPage": {
        "@type": "WebPage",
        "@id": "http://jmpews.github.com"
    }
}
</script>


    

    <!--[if lte IE 9]>
        <link rel="stylesheet" href="/css/ie-blocker.css">

        
            <script src="/js/ie-blocker.en.js"></script>
        
    <![endif]-->

    <!-- Import lsloader -->
    <script>(function(){window.lsloader={jsRunSequence:[],jsnamemap:{},cssnamemap:{}};lsloader.removeLS=function(key){try{localStorage.removeItem(key)}catch(e){}};lsloader.setLS=function(key,val){try{localStorage.setItem(key,val)}catch(e){}};lsloader.getLS=function(key){var val="";try{val=localStorage.getItem(key)}catch(e){val=""}return val};versionString="/*"+materialVersion+"*/";lsloader.clean=function(){try{var keys=[];for(var i=0;i<localStorage.length;i++){keys.push(localStorage.key(i))}keys.forEach(function(key){var data=lsloader.getLS(key);if(data&&data.indexOf(versionString)===-1){lsloader.removeLS(key)}})}catch(e){}};lsloader.clean();lsloader.load=function(jsname,jspath,cssonload){cssonload=cssonload||function(){};var code;code=this.getLS(jsname);if(code&&code.indexOf(versionString)===-1){this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}if(code){var versionNumber=code.split(versionString)[0];if(versionNumber!=jspath){console.log("reload:"+jspath);this.removeLS(jsname);this.requestResource(jsname,jspath,cssonload);return}code=code.split(versionString)[1];if(/\.js?.+$/.test(versionNumber)){this.jsRunSequence.push({name:jsname,code:code});this.runjs(jspath,jsname,code)}else{document.getElementById(jsname).appendChild(document.createTextNode(code));cssonload()}}else{this.requestResource(jsname,jspath,cssonload)}};lsloader.requestResource=function(name,path,cssonload){var that=this;if(/\.js?.+$/.test(path)){this.iojs(path,name,function(path,name,code){that.setLS(name,path+versionString+code);that.runjs(path,name,code)})}else if(/\.css?.+$/.test(path)){this.iocss(path,name,function(code){document.getElementById(name).appendChild(document.createTextNode(code));that.setLS(name,path+versionString+code)},cssonload)}};lsloader.iojs=function(path,jsname,callback){var that=this;that.jsRunSequence.push({name:jsname,code:""});try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(path,jsname,xhr.response);return}}that.jsfallback(path,jsname)}};xhr.send(null)}catch(e){that.jsfallback(path,jsname)}};lsloader.iocss=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.iofonts=function(path,jsname,callback,cssonload){var that=this;try{var xhr=new XMLHttpRequest;xhr.open("get",path,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){callback(xhr.response);cssonload();return}}that.cssfallback(path,jsname,cssonload)}};xhr.send(null)}catch(e){that.cssfallback(path,jsname,cssonload)}};lsloader.runjs=function(path,name,code){if(!!name&&!!code){for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code=code}}}if(!!this.jsRunSequence[0]&&!!this.jsRunSequence[0].code&&this.jsRunSequence[0].status!="failed"){var script=document.createElement("script");script.appendChild(document.createTextNode(this.jsRunSequence[0].code));script.type="text/javascript";document.getElementsByTagName("head")[0].appendChild(script);this.jsRunSequence.shift();if(this.jsRunSequence.length>0){this.runjs()}}else if(!!this.jsRunSequence[0]&&this.jsRunSequence[0].status=="failed"){var that=this;var script=document.createElement("script");script.src=this.jsRunSequence[0].path;script.type="text/javascript";this.jsRunSequence[0].status="loading";script.onload=function(){that.jsRunSequence.shift();if(that.jsRunSequence.length>0){that.runjs()}};document.body.appendChild(script)}};lsloader.tagLoad=function(path,name){this.jsRunSequence.push({name:name,code:"",path:path,status:"failed"});this.runjs()};lsloader.jsfallback=function(path,name){if(!!this.jsnamemap[name]){return}else{this.jsnamemap[name]=name}for(var k in this.jsRunSequence){if(this.jsRunSequence[k].name==name){this.jsRunSequence[k].code="";this.jsRunSequence[k].status="failed";this.jsRunSequence[k].path=path}}this.runjs()};lsloader.cssfallback=function(path,name,cssonload){if(!!this.cssnamemap[name]){return}else{this.cssnamemap[name]=1}var link=document.createElement("link");link.type="text/css";link.href=path;link.rel="stylesheet";link.onload=link.onerror=cssonload;var root=document.getElementsByTagName("script")[0];root.parentNode.insertBefore(link,root)};lsloader.runInlineScript=function(scriptId,codeId){var code=document.getElementById(codeId).innerText;this.jsRunSequence.push({name:scriptId,code:code});this.runjs()};lsloader.loadCombo=function(jslist){var updateList="";var requestingModules={};for(var k in jslist){var LS=this.getLS(jslist[k].name);if(!!LS){var version=LS.split(versionString)[0];var code=LS.split(versionString)[1]}else{var version=""}if(version==jslist[k].path){this.jsRunSequence.push({name:jslist[k].name,code:code,path:jslist[k].path})}else{this.jsRunSequence.push({name:jslist[k].name,code:null,path:jslist[k].path,status:"comboloading"});requestingModules[jslist[k].name]=true;updateList+=(updateList==""?"":";")+jslist[k].path}}var that=this;if(!!updateList){var xhr=new XMLHttpRequest;xhr.open("get",combo+updateList,true);xhr.onreadystatechange=function(){if(xhr.readyState==4){if(xhr.status>=200&&xhr.status<300||xhr.status==304){if(xhr.response!=""){that.runCombo(xhr.response,requestingModules);return}}else{for(var i in that.jsRunSequence){if(requestingModules[that.jsRunSequence[i].name]){that.jsRunSequence[i].status="failed"}}that.runjs()}}};xhr.send(null)}this.runjs()};lsloader.runCombo=function(comboCode,requestingModules){comboCode=comboCode.split("/*combojs*/");comboCode.shift();for(var k in this.jsRunSequence){if(!!requestingModules[this.jsRunSequence[k].name]&&!!comboCode[0]){this.jsRunSequence[k].status="comboJS";this.jsRunSequence[k].code=comboCode[0];this.setLS(this.jsRunSequence[k].name,this.jsRunSequence[k].path+versionString+comboCode[0]);comboCode.shift()}}this.runjs()}})();</script>

    <!-- Import CSS & jQuery -->
    
        <style id="css/material.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/material.min.css","/css/material.min.css?fJTiM/K1J3dWIruo3pxtAw==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        <style id="css/style.min.css"></style><script>if(typeof window.lsLoadCSSMaxNums === "undefined")window.lsLoadCSSMaxNums = 0;window.lsLoadCSSMaxNums++;lsloader.load("css/style.min.css","/css/style.min.css?oCSEO3ST+aEypEwttTDI9g==",function(){if(typeof window.lsLoadCSSNums === "undefined")window.lsLoadCSSNums = 0;window.lsLoadCSSNums++;if(window.lsLoadCSSNums == window.lsLoadCSSMaxNums)document.documentElement.style.display="";})</script>
        
        
            <style>
    
    
    .footer-sns-twitter {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNiA3OGMtMjIuNCA1LjItNTUuOCA0MC4yLTYwLjYgNjMuNC0xLjQgNi40LTIgMTI5LjgtMS42IDM2Ny42LjYgMjk4LjYgMSAzNTguOCAzLjQgMzYzIDExIDIwLjIgMjEuNiAzMi40IDM3LjIgNDMgMTUgMTAuMiAxNy40IDExLjIgMzMgMTMgMTEuMiAxLjQgMTM2IDIgMzY1IDEuNiAzMTQtLjYgMzQ4LjYtMSAzNTUtMy44IDE1LjgtNy4yIDMzLjgtMjIgNDMuMi0zNS40IDUuMi03LjQgMTAuOC0xNi42IDEyLjYtMjAuNCAyLjgtNi40IDMuMi00MC44IDMuOC0zNTQgLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy0zNC04LjYtMTIuNi0xNC4yLTE4LjQtMjUuMi0yNS44LTcuOC01LjQtMTcuNC0xMS0yMS42LTEyLjQtNi0yLjItNzIuOC0yLjYtMzY1LjQtMi42LTE5Ni44LjItMzYxIC44LTM2NC40IDEuOHptNTMyLjggMjA1YzEwIDQgMjMgMTAuOCAyOC44IDE1LjIgMTIuNiA5LjIgMTYuNiAxMC42IDI5LjQgOS40IDYuNi0uNiAxMy0zLjIgMjAuNC04LjIgMTEuMi03LjYgMTkuNC05LjIgMjMuNi01IDMuNiAzLjYgMi44IDktMi44IDE4LjYtNy4yIDEyLjQtNiAxOC44IDQuMiAyNC4yIDQuNCAyLjIgOC4yIDUuNiA4LjYgNy40IDEgNC44LTEyLjYgMjQuMi0yMiAzMS44LTExLjggOS4yLTE3LjIgMjIuNi0xOS42IDQ3LjgtNC44IDUwLjQtNy44IDY2LjYtMTYuNCA4NS40LTMgNy03IDE3LjgtOC44IDI0LTEuOCA2LjQtNSAxNC42LTcuNCAxOC40LTIuMiAzLjgtNy40IDEzLTExLjQgMjAuNC0xNy4yIDMwLjgtNDMuNCA2MS40LTcxLjQgODMuOC0yNS42IDIwLjQtNDYgMzMuMi02NC4yIDQwLjItOC40IDMuMi0xOCA3LjYtMjEuNCA5LjYtNy40IDQuNi0yMi40IDguNi01Ny4yIDE1LTYyLjIgMTEuNi03OS4yIDExLjQtMTM1LjYtMS0zMi40LTctMzguNi05LTUyLTE2LjgtMjEuNC0xMi42LTI0LjItMTQuOC0yNC4yLTE5LjQgMC02LjIgMTAuMi05LjIgMzUtMTAuNCAyMi40LTEgMjguNi0yLjYgNTctMTQuMiAyMy44LTkuOCAyOS40LTEyLjggMzAuNC0xNi44IDIuMi04LjItMy0xMy4yLTI2LjgtMjUuNC0yNS44LTEzLjItMzIuMi0xOC40LTQzLjgtMzUuOC05LTEzLjYtMTAtMjEuMi0zLjYtMzMuNiA1LjQtMTAuOCAzLjYtMTUtMTEuOC0yNS40LTktNi0xNC0xMS42LTIwLjgtMjIuNi0yMy40LTM3LjgtMjUtNTAuOC03LjItNTkuOCA0LjgtMi40IDkuNC01LjQgMTAuMi02LjYgMi44LTQuMi0uNC0xNS42LTguNC0yOS0xMS42LTE5LjYtMTMuMi0yNS44LTEzLjItNTUuMiAwLTI4LjggMi42LTM3LjggMTItNDAuMiA5LTIuMiAxNC44IDEgMzUuNiAyMC4yIDI0LjggMjIuOCA0My42IDM2LjYgNjIuOCA0NS44IDggMy44IDE3LjggOS4yIDIyIDEyIDQuMiAyLjggMTQuOCA3IDIzLjQgOS4yIDguNiAyLjIgMjQuMiA2LjggMzQuOCAxMC4yIDEzLjQgNC40IDIzLjYgNi40IDMzIDYuNiAxMi44LjIgMTQuMi0uMiAxOC42LTUuNCA0LTQuOCA0LjgtNy44IDQuOC0xOS4yIDAtMTQuNCA1LjYtMzkuNiAxMS4yLTUwLjYgNC4yLTguNCAyOS4yLTM0LjIgMzkuOC00MS40IDcuOC01LjQgMzUuNi0xNiA1Mi0yMCAxNC4yLTMuNiAzMi42LTEuMiA1Mi40IDYuOHoiLz48L3N2Zz4=);
    }
    
    
    
    .footer-sns-weibo {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzUuMiA3OWMtOC42IDMtMjIuOCAxMi40LTMyLjggMjEuOC04LjIgNy44LTIyLjIgMzEtMjQuNiA0MC42LTEgNC4yLTEuNiAxNjctMS42IDM2NC42IDAgMjg0LjguNCAzNTguNCAyLjYgMzY0IDEuNCAzLjggNi44IDEzIDEyIDIwLjQgOC44IDEyLjggMjQgMjUuNCA0MS44IDM1IDYgMy40IDI3IDMuNiAzNjcuNCAzLjYgMjg2LjIgMCAzNjIuNi0uNiAzNjktMi42IDE5LjgtNi4yIDUxLjItMzcuNiA1Ny40LTU3LjQgMi02LjQgMi42LTgyLjYgMi42LTM2OFYxNDFsLTQuMi05Yy0xMS42LTI0LTM5LjItNDkuOC01OC4yLTU0LjItNC4yLTEtMTY4LjYtMS42LTM2NS42LTEuNi0zMDAgMC0zNTkuMi40LTM2NS44IDIuOHptNTU4LjYgMTY5YzguNiAxLjIgMTYuNCA0IDI0IDguNiA2LjIgMy42IDE1LjIgOC4yIDIwLjIgMTAuMiA1LjggMi4yIDE0LjYgOC44IDI1IDE4LjggMjUuNCAyNC44IDMyLjggMzQuOCAzNy44IDUxIDIuNiA4IDcuNCAxOS44IDEwLjggMjYuNCA3LjggMTQuNiAxMS42IDQyLjYgOS40IDY5LTEgMTQuMi0yLjIgMTguNi03LjQgMjYuNC0zLjIgNS4yLTkgMTIuMi0xMi44IDE1LjYtMTMuOCAxMi0zNCA1LjgtMzguOC0xMi0xLjYtNi0xLjQtMTEuNCAxLjItMjMuNCA0LjItMjAgMy00Ni0yLjYtNTguNi0yLjItNS04LTEyLjYtMTIuOC0xNi44LTQuOC00LjItMTQuNi0xNi40LTIxLjgtMjYuOC03LjItMTAuNi0xNS4yLTIwLjgtMTgtMjIuOC0yLjgtMi0xMi42LTYtMjItOS0xNC40LTQuNC0yMC44LTUuNC00My01LjYtMjgtLjItMzEuNC0xLjItNDIuNC0xMS42LTcuNC03LTguNi0xNS42LTMuOC0yNS4yIDctMTMuMiAxNi40LTE2IDU0LjItMTYgMTYuNiAwIDM1LjguOCA0Mi44IDEuOHptLTIxMy42IDc1LjZjMjAuMiAxNS40IDIwLjYgMTYuNCAyMiA0OCAuNiAxNSAxLjggMjkgMi42IDMxIDIuOCA2LjIgMTEgNi42IDIxLjYuNiA1LjQtMy4yIDE0LTUuOCAyMC02LjQgNS44LS42IDE4LjgtMi40IDI5LTQuMiAxNy4yLTMgMTkuNC0zIDM2IC40IDMyIDYuNiAzNS44IDkuMiA0NC4yIDMxLjYgNS4yIDE0IDUuNCAyMS40IDEuMiAzMi44LTIuMiA1LjQtMi44IDExLTIgMTUuNCAxLjggMTAgMTcuNiAyMy40IDM1IDMwLjIgMTEuMiA0LjIgMTYuMiA3LjYgMjcgMTkgMTkuMiAxOS44IDIwLjIgMjMgMjAgNTktLjIgMzUtLjQgMzUuNC0xOS44IDYzLjYtMTMuOCAxOS44LTMyLjQgMzguNi00OSA1MC01IDMuNC0xMi4yIDguOC0xNS44IDEyLTMuOCAzLjItMTEuNiA4LTE3LjIgMTAuNC01LjYgMi42LTE0LjYgNy40LTE5LjggMTAuNi01LjIgMy40LTE1LjggNy42LTIzLjggOS40LTggMi0yMS4yIDYuNi0yOS42IDEwLjItMjIuNCAxMC0zNi4yIDExLjItMTIxLjggMTAuNGwtNzUtLjYtMTktOC40Yy0xMC42LTQuNi0yNS40LTkuOC0zMy0xMS42LTcuNi0xLjYtMTgtNS44LTIzLTlzLTE0LjItOC0yMC40LTEwLjhjLTE4LTgtNTkuNC00Ni4yLTY2LTYxLjItMi4yLTUtNy40LTE0LjQtMTEuNC0yMC44bC03LjItMTJWNTQ5bDcuNi0xMy42YzQuMi03LjQgOS40LTE4LjYgMTEuNi0yNC44IDMuOC0xMS40IDEzLjQtMjcuOCAyNC44LTQyLjYgMjAuMi0yNi4yIDM4LjQtNDYuOCA1My02MCA5LjItOC4yIDIxLTE4LjYgMjYtMjMuMiA1LTQuNCAxMy4yLTExIDE4LjYtMTQuNiA1LjItMy40IDkuNC03LjIgOS40LTggMC0xIDUuNi00LjYgMTIuNi04LjIgNi44LTMuOCAxNi40LTkuNiAyMS40LTEzLjIgNS0zLjYgMTQuNC04IDIxLTkuOCA2LjYtMiAxNy44LTYuNiAyNS0xMC4yIDEyLTYuMiAxNC40LTYuOCAzMi40LTYuOGgxOS40bDEyLjQgOS42em0yMDMuNiAxMy4yYzMgMS42IDYuNiA0LjQgOCA2IDEuNiAxLjggOS40IDcgMTcuNCAxMS42IDE3IDkuNiAxOSAxMyAyNCA0MiAzLjQgMjAuNCAyLjYgMzIuMi0zLjQgNDMuOC03LjYgMTUuMi0yMi44IDIwLjYtMzEuMiAxMS4yLTctNy42LTkuMi0xMy44LTEwLjYtMjkuNi0xLjItMTMuMi0yLjQtMTYuNC05LjYtMjcuMi0xMS0xNi0xNi44LTIwLjYtMjcuMi0yMC42LTEwIDAtMjQtNi4yLTI3LTExLjYtNS44LTEwLjguNC0yNC42IDEyLjQtMjguNCA4LjYtMi42IDQwLjItLjggNDcuMiAyLjh6Ii8+PHBhdGggZD0iTTQyNCA0NzcuNGMtMzIuNiAzLjYtNDcuOCA3LTYxLjggMTMuOC04IDQtMTkgOC40LTI0LjIgMTAtNS4yIDEuNi0xMi40IDUtMTYuMiA3LjgtMy44IDIuNi0xMSA3LjYtMTYuMiAxMS0xMy40IDguOC0zNSAzMy4yLTM4LjggNDQtMS44IDUtNS40IDE0LjQtOC4yIDIxLTguOCAyMS4yLTguMiAyNi44IDQgNTMgMTAuNiAyMi42IDExIDIzLjIgMjcuNiAzNi40IDIxIDE2LjggMjMuNiAxOC40IDUwLjggMjguMiAyMC4yIDcuMiAyNC42IDggNTQgMTAgMTcuNiAxLjIgNDUuNiAyLjIgNjIgMi4ybDMwIC4yIDE3LjQtOC40YzkuNi00LjYgMjIuNC05LjYgMjguMi0xMS40IDYtMS44IDE1LjQtNi4yIDIwLjgtMTAgNS40LTMuNiAxMy40LTguNiAxNy42LTEwLjggOS4yLTQuNiAzOS0zNC40IDM5LTM5IDAtMS42IDMuOC0xMC4yIDguNC0xOC44IDcuOC0xNC4yIDguNi0xNi44IDguNC0yOS42LS4yLTEyLjgtMS0xNS44LTEwLjYtMzQuNi0xMy40LTI2LjItMzAuNC00My42LTUwLjItNTEuNC03LjItMi44LTE2LjItNy0yMC05LjYtMTEuNC03LjYtMTcuNi05LjItNDguOC0xMi40LTI3LjYtMi44LTU2LjYtMy40LTczLjItMS42em0zOS40IDQ0LjRjMTEuMiAyLjIgMjIuNiA1IDI1IDYuNCA3IDMuNiAyNiAyMS44IDMwLjggMjkuNCA4LjYgMTMuNCAxMSA1NCA0LjYgNzctMi42IDkuNi0xOC44IDI3LjYtMzkuNCA0NC4yLTE1LjYgMTIuNC0xNyAxMy0yOS44IDE0LTcuNi44LTIyLjQgMi4yLTMzIDMuNi0yMi42IDIuNi00NS42IDEtNTMuOC0zLjgtMy4yLTItOC02LjgtMTAuOC0xMC44LTIuNi00LjItOC40LTEwLjQtMTIuOC0xMy44LTguMi02LjgtMTMuNC0xNi40LTE5LjQtMzctMy44LTEzLjItMi44LTIxLjggNS4yLTQ3LjYgMy4yLTEwLjQgNi0xNC42IDE3LjQtMjUuOCAxMi40LTEyLjIgMjMuOC0yMi4yIDMzLjItMjkuNiA0LTMgMzguNi05LjQgNTMuNC05LjggNSAwIDE4LjIgMS42IDI5LjQgMy42eiIvPjxwYXRoIGQ9Ik0zODcuMiA2MDZjLTEyLjIgMy44LTE4LjIgMTMuNC0xNSAyNC42IDUuOCAyMS4yIDI3LjggMjUuOCA0MC42IDguNiA2LjYtOC44IDcuOC0xNi4yIDQuMi0yNC00LjgtMTAuMi0xNS40LTEzLjQtMjkuOC05LjJ6Ii8+PC9zdmc+);
    }
    
    
    
    .footer-sns-tumblr {
        background-image: url(data:image/svg+xml;base64,PHN2ZyB4bWxucz0iaHR0cDovL3d3dy53My5vcmcvMjAwMC9zdmciIHdpZHRoPSI0OCIgaGVpZ2h0PSI0OCIgY2xhc3M9Imljb24iIHZpZXdCb3g9IjAgMCAxMDI0IDEwMjQiPjxwYXRoIGQ9Ik0xMzguNCA3OGMtNi4yIDEuNC0yNi4yIDE0LjItMzYuMiAyMi44LTIuNiAyLjQtOSAxMC44LTE0LjIgMTguOC03LjQgMTEtMTAgMTcuMi0xMSAyNS0uNiA1LjgtMSAxNzAuNi0uNiAzNjYuNC42IDI5Ni44IDEgMzU2LjggMy40IDM2MSAxMSAyMC4yIDIxLjYgMzIuNCAzNy4yIDQzIDE1LjYgMTAuNiAxNy4yIDExLjIgMzQuMiAxMy4yIDExLjQgMS4yIDE0My4yIDEuOCAzNjQuOCAxLjQgMzEzLjgtLjYgMzQ3LjYtMSAzNTQtMy44IDIzLjItMTAuNiA0Mi40LTI5LjIgNTMuNi01MS44bDUuNC0xMSAuNi0zNDdjLjQtMjIzLS4yLTM1My40LTEuNC0zNjUtMi0xNy0yLjYtMTguNi0xMy4yLTM0LjItMTAuNi0xNS44LTIyLjQtMjUuOC00My0zNy00LjItMi40LTY1LjQtMi44LTM2Ni0zLjItMTk4LjYgMC0zNjQgLjQtMzY3LjYgMS40em00MDAuNCAxMzEuOGw1LjIgNC44djQ3LjhjMCAzNS40LjYgNDkuNCAyLjYgNTQuMiA1LjQgMTIuNCA0LjggMTIuNCA2Mi42IDEyLjYgNTcuNi4yIDU3IDAgNjIuMiAxMi4yIDMuMiA4IDMuOCA5My42LjYgMTA1LTEuMiA0LTQuNiA5LjQtNy40IDExLjYtNS4yIDQtNy4yIDQuMi01NiAzLjZMNTU4IDQ2MWwtNiA2LjJjLTkuMiA5LjItMTAuNCAyMi42LTkuNiAxMTMuNi42IDcxLjQgMSA3OC44IDQuMiA4NSA1IDkgMTguOCAyMy44IDI1LjYgMjcuNCA2LjYgMy4yIDQyLjYgNCA1MC44LjggMi44LTEgOS42LTYgMTUtMTEuMiA4LjQtNy44IDEwLjYtOSAxNy4yLTguNCA5LjIuOCAxNC44IDcuNiAxNyAyMSAyLjggMTYuOCAyLjIgNjgtMSA3NS4yLTQgOS42LTI1LjIgMjguOC0zMy40IDMwLjQtMy44LjYtNDEuNC44LTgzLjguNi04My42LS42LTgwLjgtLjItOTQtMTIuNi0zLjgtMy42LTEyLTguMi0xOC0xMC0xOC4yLTYtMjctMTguNi0yOS44LTQzLjYtMS4yLTguNi00LTE5LjItNy40LTI2LjQtNy0xNC44LTctMTYuNi03LjgtMTQ1LjgtLjYtMTA4LjguOC0xMDEuMi0xNy40LTEwMS4yLTUuNCAwLTEyLjItMS4yLTE1LjItMi44LTEwLjQtNS40LTExLjQtMTAtMTEuNC01NS4yIDAtMzUuNi42LTQyIDMuNi00Ni42IDUtNy42IDExLTEzIDIzLjQtMjEgMTEuNi03LjQgMjkuMi0yNC42IDM3LTM2LjQgMi40LTMuOCA3LjgtMTAuMiAxMS44LTEzLjggNi42LTYuNCA3LjItOCA3LjItMTguMiAwLTYuMiAxLjItMTUuOCAyLjgtMjEuMiAxLjYtNS40IDMuNC0xMy44IDQuMi0xOC44IDMuMi0yMS42IDktMjQuMiA1NS40LTIzLjQgMzQuMi40IDM1LjQuNiA0MC40IDUuMnoiLz48L3N2Zz4=);
    }
    
    
    
    
    
    
</style>

        
        <!-- Config CSS -->

<!-- Other Styles -->
<style>
  body, html {
    font-family: Roboto, "Helvetica Neue", Helvetica, "PingFang SC", "Hiragino Sans GB", "Microsoft YaHei", "微软雅黑", Arial, sans-serif;
  }

  a {
    color: #00838F;
  }

  .mdl-card__media,
  #search-label,
  #search-form-label:after,
  #scheme-Paradox .hot_tags-count,
  #scheme-Paradox .sidebar_archives-count,
  #scheme-Paradox .sidebar-colored .sidebar-header,
  #scheme-Paradox .sidebar-colored .sidebar-badge{
    background-color: #0097A7 !important;
  }

  /* Sidebar User Drop Down Menu Text Color */
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:hover,
  #scheme-Paradox .sidebar-colored .sidebar-nav>.dropdown>.dropdown-menu>li>a:focus {
    color: #0097A7 !important;
  }

  #post_entry-right-info,
  .sidebar-colored .sidebar-nav li:hover > a,
  .sidebar-colored .sidebar-nav li:hover > a i,
  .sidebar-colored .sidebar-nav li > a:hover,
  .sidebar-colored .sidebar-nav li > a:hover i,
  .sidebar-colored .sidebar-nav li > a:focus i,
  .sidebar-colored .sidebar-nav > .open > a,
  .sidebar-colored .sidebar-nav > .open > a:hover,
  .sidebar-colored .sidebar-nav > .open > a:focus,
  #ds-reset #ds-ctx .ds-ctx-entry .ds-ctx-head a {
    color: #0097A7 !important;
  }

  .toTop {
    background: #757575 !important;
  }

  .material-layout .material-post>.material-nav,
  .material-layout .material-index>.material-nav,
  .material-nav a {
    color: #757575;
  }

  #scheme-Paradox .MD-burger-layer {
    background-color: #757575;
  }

  #scheme-Paradox #post-toc-trigger-btn {
    color: #757575;
  }

  .post-toc a:hover {
    color: #00838F;
    text-decoration: underline;
  }

</style>


<!-- Theme Background Related-->

    <style>
      body{
        background-color: #F5F5F5;
      }

      /* blog_info bottom background */
      #scheme-Paradox .material-layout .something-else .mdl-card__supporting-text{
        background-color: #fff;
      }
    </style>




<!-- Fade Effect -->

    <style>
      .fade {
        transition: all 800ms linear;
        -webkit-transform: translate3d(0,0,0);
        -moz-transform: translate3d(0,0,0);
        -ms-transform: translate3d(0,0,0);
        -o-transform: translate3d(0,0,0);
        transform: translate3d(0,0,0);
        opacity: 1;
      }

      .fade.out{
        opacity: 0;
      }
    </style>


<!-- Import Font -->

    <link href="https://fonts.googleapis.com/css?family=Roboto:300,400,500" rel="stylesheet">
    <link href="https://fonts.googleapis.com/icon?family=Material+Icons"rel="stylesheet">


        <script>lsloader.load("js/jquery.min.js","/js/jquery.min.js?qcusAULNeBksqffqUM2+Ig==")</script>
    
    
    <script>function Queue(){this.dataStore=[];this.offer=b;this.poll=d;this.execNext=a;this.debug=false;this.startDebug=c;function b(e){if(this.debug){console.log("Offered a Queued Function.")}if(typeof e==="function"){this.dataStore.push(e)}else{console.log("You must offer a function.")}}function d(){if(this.debug){console.log("Polled a Queued Function.")}return this.dataStore.shift()}function a(){var e=this.poll();if(e!==undefined){if(this.debug){console.log("Run a Queued Function.")}e()}}function c(){this.debug=true}}var queue=new Queue();</script>

    <!-- Analytics -->
    

    <!-- Custom Head -->
    
</head>


    
        <body id="scheme-Paradox" class="lazy">
            <div class="material-layout  mdl-js-layout has-drawer is-upgraded">
                

                <!-- Main Container -->
                <main class="material-layout__content" id="main">

                    <!-- Top Anchor -->
                    <div id="top"></div>

                    
                        <!-- Hamburger Button -->
                        <button class="MD-burger-icon sidebar-toggle">
                            <span class="MD-burger-layer"></span>
                        </button>
                    

                    <!-- Post TOC -->

    
    <!-- Back Button -->
    <!--
    <div class="material-back" id="backhome-div" tabindex="0">
        <a class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon"
           href="#" onclick="window.history.back();return false;"
           target="_self"
           role="button"
           data-upgraded=",MaterialButton,MaterialRipple">
            <i class="material-icons" role="presentation">arrow_back</i>
            <span class="mdl-button__ripple-container">
                <span class="mdl-ripple"></span>
            </span>
        </a>
    </div>
    -->

    <!-- Left aligned menu below button -->
    <button id="post-toc-trigger-btn"
        class="mdl-button mdl-js-button mdl-button--icon">
        <i class="material-icons">format_list_numbered</i>
    </button>

    
    <ul class="post-toc-wrap mdl-menu mdl-menu--bottom-left mdl-js-menu mdl-js-ripple-effect" for="post-toc-trigger-btn" style="max-height:80vh; overflow-y:scroll;">
        <ol class="post-toc"><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如何正确的hook方法objc-msgSend"><span class="post-toc-number">1.</span> <span class="post-toc-text">如何正确的hook方法objc_msgSend</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#前言"><span class="post-toc-number">2.</span> <span class="post-toc-text">前言</span></a></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#Hook-思路"><span class="post-toc-number">3.</span> <span class="post-toc-text">Hook 思路</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#ARM64-下-ojbc-msgSend-实现机制"><span class="post-toc-number">3.0.1.</span> <span class="post-toc-text">ARM64 下 ojbc_msgSend 实现机制</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#x64-下-ojbc-msgSend-实现机制"><span class="post-toc-number">3.0.2.</span> <span class="post-toc-text">x64 下 ojbc_msgSend 实现机制</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#构建-fake-objc-msgSend"><span class="post-toc-number">4.</span> <span class="post-toc-text">构建 fake_objc_msgSend</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#构建-hookBefore"><span class="post-toc-number">4.0.1.</span> <span class="post-toc-text">构建 hookBefore</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Macho-的文件解析"><span class="post-toc-number">4.0.2.</span> <span class="post-toc-text">Macho 的文件解析</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#构建-hookAfter"><span class="post-toc-number">4.0.3.</span> <span class="post-toc-text">构建 hookAfter</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#hookBefore-与-hookAfter-的数据传递"><span class="post-toc-number">4.0.4.</span> <span class="post-toc-text">hookBefore 与 hookAfter 的数据传递.</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#x64-层面"><span class="post-toc-number">4.0.4.1.</span> <span class="post-toc-text">x64 层面</span></a></li><li class="post-toc-item post-toc-level-5"><a class="post-toc-link" href="#arm64-层面"><span class="post-toc-number">4.0.4.2.</span> <span class="post-toc-text">arm64 层面</span></a></li></ol></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#如何正确过滤-objc-msgSend"><span class="post-toc-number">5.</span> <span class="post-toc-text">如何正确过滤 objc_msgSend</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#1-过滤函数地址"><span class="post-toc-number">5.0.1.</span> <span class="post-toc-text">1. 过滤函数地址</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-1-设置不解析类-方法"><span class="post-toc-number">5.0.2.</span> <span class="post-toc-text">2.1 设置不解析类/方法</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#2-2-设置只解析的类-方法"><span class="post-toc-number">5.0.3.</span> <span class="post-toc-text">2.2 设置只解析的类/方法</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#3-限制函数调用栈深度"><span class="post-toc-number">5.0.4.</span> <span class="post-toc-text">3. 限制函数调用栈深度</span></a></li><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#4-过滤频繁调用函数-log-monitor-之类"><span class="post-toc-number">5.0.5.</span> <span class="post-toc-text">4. 过滤频繁调用函数 (log, monitor 之类)</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#应用场景"><span class="post-toc-number">6.</span> <span class="post-toc-text">应用场景</span></a><ol class="post-toc-child"><li class="post-toc-item post-toc-level-4"><a class="post-toc-link" href="#Thunder-逆向"><span class="post-toc-number">6.0.1.</span> <span class="post-toc-text">Thunder 逆向</span></a></li></ol></li></ol></li><li class="post-toc-item post-toc-level-2"><a class="post-toc-link" href="#参考资料"><span class="post-toc-number">7.</span> <span class="post-toc-text">参考资料</span></a></li></ol>
        <!--
        <li class="mdl-menu__item">
            Some Action
        </li>
        -->
    </ul>
    





<!-- Layouts -->

    <!-- Post Module -->
    <div class="material-post_container">

        <div class="material-post mdl-grid">
            <div class="mdl-card mdl-shadow--4dp mdl-cell mdl-cell--12-col">

                <!-- Post Header(Thumbnail & Title) -->
                
    <!-- Paradox Post Header -->
    
        
            <!-- Random Thumbnail -->
            <div class="post_thumbnail-random mdl-card__media mdl-color-text--grey-50">
            <script type="text/ls-javascript" id="post-thumbnail-script">
    var randomNum = Math.floor(Math.random() * 19 + 1);

    $('.post_thumbnail-random').attr('data-original', '/img/random/material-' + randomNum + '.png');
    $('.post_thumbnail-random').addClass('lazy');
</script>

        
    
            <p class="article-headline-p">
                如何正确的hook方法objc_msgSend
            </p>
        </div>





                
                    <!-- Paradox Post Info -->
                    <div class="mdl-color-text--grey-700 mdl-card__supporting-text meta">

    <!-- Author Avatar -->
    <div id="author-avatar">
        <img src="/img/avatar.png" width="44px" height="44px" alt="Author Avatar"/>
    </div>
    <!-- Author Name & Date -->
    <div>
        <strong>jmpews</strong>
        <span>May 01, 2017</span>
    </div>

    <div class="section-spacer"></div>

    <!-- Favorite -->
    <!--
        <button id="article-functions-like-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon btn-like">
            <i class="material-icons" role="presentation">favorite</i>
            <span class="visuallyhidden">favorites</span>
        </button>
    -->

    <!-- Qrcode -->
    

    <!-- Tags (bookmark) -->
    
    <button id="article-functions-viewtags-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
        <i class="material-icons" role="presentation">bookmark</i>
        <span class="visuallyhidden">bookmark</span>
    </button>
    <ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-functions-viewtags-button">
        <li class="mdl-menu__item">
        <a class="post_tag-link" href="/tags/darwin/">darwin</a></li><li class="mdl-menu__item"><a class="post_tag-link" href="/tags/macho/">macho</a>
    </ul>
    

    <!-- Share -->
    <button id="article-fuctions-share-button" class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon">
    <i class="material-icons" role="presentation">share</i>
    <span class="visuallyhidden">share</span>
</button>
<ul class="mdl-menu mdl-menu--bottom-right mdl-js-menu mdl-js-ripple-effect" for="article-fuctions-share-button">
    

    

    <!-- Share Weibo -->
    
        <a class="post_share-link" href="http://service.weibo.com/share/share.php?appkey=&title=如何正确的hook方法objc_msgSend&url=http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html&pic=&searchPic=false&style=simple" target="_blank">
            <li class="mdl-menu__item">
                Share to Weibo
            </li>
        </a>
    

    <!-- Share Twitter -->
    
        <a class="post_share-link" href="https://twitter.com/intent/tweet?text=如何正确的hook方法objc_msgSend&url=http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html&via=jmpews" target="_blank">
            <li class="mdl-menu__item">
                Share to Twitter
            </li>
        </a>
    

    <!-- Share Facebook -->
    
        <a class="post_share-link" href="https://www.facebook.com/sharer/sharer.php?u=http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Facebook
            </li>
        </a>
    

    <!-- Share Google+ -->
    
        <a class="post_share-link" href="https://plus.google.com/share?url=http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/index.html" target="_blank">
            <li class="mdl-menu__item">
                Share to Google+
            </li>
        </a>
    

    <!-- Share LinkedIn -->
    

    <!-- Share QQ -->
    

    <!-- Share Telegram -->
    
</ul>

</div>

                

                <!-- Post Content -->
                <div id="post-content" class="mdl-color-text--grey-700 mdl-card__supporting-text fade out">
    
        <h2 id="如何正确的hook方法objc-msgSend"><a href="#如何正确的hook方法objc-msgSend" class="headerlink" title="如何正确的hook方法objc_msgSend"></a>如何正确的hook方法objc_msgSend</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果希望对 Objective-C 的方法调用进行 log, 一个很好的解决方法就是 hook 方法 <code>objc_msgSend</code>, 当然想到的就是利用 InlinkHook 直接 hook 完事, 然而 <code>objc_msgSend</code> 是一个可变参数函数, 这就有点蛋疼了.</p>
<p> <code>objc4-680</code>, 和目前的 <code>objc4-709</code> 没有有很大出入. </p>
<p>以下 在举例 arm 相关时使用 <code>objc4-680</code>, 说明 x64 时使用 <code>objc4-709</code></p>
<p>整个代码使用 c++, 所以有些地方需要参考 objc 的源码去造一个轮子, 比如 <code>object_getClass</code> 等.</p>
<p>这篇文章假设读者对以下有了解.</p>
<ol>
<li>OC 类的内存布局模型</li>
<li>OC 实例的内存布局模型</li>
<li>OC 函数调用与消息传递机制</li>
<li>macho 文件格式</li>
<li>基本 x64, arm 汇编指令</li>
<li>函数调用与参数传递的 x64, arm 汇编实现机制(函数调用约定)</li>
<li>inlinehook 机制</li>
</ol>
<h2 id="Hook-思路"><a href="#Hook-思路" class="headerlink" title="Hook 思路"></a>Hook 思路</h2><p>这里首先明确, objc_msgSend 的第三个参数是不定参数, 无法确定 <code>objc_msgSend</code> 的具体函数签名, 也就无法通过传参来调用原函数, 所以只能上暴力的方法, 通过保存/恢复栈和寄存器方法调用原函数, 之后在汇编指令中实现原函数的跳转调用.</p>
<p> <code>objc_msgSend</code> 的函数声明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// runtime/message.h</div><div class="line">OBJC_EXPORT id objc_msgSend(id self, SEL op, ...)</div></pre></td></tr></table></figure>
<p><code>objc_msgSend</code> 的函数实现, 这里以 x64 和 arm64 举例.</p>
<h4 id="ARM64-下-ojbc-msgSend-实现机制"><a href="#ARM64-下-ojbc-msgSend-实现机制" class="headerlink" title="ARM64 下 ojbc_msgSend 实现机制"></a>ARM64 下 ojbc_msgSend 实现机制</h4><p> <code>_objc_msgSend</code> 首先会取得基本的参数, 比如 isa, class, 之后会使用宏 <code>CacheLookup</code> 先进行缓存查找, 如果没有命中, 会触发 <code>JumpMiss</code> 宏处理, 跳转到 <code>__objc_msgSend_uncached_impcache</code>, 这个方法是了解如何正确 hook 的关键.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">	ENTRY _objc_msgSend</div><div class="line">	MESSENGER_START</div><div class="line"></div><div class="line">	cmp	x0, #0			// nil check and tagged pointer check</div><div class="line">	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)</div><div class="line">	ldr	x13, [x0]		// x13 = isa</div><div class="line">	and	x9, x13, #ISA_MASK	// x9 = class	</div><div class="line">LGetIsaDone:</div><div class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">// objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">.macro JumpMiss</div><div class="line">.if $0 == NORMAL</div><div class="line">	b	__objc_msgSend_uncached_impcache</div><div class="line">.else</div><div class="line">	b	LGetImpMiss</div><div class="line">.endif</div><div class="line">.endmacro</div><div class="line"></div><div class="line">.macro CacheLookup</div><div class="line">	// x1 = SEL, x9 = isa</div><div class="line">	ldp	x10, x11, [x9, #CACHE]	// x10 = buckets, x11 = occupied|mask</div><div class="line">	and	w12, w1, w11		// x12 = _cmd &amp; mask</div><div class="line">	add	x12, x10, x12, LSL #4	// x12 = buckets + ((_cmd &amp; mask)&lt;&lt;4)</div><div class="line"></div><div class="line">	ldp	x16, x17, [x12]		// &#123;x16, x17&#125; = *bucket</div><div class="line">1:	cmp	x16, x1			// if (bucket-&gt;sel != _cmd)</div><div class="line">	b.ne	2f			//     scan more</div><div class="line">	CacheHit $0			// call or return imp</div><div class="line">	</div><div class="line">2:	// not hit: x12 = not-hit bucket</div><div class="line">	CheckMiss $0			// miss if bucket-&gt;cls == 0</div><div class="line">	cmp	x12, x10		// wrap if bucket == buckets</div><div class="line">	b.eq	3f</div><div class="line">	ldp	x16, x17, [x12, #-16]!	// &#123;x16, x17&#125; = *--bucket</div><div class="line">	b	1b			// loop</div><div class="line"></div><div class="line">3:	// wrap: x12 = first bucket, w11 = mask</div><div class="line">	add	x12, x12, w11, UXTW #4	// x12 = buckets+(mask&lt;&lt;4)</div><div class="line"></div><div class="line">	// Clone scanning loop to miss instead of hang when cache is corrupt.</div><div class="line">	// The slow path may detect any corruption and halt later.</div><div class="line"></div><div class="line">	ldp	x16, x17, [x12]		// &#123;x16, x17&#125; = *bucket</div><div class="line">1:	cmp	x16, x1			// if (bucket-&gt;sel != _cmd)</div><div class="line">	b.ne	2f			//     scan more</div><div class="line">	CacheHit $0			// call or return imp</div><div class="line">	</div><div class="line">2:	// not hit: x12 = not-hit bucket</div><div class="line">	CheckMiss $0			// miss if bucket-&gt;cls == 0</div><div class="line">	cmp	x12, x10		// wrap if bucket == buckets</div><div class="line">	b.eq	3f</div><div class="line">	ldp	x16, x17, [x12, #-16]!	// &#123;x16, x17&#125; = *--bucket</div><div class="line">	b	1b			// loop</div><div class="line"></div><div class="line">3:	// double wrap</div><div class="line">	JumpMiss $0</div><div class="line">	</div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<p>具体解析下 <code>__objc_msgSend_uncached_impcache</code>  这个函数, 在函数入口保存寄存器和返回地址, 在调用 <code>__class_lookupMethodAndLoadCache3</code> 之后进行恢复. <code>__class_lookupMethodAndLoadCache3</code> 函数返回需要调用函数的地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"> // objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">STATIC_ENTRY __objc_msgSend_uncached_impcache</div><div class="line"></div><div class="line">// THIS IS NOT A CALLABLE C FUNCTION</div><div class="line">// Out-of-band x9 is the class to search</div><div class="line"></div><div class="line">MESSENGER_START</div><div class="line"></div><div class="line">// push frame</div><div class="line">stp	fp, lr, [sp, #-16]!</div><div class="line">mov	fp, sp</div><div class="line"></div><div class="line">MESSENGER_END_SLOW</div><div class="line"></div><div class="line">// save parameter registers: x0..x8, q0..q7</div><div class="line">sub	sp, sp, #(10*8 + 8*16)</div><div class="line">stp	q0, q1, [sp, #(0*16)]</div><div class="line">stp	q2, q3, [sp, #(2*16)]</div><div class="line">stp	q4, q5, [sp, #(4*16)]</div><div class="line">stp	q6, q7, [sp, #(6*16)]</div><div class="line">stp	x0, x1, [sp, #(8*16+0*8)]</div><div class="line">stp	x2, x3, [sp, #(8*16+2*8)]</div><div class="line">stp	x4, x5, [sp, #(8*16+4*8)]</div><div class="line">stp	x6, x7, [sp, #(8*16+6*8)]</div><div class="line">str	x8,     [sp, #(8*16+8*8)]</div><div class="line"></div><div class="line">// receiver and selector already in x0 and x1</div><div class="line">mov	x2, x9</div><div class="line">bl	__class_lookupMethodAndLoadCache3</div><div class="line"></div><div class="line">// imp in x0</div><div class="line">mov	x17, x0</div><div class="line"></div><div class="line">// restore registers and return</div><div class="line">ldp	q0, q1, [sp, #(0*16)]</div><div class="line">ldp	q2, q3, [sp, #(2*16)]</div><div class="line">ldp	q4, q5, [sp, #(4*16)]</div><div class="line">ldp	q6, q7, [sp, #(6*16)]</div><div class="line">ldp	x0, x1, [sp, #(8*16+0*8)]</div><div class="line">ldp	x2, x3, [sp, #(8*16+2*8)]</div><div class="line">ldp	x4, x5, [sp, #(8*16+4*8)]</div><div class="line">ldp	x6, x7, [sp, #(8*16+6*8)]</div><div class="line">ldr	x8,     [sp, #(8*16+8*8)]</div><div class="line"></div><div class="line">mov	sp, fp</div><div class="line">ldp	fp, lr, [sp], #16</div><div class="line"></div><div class="line">br	x17</div><div class="line"></div><div class="line">END_ENTRY __objc_msgSend_uncached_impcache</div></pre></td></tr></table></figure>
<p>举个例子演示下, 这里可以仔细观察 lldb 的输出.</p>
<p><img src="/images/debug-objc_msgSend.png" alt=""></p>
<h4 id="x64-下-ojbc-msgSend-实现机制"><a href="#x64-下-ojbc-msgSend-实现机制" class="headerlink" title="x64 下 ojbc_msgSend 实现机制"></a>x64 下 ojbc_msgSend 实现机制</h4><p>整体思路与 arm64 类似, 但几个关键部分不同, 这里主要关注 <code>GetIsaFast</code> 和 <code>MethodTableLookup</code>, <code>MethodTableLookup</code> 是在缓存中没有命中时进行查找.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">objc4-709/runtime/Messengers.subproj/objc-msg-x86_64.s</div><div class="line">ENTRY _objc_msgSend</div><div class="line">UNWIND _objc_msgSend, NoFrame</div><div class="line">MESSENGER_START</div><div class="line"></div><div class="line">NilTest	NORMAL</div><div class="line"></div><div class="line">GetIsaFast NORMAL		// r10 = self-&gt;isa</div><div class="line">CacheLookup NORMAL, CALL	// calls IMP on success</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">objc4-709/runtime/Messengers.subproj/objc-msg-x86_64.s</div><div class="line">.macro GetIsaFast</div><div class="line">.if $0 != STRET</div><div class="line">	testb	$$1, %a1b</div><div class="line">	PN</div><div class="line">	jnz	LGetIsaSlow_f</div><div class="line">	movq	$$0x00007ffffffffff8, %r10</div><div class="line">	andq	(%a1), %r10</div><div class="line">.else</div><div class="line">	testb	$$1, %a2b</div><div class="line">	PN</div><div class="line">	jnz	LGetIsaSlow_f</div><div class="line">	movq	$$0x00007ffffffffff8, %r10</div><div class="line">	andq	(%a2), %r10</div><div class="line">.endif</div><div class="line">LGetIsaDone:	</div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<p>这里需要关注 x64 保存和恢复参数的操作, 特别是这里的栈对齐.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">objc4-709/runtime/Messengers.subproj/objc-msg-x86_64.s</div><div class="line">.macro MethodTableLookup</div><div class="line"></div><div class="line">	push	%rbp</div><div class="line">	mov	%rsp, %rbp</div><div class="line">	</div><div class="line">	sub	$$0x80+8, %rsp		// +8 for alignment</div><div class="line"></div><div class="line">	movdqa	%xmm0, -0x80(%rbp)</div><div class="line">	push	%rax			// might be xmm parameter count</div><div class="line">	movdqa	%xmm1, -0x70(%rbp)</div><div class="line">	push	%a1</div><div class="line">	movdqa	%xmm2, -0x60(%rbp)</div><div class="line">	push	%a2</div><div class="line">	movdqa	%xmm3, -0x50(%rbp)</div><div class="line">	push	%a3</div><div class="line">	movdqa	%xmm4, -0x40(%rbp)</div><div class="line">	push	%a4</div><div class="line">	movdqa	%xmm5, -0x30(%rbp)</div><div class="line">	push	%a5</div><div class="line">	movdqa	%xmm6, -0x20(%rbp)</div><div class="line">	push	%a6</div><div class="line">	movdqa	%xmm7, -0x10(%rbp)</div><div class="line"></div><div class="line">	// _class_lookupMethodAndLoadCache3(receiver, selector, class)</div><div class="line"></div><div class="line">.if $0 == NORMAL</div><div class="line">	// receiver already in a1</div><div class="line">	// selector already in a2</div><div class="line">.else</div><div class="line">	movq	%a2, %a1</div><div class="line">	movq	%a3, %a2</div><div class="line">.endif</div><div class="line">	movq	%r10, %a3</div><div class="line">	call	__class_lookupMethodAndLoadCache3</div><div class="line"></div><div class="line">	// IMP is now in %rax</div><div class="line">	movq	%rax, %r11</div><div class="line"></div><div class="line">	movdqa	-0x80(%rbp), %xmm0</div><div class="line">	pop	%a6</div><div class="line">	movdqa	-0x70(%rbp), %xmm1</div><div class="line">	pop	%a5</div><div class="line">	movdqa	-0x60(%rbp), %xmm2</div><div class="line">	pop	%a4</div><div class="line">	movdqa	-0x50(%rbp), %xmm3</div><div class="line">	pop	%a3</div><div class="line">	movdqa	-0x40(%rbp), %xmm4</div><div class="line">	pop	%a2</div><div class="line">	movdqa	-0x30(%rbp), %xmm5</div><div class="line">	pop	%a1</div><div class="line">	movdqa	-0x20(%rbp), %xmm6</div><div class="line">	pop	%rax</div><div class="line">	movdqa	-0x10(%rbp), %xmm7</div><div class="line"></div><div class="line">.if $0 == NORMAL</div><div class="line">	cmp	%r11, %r11		// set eq for nonstret forwarding</div><div class="line">.else</div><div class="line">	test	%r11, %r11		// set ne for stret forwarding</div><div class="line">.endif</div><div class="line">	</div><div class="line">	leave</div><div class="line"></div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<h2 id="构建-fake-objc-msgSend"><a href="#构建-fake-objc-msgSend" class="headerlink" title="构建 fake_objc_msgSend"></a>构建 fake_objc_msgSend</h2><p>在了解了 objc_msgSend 的流程, 接下来构建 <code>fake_objc_msgSend</code>, 需要保存保存寄存器状态, 以正确调用原 <code>objc_msgSend</code>, 这里解释下为什么需要保存寄存器状态, 因为参数个数不定, 所以可能会同时用到多个寄存器和栈来同时传参, 所以这里需要将可能会用到的所有寄存器以及 sp 都保存, 以确保多参数不被修改. 其实把这里的保护寄存器实现在 hook 层可能会更好一些. 最终通过把寄存器参数保存在栈中, 并以栈指针作为参数, 传给 <code>hookBefore</code>, 实现函数参数的完全访问.</p>
<p>ok, 说完了函数的参数(寄存器)保存和恢复部分, 接下来谈一谈函数调用栈的问题.</p>
<ol>
<li>限制函数调用栈深度</li>
<li>记录函数调用的返回值</li>
</ol>
<p>问题 1, 比较好理解. 问题 2, 如果需要记录函数返回值, 并且过滤了部分的函数记录, 必须要保证 <code>hookBefore</code> 和 <code>hookAfter</code> 是对于同一个 <code>函数</code> 做的处理, 所以这里需要自建函数调用栈以及标记 <code>函数</code> , 也就是说必须要保证自建的调用栈的 push 和 pop 操作必须对应, 这一点 InspectiveC 不同, 它是直接跟踪所有函数入栈(依赖系统标准函数栈的准确). 这里使用 <code>sp</code> 寄存器做标记区分函数(关于为何使用 <code>sp</code> 寄存器做标记区分, 希望读者能自己仔细思考函数调用本质), 以确保 push 和 pop 的对应正确.</p>
<p>这里总结一下 fake_objc_msgSend_safe 的工作</p>
<ol>
<li>保存寄存器/参数</li>
<li>hookBefore 工作(过滤/判断 <code>调用的函数</code>)</li>
<li>恢复寄存器/参数</li>
<li>如果经过判断不需要追踪, 则直接调用原 ojbc_msgSend</li>
<li>如果需要追踪, 则修改默认栈内保存的返回地址后, 继续调用 objc_msgSend (这里涉及到 trick)</li>
<li>保存寄存器/参数</li>
<li>hookAfter 工作(解析返回值, 函数调用出栈, 确保两次  <code>sp</code> 值相同)</li>
<li>恢复寄存器/参数</li>
<li>ret</li>
</ol>
<p>下面列出 fake_objc_msgSend_safe 的核心代码. </p>
<p>这里关于调用栈的操作主要放在 <code>hookBefore</code> 和 <code>hookAfter</code>, 关于在内联汇编中调用 C 函数这里也使用了两种方法, 一种使用 <code>nm</code> 导出符号, 一种使用内联汇编传参. </p>
<p>这里关于寄存器的使用与污染问题, 请查阅相关资料或参考下方参考资料, 以了解寄存器使用约定.</p>
<p>这里关于如何获取到汇编的下一条指令地址的 trick, 可以参考 <code>&lt;程序员自我修养&gt;</code> 中地址无关代码中使用到的 <code>get_pc_thunk</code>.</p>
<p>使用 ‘横线’ 分割了 <code>hookBefore</code> 和 <code>hookAfter</code> 相关处理代码, 大部分代码我都已经加了注释.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">__attribute__((__naked__)) static void fake_objc_msgSend_safe()</div><div class="line">&#123;</div><div class="line">    // test for direct jmp</div><div class="line">    // __asm__ volatile(</div><div class="line">    //     "jmpq *%0\n":</div><div class="line">    //     : "r" (orig_objc_msgSend)</div><div class="line">    //     :);</div><div class="line">    // backup registers</div><div class="line">    __asm__ volatile(</div><div class="line">        "subq $(16*8+8), %%rsp\n" // +8 for alignment</div><div class="line"></div><div class="line">        "movdqa	%%xmm0, (%%rsp)\n"</div><div class="line">        "movdqa	%%xmm1, 0x10(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm2, 0x20(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm3, 0x30(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm4, 0x40(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm5, 0x50(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm6, 0x60(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm7, 0x70(%%rsp)\n"</div><div class="line"></div><div class="line">        "pushq %%rax\n" // stack align</div><div class="line"></div><div class="line">        "pushq %%r9\n" // might be xmm parameter count</div><div class="line">        "pushq %%r8\n"</div><div class="line">        "pushq %%rcx\n"</div><div class="line">        "pushq %%rdx\n"</div><div class="line">        "pushq %%rsi\n"</div><div class="line">        "pushq %%rdi\n"</div><div class="line">        "pushq %%rax\n"</div><div class="line"></div><div class="line">        // origin rsp, contain `ret address`, how to use leaq, always wrong.</div><div class="line">        "movq %%rsp, %%rax\n"</div><div class="line">        "addq $(16*8+8+8+7*8), %%rax\n"</div><div class="line">        "pushq (%%rax)\n"</div><div class="line">        "pushq %%rax\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // prepare args for func</div><div class="line">    __asm__ volatile(</div><div class="line">        "movq %%rsp, %%rdi\n"</div><div class="line">        "callq __Z10hookBeforeP9RegState_\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // get value from `ReturnPayload`</div><div class="line">    __asm__ volatile(</div><div class="line">        "movq (%%rax), %%r10\n"</div><div class="line">        "movq 8(%%rax), %%r11\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // restore registers</div><div class="line">    __asm__ volatile(</div><div class="line"></div><div class="line">        "popq %%rax\n"</div><div class="line">        "popq (%%rax)\n"</div><div class="line"></div><div class="line">        "popq	%%rax\n"</div><div class="line">        "popq	%%rdi\n"</div><div class="line">        "popq	%%rsi\n"</div><div class="line">        "popq	%%rdx\n"</div><div class="line">        "popq	%%rcx\n"</div><div class="line">        "popq	%%r8\n"</div><div class="line">        "popq	%%r9\n"</div><div class="line"></div><div class="line">        "popq %%rax\n" // stack align</div><div class="line"></div><div class="line">        "movdqa	(%%rsp), %%xmm0\n"</div><div class="line">        "movdqa	0x10(%%rsp), %%xmm1\n"</div><div class="line">        "movdqa	0x20(%%rsp), %%xmm2\n"</div><div class="line">        "movdqa	0x30(%%rsp), %%xmm3\n"</div><div class="line">        "movdqa	0x40(%%rsp), %%xmm4\n"</div><div class="line">        "movdqa	0x50(%%rsp), %%xmm5\n"</div><div class="line">        "movdqa	0x60(%%rsp), %%xmm6\n"</div><div class="line">        "movdqa	0x70(%%rsp), %%xmm7\n"</div><div class="line"></div><div class="line">        "addq $(16*8+8), %%rsp\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // go to the original objc_msgSend</div><div class="line">    __asm__ volatile(</div><div class="line">        // "br x9\n"</div><div class="line">        "cmpq $0, %%r11\n"</div><div class="line">        "jne Lthroughx\n"</div><div class="line">        "jmpq *%%r10\n"</div><div class="line">        "Lthroughx:\n"</div><div class="line"></div><div class="line">        // trick to jmp</div><div class="line">        "jmp NextInstruction\n"</div><div class="line">        "Begin:\n"</div><div class="line">        "popq %%r11\n"</div><div class="line">        "movq %%r11, (%%rsp)\n"</div><div class="line">        "jmpq *%%r10\n"</div><div class="line">        "NextInstruction:\n"</div><div class="line">        "call Begin" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    //-----------------------------------------------------------------------------</div><div class="line">    // after objc_msgSend we parse the result.</div><div class="line"></div><div class="line">    // backup registers</div><div class="line">    __asm__ volatile(</div><div class="line">        "pushq %%r10\n" // stack align</div><div class="line"></div><div class="line">        "push	%%rbp\n"</div><div class="line">        "movq	%%rsp, %%rbp\n"</div><div class="line"></div><div class="line">        "subq	$(16*8), %%rsp\n" // +8 for alignment</div><div class="line"></div><div class="line">        "movdqa	%%xmm0, -0x80(%%rbp)\n"</div><div class="line">        "push	%%r9\n" // might be xmm parameter count</div><div class="line">        "movdqa	%%xmm1, -0x70(%%rbp)\n"</div><div class="line">        "push	%%r8\n"</div><div class="line">        "movdqa	%%xmm2, -0x60(%%rbp)\n"</div><div class="line">        "push	%%rcx\n"</div><div class="line">        "movdqa	%%xmm3, -0x50(%%rbp)\n"</div><div class="line">        "push	%%rdx\n"</div><div class="line">        "movdqa	%%xmm4, -0x40(%%rbp)\n"</div><div class="line">        "push	%%rsi\n"</div><div class="line">        "movdqa	%%xmm5, -0x30(%%rbp)\n"</div><div class="line">        "push	%%rdi\n"</div><div class="line">        "movdqa	%%xmm6, -0x20(%%rbp)\n"</div><div class="line">        "push	%%rax\n"</div><div class="line">        "movdqa	%%xmm7, -0x10(%%rbp)\n"</div><div class="line"></div><div class="line">        "pushq 0x8(%%rbp)\n"</div><div class="line">        "movq %%rbp, %%rax\n"</div><div class="line">        "addq $8, %%rax\n"</div><div class="line">        "pushq %%rax\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // prepare args for func</div><div class="line">    __asm__ volatile(</div><div class="line">        "movq %%rsp, %%rdi\n"</div><div class="line">        // "callq __Z9hookAfterP9RegState_\n"</div><div class="line">        "callq *%0\n"</div><div class="line">        "movq %%rax, %%r10\n"</div><div class="line">        :</div><div class="line">        : "r"(func_ptr)</div><div class="line">        : "%rax");</div><div class="line"></div><div class="line">    // restore registers</div><div class="line">    __asm__ volatile(</div><div class="line">        "pop %%rax\n"</div><div class="line">        "pop 8(%%rbp)\n"</div><div class="line"></div><div class="line">        "movdqa	-0x80(%%rbp), %%xmm0\n"</div><div class="line">        "pop	%%rax\n"</div><div class="line">        "movdqa	-0x70(%%rbp), %%xmm1\n"</div><div class="line">        "pop	%%rdi\n"</div><div class="line">        "movdqa	-0x60(%%rbp), %%xmm2\n"</div><div class="line">        "pop	%%rsi\n"</div><div class="line">        "movdqa	-0x50(%%rbp), %%xmm3\n"</div><div class="line">        "pop	%%rdx\n"</div><div class="line">        "movdqa	-0x40(%%rbp), %%xmm4\n"</div><div class="line">        "pop	%%rcx\n"</div><div class="line">        "movdqa	-0x30(%%rbp), %%xmm5\n"</div><div class="line">        "pop	%%r8\n"</div><div class="line">        "movdqa	-0x20(%%rbp), %%xmm6\n"</div><div class="line">        "pop	%%r9\n"</div><div class="line">        "movdqa	-0x10(%%rbp), %%xmm7\n"</div><div class="line">        "leave\n"</div><div class="line"></div><div class="line">        // go to the original objc_msgSend</div><div class="line">        "movq %%r10, (%%rsp)\n"</div><div class="line">        "ret\n" ::</div><div class="line">            :);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然现在已经可以 hook 到 objc_msgSend.</p>
<p>利用下面的数据结构获取之前保存在栈中的参数, ps: 这个结构是参考 InspectiveC, 实现的很精巧, 在此基础上做了一些修改.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt; // uint64_t</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line">    -ARM64</div><div class="line">    http://infocenter.arm.com/help/topic/com.arm.doc.den0024a/DEN0024A_v8_architecture_PG.pdf (7.2.1 Floating-point) (4.6.1 Floating-point register organization in AArch64)</div><div class="line">    use struct and union to describe diagram in the above link, nice!</div><div class="line"></div><div class="line">    -X86</div><div class="line">    https://en.wikipedia.org/wiki/X86_calling_conventions</div><div class="line">    RDI, RSI, RDX, RCX, R8, R9, XMM0–7</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">// x86_64 is XMM, arm64 is q</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> FPMReg_ &#123;</div><div class="line">    <span class="keyword">__int128_t</span> q;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">double</span> d1; <span class="comment">// Holds the double (LSB).</span></div><div class="line">        <span class="keyword">double</span> d2;</div><div class="line">    &#125; d;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">float</span> f1; <span class="comment">// Holds the float (LSB).</span></div><div class="line">        <span class="keyword">float</span> f2;</div><div class="line">        <span class="keyword">float</span> f3;</div><div class="line">        <span class="keyword">float</span> f4;</div><div class="line">    &#125; f;</div><div class="line">&#125; FPReg;</div><div class="line"></div><div class="line"><span class="comment">// just ref how to backup/restore registers</span></div><div class="line"><span class="keyword">struct</span> RegState_ &#123;</div><div class="line">    <span class="keyword">uint64_t</span> bp;</div><div class="line">    <span class="keyword">uint64_t</span> ret;</div><div class="line"></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">uint64_t</span> arr[<span class="number">7</span>];</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="keyword">uint64_t</span> rax;</div><div class="line">            <span class="keyword">uint64_t</span> rdi;</div><div class="line">            <span class="keyword">uint64_t</span> rsi;</div><div class="line">            <span class="keyword">uint64_t</span> rdx;</div><div class="line">            <span class="keyword">uint64_t</span> rcx;</div><div class="line">            <span class="keyword">uint64_t</span> r8;</div><div class="line">            <span class="keyword">uint64_t</span> r9;</div><div class="line">        &#125; regs;</div><div class="line">    &#125; general;</div><div class="line"></div><div class="line">    <span class="keyword">uint64_t</span> _; <span class="comment">// for align</span></div><div class="line">    </div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        FPReg arr[<span class="number">8</span>];</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            FPReg xmm0;</div><div class="line">            FPReg xmm1;</div><div class="line">            FPReg xmm2;</div><div class="line">            FPReg xmm3;</div><div class="line">            FPReg xmm4;</div><div class="line">            FPReg xmm5;</div><div class="line">            FPReg xmm6;</div><div class="line">            FPReg xmm7;</div><div class="line">        &#125; regs;</div><div class="line">    &#125; floating;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> pa_list_ &#123;</div><div class="line">    <span class="keyword">struct</span> RegState_ *regs; <span class="comment">// Registers saved when function is called.</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="built_in">stack</span>; <span class="comment">// Address of current argument.</span></div><div class="line">    <span class="keyword">int</span> ngrn; <span class="comment">// The Next General-purpose Register Number.</span></div><div class="line">    <span class="keyword">int</span> nsrn; <span class="comment">// The Next SIMD and Floating-point Register Number.</span></div><div class="line">&#125; pa_list;</div></pre></td></tr></table></figure>
<h4 id="构建-hookBefore"><a href="#构建-hookBefore" class="headerlink" title="构建 hookBefore"></a>构建 hookBefore</h4><p><code>hookBefore</code> 实现了函数调用前的 trace 工作, 过滤 <code>函数</code>, 将 <code>函数</code> 压进调用栈, 解析类实例对象, 解析不定参数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">    arg1: object-address(need to parse &gt;&gt; class)</div><div class="line">    arg2: method string address</div><div class="line">    arg3: method signature</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="keyword">vm_address_t</span> hookBefore(<span class="keyword">struct</span> RegState_ *rs)</div><div class="line">&#123;</div><div class="line">    gettimeofday(&amp;start,<span class="literal">NULL</span>);</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> parse args</span></div><div class="line">    pa_list args = (pa_list)&#123;</div><div class="line">        rs,</div><div class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span> *&gt;(rs-&gt;bp),</div><div class="line">        <span class="number">2</span>,</div><div class="line">        <span class="number">0</span>&#125;;</div><div class="line"></div><div class="line">    ThreadCallStack *cs = getThreadCallStack(threadKey);</div><div class="line"></div><div class="line">    ReturnPayload *rp = cs-&gt;rp;</div><div class="line"></div><div class="line">    <span class="keyword">vm_address_t</span> xaddr = (<span class="keyword">uint64_t</span>)orig_objc_msgSend;</div><div class="line">    rp-&gt;addr = xaddr;</div><div class="line">    rp-&gt;ret = rs-&gt;ret;</div><div class="line">    rp-&gt;bp = rs-&gt;bp;</div><div class="line">    rp-&gt;isTrace = <span class="number">0</span>;</div><div class="line">    rp-&gt;key = rs-&gt;ret &amp; rs-&gt;bp;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> || pthread_main_np())</div><div class="line">    &#123;</div><div class="line">        <span class="comment">/* </span></div><div class="line">            pay attention!!! as `objc_msgSend` invoked so often, the `filter` code snippet that use `c` to write it must be fast!!!.</div><div class="line">        */</div><div class="line">        <span class="keyword">do</span></div><div class="line">        &#123;   </div><div class="line">            <span class="comment">// check method string address, can be narrow the scope.</span></div><div class="line">            <span class="keyword">char</span> *methodSelector = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span> *&gt;(rs-&gt;general.regs.rsi);</div><div class="line">            <span class="keyword">if</span>(!(methodSelector &amp;&amp; checkAddressRange((<span class="keyword">vm_address_t</span>)methodSelector, macho_load_addr, macho_load_end_addr)))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// check object's class address</span></div><div class="line">            <span class="keyword">vm_address_t</span> class_addr = macho_objc_getClass(rs-&gt;general.regs.rdi);</div><div class="line">            <span class="keyword">if</span> (!(class_addr &amp;&amp; checkAddressRange(class_addr, macho_load_addr, macho_load_end_addr)))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// check `call count filter`</span></div><div class="line">            <span class="keyword">if</span>(check_freq_filter((<span class="keyword">unsigned</span> <span class="keyword">long</span>)methodSelector))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">            <span class="comment">// // test for wechat</span></div><div class="line">            <span class="comment">// if(!strncmp(methodSelector, "onRevokeMsg", 9))</span></div><div class="line">            <span class="comment">//     debug_break();</span></div><div class="line"></div><div class="line">            <span class="comment">// check exclude</span></div><div class="line">            <span class="comment">// check method_name first, no need parse object.</span></div><div class="line">            <span class="keyword">if</span> (!checkLogFilters_MethodName(<span class="literal">NULL</span>, methodSelector, FT_EXINLUDE))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">objc_class_info_t</span> *xobjc_class_info;</div><div class="line">            xobjc_class_info = mem-&gt;parse_OBJECT(rs-&gt;general.regs.rdi);</div><div class="line">            <span class="keyword">if</span>(!xobjc_class_info)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">            <span class="comment">// check class name, need parse object</span></div><div class="line">            <span class="keyword">if</span> (!checkLogFilters_ClassName(xobjc_class_info-&gt;class_name, <span class="literal">NULL</span>, FT_EXINLUDE))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">objc_method_info_t</span> * objc_method_info;</div><div class="line">            objc_method_info = search_method_name(&amp;(xobjc_class_info-&gt;methods), methodSelector);</div><div class="line">            <span class="keyword">if</span> (!objc_method_info)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(check_thread_filter(cs-&gt;thread))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// add to `method call count cache`</span></div><div class="line">            add_freq_filter((<span class="keyword">unsigned</span> <span class="keyword">long</span>)methodSelector, objc_method_info);</div><div class="line"></div><div class="line">            <span class="comment">// may be can pass into 'objc_method_info_t' without 'class_name' and 'method_name'</span></div><div class="line">            CallRecord *cr = pushCallRecord(xobjc_class_info-&gt;class_name, methodSelector, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> *&gt;(rs-&gt;bp), <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> *&gt;(rs-&gt;ret), cs);</div><div class="line">            <span class="keyword">if</span>(!cr)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            printCallRcord(cr, cs);</div><div class="line">            rp-&gt;isTrace = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">while</span>(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    gettimeofday(&amp;end,<span class="literal">NULL</span>);</div><div class="line">    time_cost += (end.tv_sec-start.tv_sec)+(end.tv_usec-start.tv_usec)/<span class="number">1000000.0</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(rp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>hookBefore 的参数其实之前备份寄存器后的 sp 地址, 再通过 <code>RegState_</code> 格式, 就可以取得所有寄存器的值. <code>rs-&gt;general.regs.x0</code> 存放的是实例地址, 但是按理说应该通过 <code>object_getClass(rs-&gt;general.regs.x0)</code> 应该取得类地址, 但是这里避免使用 Objective-C以及 parser 内代码格式统一 就直接使用了 c++ 去实现源码中对应的函数. <code>rs-&gt;general.regs.x1</code> 存放的是函数签名字符串.</p>
<h4 id="Macho-的文件解析"><a href="#Macho-的文件解析" class="headerlink" title="Macho 的文件解析"></a>Macho 的文件解析</h4><p>这里用到了个人之前实现的 macho 的 parser 模块, 大致介绍下这个模块, 可以通过三种状态对 macho 格式进行解析: 1. 文件 2. pid 3. 自身进程, 这里使用第三种, 对自身进程进行解析. (这个模块实现也挺有意思, 需要考虑到 ‘文件偏移’, ‘虚拟地址’, ‘内存地址’ 三种地址的处理)</p>
<p><img src="/images/macho-parser.png" alt=""></p>
<p>对于类实例的解析, 比较复杂, 这里简单介绍下, 具体可以参照 macho-ABI 文档.</p>
<h4 id="构建-hookAfter"><a href="#构建-hookAfter" class="headerlink" title="构建 hookAfter"></a>构建 hookAfter</h4><p><code>hookAfter</code> 实现了 <code>objc_msgSend</code> 执行后, 函数的出栈工作, 并解析函数返回值.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vm_address_t</span> hookAfter(<span class="keyword">struct</span> RegState_ *rs)</div><div class="line">&#123;</div><div class="line">    pa_list args = (pa_list)&#123;</div><div class="line">        rs,</div><div class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span> *&gt;(rs-&gt;bp),</div><div class="line">        <span class="number">2</span>,</div><div class="line">        <span class="number">0</span>&#125;;</div><div class="line">    ThreadCallStack *cs = getThreadCallStack(threadKey);</div><div class="line">    CallRecord *cr = popCallRecordSafe(cs, (<span class="keyword">void</span> *)rs-&gt;bp);</div><div class="line">    <span class="keyword">if</span> (cr)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// printCallRcordReturnValue(cr, cs, rs);</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(cr-&gt;ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        cr = popCallRecord(cs);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(cr-&gt;ret);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="hookBefore-与-hookAfter-的数据传递"><a href="#hookBefore-与-hookAfter-的数据传递" class="headerlink" title="hookBefore 与 hookAfter 的数据传递."></a>hookBefore 与 hookAfter 的数据传递.</h4><h5 id="x64-层面"><a href="#x64-层面" class="headerlink" title="x64 层面"></a>x64 层面</h5><p>关键在于函数调用栈中 <code>函数返回地址</code> 的传递, 也就是 <code>(%%rsp)</code> , 由于需要获取 <code>objc_msgSend</code> 的返回值, 所以需要修改栈内默认的函数返回值为下一条指令的地址(请读者思考为什么不直接 push 内存地址? ). 这涉及到如何恢复栈中函数返回地址, 采用线程私有变量的方式,  为每一个 <code>CallRecord</code> 添加 <code>ret</code> 成员.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">    vm_address_t addr;</div><div class="line">    unsigned long isTrace;</div><div class="line">    vm_address_t ret;</div><div class="line">    vm_address_t bp;</div><div class="line">    vm_address_t key;</div><div class="line">&#125; ReturnPayload;</div><div class="line"></div><div class="line">// Shared structures.</div><div class="line">typedef struct CallRecord_ &#123;</div><div class="line">    void *objc;</div><div class="line">    void *method;</div><div class="line">    void *bp;</div><div class="line">    void *ret;</div><div class="line">&#125; CallRecord;</div></pre></td></tr></table></figure>
<h5 id="arm64-层面"><a href="#arm64-层面" class="headerlink" title="arm64 层面"></a>arm64 层面</h5><p>其实关键在于 lr 寄存器值的传递, 由于需要获取 <code>objc_msgSend</code> 的返回值, 所以必须以 <code>blr objc_msgSend</code> 的方式调用, 此时之前 lr 寄存器的值被覆盖, 此时也不能进行 push 操作, 因为栈中可能已经保存了可变参数的值, 需要维持 sp 和 栈中内容不变, 那这里的 lr 如何保存恢复成了问题.</p>
<p>最后采用了线程私有变量的方法解决, 为每一个 <code>CallRecord</code> 添加 <code>lr</code> 成员, 在 <code>hookAfter</code> 是进行安全 pop, 也就是说同时需要校验 <code>rs-&gt;fp</code> 的值, 是否一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">    vm_address_t addr;</div><div class="line">    unsigned long isTrace;</div><div class="line">    vm_address_t lr;</div><div class="line">    vm_address_t fp;</div><div class="line">    vm_address_t key;</div><div class="line">&#125; ReturnPayload;</div><div class="line"></div><div class="line">// Shared structures.</div><div class="line">typedef struct CallRecord_ &#123;</div><div class="line">    void *objc;</div><div class="line">    void *method;</div><div class="line">    void *fp;</div><div class="line">    void *lr;</div><div class="line">&#125; CallRecord;</div></pre></td></tr></table></figure>
<h2 id="如何正确过滤-objc-msgSend"><a href="#如何正确过滤-objc-msgSend" class="headerlink" title="如何正确过滤 objc_msgSend"></a>如何正确过滤 objc_msgSend</h2><p>目前我是通过过滤来避免 log 太复杂.</p>
<h4 id="1-过滤函数地址"><a href="#1-过滤函数地址" class="headerlink" title="1. 过滤函数地址"></a>1. 过滤函数地址</h4><p>默认会过滤解析地址在 self 内存区内, 因为 MachoParser 本身就是一个耗时操作.</p>
<h4 id="2-1-设置不解析类-方法"><a href="#2-1-设置不解析类-方法" class="headerlink" title="2.1 设置不解析类/方法"></a>2.1 设置不解析类/方法</h4><p>需要使用 hash 表进行快速 cache 和 search.</p>
<h4 id="2-2-设置只解析的类-方法"><a href="#2-2-设置只解析的类-方法" class="headerlink" title="2.2 设置只解析的类/方法"></a>2.2 设置只解析的类/方法</h4><p>需要使用 hash 表进行快速 cache 和 search.</p>
<h4 id="3-限制函数调用栈深度"><a href="#3-限制函数调用栈深度" class="headerlink" title="3. 限制函数调用栈深度"></a>3. 限制函数调用栈深度</h4><p>通过自建模拟函数栈, 限制函数栈调用深度.</p>
<h4 id="4-过滤频繁调用函数-log-monitor-之类"><a href="#4-过滤频繁调用函数-log-monitor-之类" class="headerlink" title="4. 过滤频繁调用函数 (log, monitor 之类)"></a>4. 过滤频繁调用函数 (log, monitor 之类)</h4><p>对于一定时间段内频繁调用的函数添加到 hash-map 中.</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>目前主要关注逆向方面, 当然 APM 方向也是可以玩的.</p>
<h4 id="Thunder-逆向"><a href="#Thunder-逆向" class="headerlink" title="Thunder 逆向"></a>Thunder 逆向</h4><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><img src="/images/arm-x64-refs.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 函数调用约定, 寄存器使用约定</div><div class="line">http://abcdxyzk.github.io/blog/2012/11/23/assembly-args/</div></pre></td></tr></table></figure>

    

    
</div>


                

                <!-- Post Comments -->
                
                    
                
            </div>

            <!-- Post Prev & Next Nav -->
            <nav class="material-nav mdl-color-text--grey-50 mdl-cell mdl-cell--12-col">
    <!-- Prev Nav -->
    
        <a href="/2017/04/27/darwin/逆向分析aarch64的CydiaSubstrate的汇编指令/" id="post_nav-newer" class="prev-content">
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_back</i>
            </button>
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            Newer
        </a>
    

    <!-- Section Spacer -->
    <div class="section-spacer"></div>

    <!-- Next Nav -->
    
        <a href="/2017/05/11/darwin/ios应用安全审计思路/" id="post_nav-older" class="next-content">
            Older
            &nbsp;&nbsp;&nbsp;&nbsp;&nbsp;&nbsp;
            <button class="mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon mdl-color--white mdl-color-text--grey-900" role="presentation">
                <i class="material-icons">arrow_forward</i>
            </button>
        </a>
    
</nav>

        </div>
    </div>



                    
                        <!-- Overlay For Active Sidebar -->
<div class="sidebar-overlay"></div>

<!-- Material sidebar -->
<aside id="sidebar" class="sidebar sidebar-colored sidebar-fixed-left" role="navigation">
    <div id="sidebar-main">
        <!-- Sidebar Header -->
        <div class="sidebar-header header-cover" style="background-image: url(/img/sidebar_header.png);">
    <!-- Top bar -->
    <div class="top-bar"></div>

    <!-- Sidebar toggle button -->
    <button type="button" class="sidebar-toggle mdl-button mdl-js-button mdl-js-ripple-effect mdl-button--icon" style="display: initial;" data-upgraded=",MaterialButton,MaterialRipple">
        <i class="material-icons">clear_all</i>
        <span class="mdl-button__ripple-container">
            <span class="mdl-ripple">
            </span>
        </span>
    </button>

    <!-- Sidebar Avatar -->
    <div class="sidebar-image">
        <img src="/img/avatar.png" alt="jmpews's avatar">
    </div>

    <!-- Sidebar Email -->
    <a data-toggle="dropdown" class="sidebar-brand" href="#settings-dropdown">
        jmpews@gmail.com
        <b class="caret"></b>
    </a>
</div>


        <!-- Sidebar Navigation  -->
        <ul class="nav sidebar-nav">
    <!-- User dropdown  -->
    <li class="dropdown">
        <ul id="settings-dropdown" class="dropdown-menu">
            
                <li>
                    <a href="mailto: jmpews@gmail.com" target="_blank" title="Email Me">
                        
                            <i class="material-icons sidebar-material-icons sidebar-indent-left1pc-element">email</i>
                        
                        Email Me
                    </a>
                </li>
            
        </ul>
    </li>

    <!-- Homepage -->
    
        <li id="sidebar-first-li">
            <a href="/">
                
                    <i class="material-icons sidebar-material-icons">home</i>
                
                Home
            </a>
        </li>
        
    

    <!-- Archives  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">inbox</i>
                
                    Archives
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
            <li>
                <a class="sidebar_archives-link" href="/archives/2017/05/">May 2017<span class="sidebar_archives-count">6</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/04/">April 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/03/">March 2017<span class="sidebar_archives-count">3</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/02/">February 2017<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/archives/2017/01/">January 2017<span class="sidebar_archives-count">8</span></a></li><li><a class="sidebar_archives-link" href="/archives/2016/12/">December 2016<span class="sidebar_archives-count">42</span></a>
            </ul>
        </li>
        
    

    <!-- Categories  -->
    
        <li class="dropdown">
            <a href="#" class="ripple-effect dropdown-toggle" data-toggle="dropdown">
                
                    <i class="material-icons sidebar-material-icons">chrome_reader_mode</i>
                
                Categories
                <b class="caret"></b>
            </a>
            <ul class="dropdown-menu">
                <li>
                <a class="sidebar_archives-link" href="/categories/backend/">backend<span class="sidebar_archives-count">4</span></a></li><li><a class="sidebar_archives-link" href="/categories/darwin/">darwin<span class="sidebar_archives-count">14</span></a></li><li><a class="sidebar_archives-link" href="/categories/dev/">dev<span class="sidebar_archives-count">1</span></a></li><li><a class="sidebar_archives-link" href="/categories/notes/">notes<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/pwn/">pwn<span class="sidebar_archives-count">16</span></a></li><li><a class="sidebar_archives-link" href="/categories/python/">python<span class="sidebar_archives-count">18</span></a></li><li><a class="sidebar_archives-link" href="/categories/test/">test<span class="sidebar_archives-count">1</span></a>
            </ul>
        </li>
        
    

    <!-- Pages  -->
    
        <li>
            <a href="/about" title="About">
                
                    <i class="material-icons sidebar-material-icons">person</i>
                
                About
            </a>
        </li>
        
    
        <li>
            <a href="/tags" title="Tags">
                
                Tags
            </a>
        </li>
        
    

    <!-- Article Number  -->
    
        <li>
            <a href="/archives">
                Number of articles
                <span class="sidebar-badge">71</span>
            </a>
        </li>
        
    
</ul>


        <!-- Sidebar Footer -->
        <!--
I'm glad you use this theme, the development is no so easy, I hope you can keep the copyright, I will thank you so much.
If you still want to delete the copyrights, could you still retain the first one? Which namely "Theme Material"
It will not impact the appearance and can give developers a lot of support :)

很高兴您使用并喜欢该主题，开发不易 十分谢谢与希望您可以保留一下版权声明。
如果您仍然想删除的话 能否只保留第一项呢？即 "Theme Material"
它不会影响美观并可以给开发者很大的支持和动力。 :)
-->

<!-- Sidebar Divider -->


<!-- Theme Material -->


<!-- Help & Support -->
<!--

-->

<!-- Feedback -->
<!--

-->

<!-- About Theme -->
<!--

-->

    </div>

    <!-- Sidebar Image -->
    

</aside>

                    

                    
                        <!-- Footer Top Button -->
                        <div id="back-to-top" class="toTop-wrap">
    <a href="#top" class="toTop">
        <i class="material-icons footer_top-i">expand_less</i>
    </a>
</div>

                    

                    <!--Footer-->
<footer class="mdl-mini-footer" id="bottom">
    
        <!-- Paradox Footer Left Section -->
        <div class="mdl-mini-footer--left-section sns-list">
    <!-- Twitter -->
    
        <a href="https://twitter.com/jmpews" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-twitter">
                <span class="visuallyhidden">Twitter</span>
            </button><!--
     --></a>
    

    <!-- Facebook -->
    

    <!-- Google + -->
    

    <!-- Weibo -->
    
        <a href="https://weibo.com/winter1ife" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-weibo">
                <span class="visuallyhidden">Weibo</span>
            </button><!--
     --></a>
    

    <!-- Instagram -->
    

    <!-- Tumblr -->
    
        <a href="[object Object]" target="_blank">
            <button class="mdl-mini-footer--social-btn social-btn footer-sns-tumblr">
                <span class="visuallyhidden">Tumblr</span>
            </button><!--
     --></a>
    

    <!-- Github -->
    

    <!-- LinkedIn -->
    

    <!-- Zhihu -->
    

    <!-- Bilibili -->
    

    <!-- Telegram -->
    
</div>


        <!--Copyright-->
        <div id="copyright">
            Copyright&nbsp;©<script type="text/javascript">var fd = new Date();document.write("&nbsp;" + fd.getFullYear() + "&nbsp;");</script>Zz
        </div>

        <!-- Paradox Footer Right Section -->

        <!--
        I am glad you use this theme, the development is no so easy, I hope you can keep the copyright.
        It will not impact the appearance and can give developers a lot of support :)

        很高兴您使用该主题，开发不易，希望您可以保留一下版权声明。
        它不会影响美观并可以给开发者很大的支持。 :)
        -->

        <div class="mdl-mini-footer--right-section">
            <div>
                <div class="footer-develop-div">Powered by <a href="https://hexo.io" target="_blank" class="footer-develop-a">Hexo</a></div>
                <div class="footer-develop-div">Theme - <a href="https://github.com/viosey/hexo-theme-material" target="_blank" class="footer-develop-a">Material</a></div>
            </div>
        </div>
    
</footer>


                    <!-- Import File -->


    <script>lsloader.load("js/lazyload.min.js","/js/lazyload.min.js?1BcfzuNXqV+ntF6gq+5X3Q==")</script>
    <script>lsloader.load("js/js.min.js","/js/js.min.js?oAl/+lvaqTFV31JXTmbrNA==")</script>



    <script>lsloader.load("js/nprogress.js","/js/nprogress.js?pl3Qhb9lvqR1FlyLUna1Yw==")</script>


<script type="text/ls-javascript" id="NProgress-script">
    NProgress.configure({
        showSpinner: true
    });
    NProgress.start();
    $('#nprogress .bar').css({
        'background': '#29d'
    });
    $('#nprogress .peg').css({
        'box-shadow': '0 0 10px #29d, 0 0 15px #29d'
    });
    $('#nprogress .spinner-icon').css({
        'border-top-color': '#29d',
        'border-left-color': '#29d'
    });
    setTimeout(function() {
        NProgress.done();
        $('.fade').removeClass('out');
    }, 800);
</script>













<!-- UC Browser Compatible -->
<script>
	var agent = navigator.userAgent.toLowerCase();
	if(agent.indexOf('ucbrowser')>0) {
		document.write('<link rel="stylesheet" href="/css/uc.css">');
	   alert('由于 UC 浏览器使用极旧的内核，而本网站使用了一些新的特性。\n为了您能更好的浏览，推荐使用 Chrome 或 Firefox 浏览器。');
	}
</script>

<!-- Window Load-->
<script type="text/ls-javascript" id="window-load">
    $(window).on('load', function() {
        // Post_Toc parent position fixed
        $('.post-toc-wrap').parent('.mdl-menu__container').css('position', 'fixed');
    });
</script>

<!-- MathJax Load-->

<script type="text/ls-javascript" id="lazy-load">
    // Offer LazyLoad
    queue.offer(function(){
        $('.lazy').lazyload({
            effect : 'show'
        });
    });

    // Start Queue
    $(document).ready(function(){
        setInterval(function(){
            queue.execNext();
        },200);
    });
</script>

<!-- Bing Background -->


<script>
    (function(){
        var scriptList = document.querySelectorAll('script[type="text/ls-javascript"]')

        for (var i = 0; i < scriptList.length; ++i) {
            var item = scriptList[i];
            lsloader.runInlineScript(item.id,item.id);
        }
    })()
console.log('\n %c © Material Theme | Version: 1.4.0 | https://github.com/viosey/hexo-theme-material %c \n', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-left-radius:5px;border-bottom-left-radius:5px;', 'color:#455a64;background:#e0e0e0;padding:5px 0;border-top-right-radius:5px;border-bottom-right-radius:5px;');
</script>

                </main>
            </div>
        </body>
    
</html>
