<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="jmpews,jmpews@gmail.com"><title>如何正确的hook方法objc_msgSend · jmpews</title><meta name="description" content="如何正确的hook方法objc_msgSend前言如果希望对 Objective-C 的方法调用进行 log, 一个很好的解决方法就是 hook 方法 objc_msgSend, 当然想到的就是利用 InlinkHook 直接 hook 完事, 然而 objc_msgSend 是一个可变参数函数, "><meta name="keywords" content="py,go,pwn,reverse"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">jmpews</a></h3><div class="description"><p>py &amp; go &amp; pwn &amp; reverse</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/jmpews"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/winter1ife"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/jmpews"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>如何正确的hook方法objc_msgSend</a></h3></div><div class="post-content"><h2 id="如何正确的hook方法objc-msgSend"><a href="#如何正确的hook方法objc-msgSend" class="headerlink" title="如何正确的hook方法objc_msgSend"></a>如何正确的hook方法objc_msgSend</h2><h2 id="前言"><a href="#前言" class="headerlink" title="前言"></a>前言</h2><p>如果希望对 Objective-C 的方法调用进行 log, 一个很好的解决方法就是 hook 方法 <code>objc_msgSend</code>, 当然想到的就是利用 InlinkHook 直接 hook 完事, 然而 <code>objc_msgSend</code> 是一个可变参数函数, 这就有点蛋疼了.</p>
<p> <code>objc4-680</code>, 和目前的 <code>objc4-709</code> 没有有很大出入. </p>
<p>以下 在举例 arm 相关时使用 <code>objc4-680</code>, 说明 x64 时使用 <code>objc4-709</code></p>
<p>整个代码使用 c++, 所以有些地方需要参考 objc 的源码去造一个轮子, 比如 <code>object_getClass</code> 等.</p>
<p>这篇文章假设读者对以下有了解.</p>
<ol>
<li>OC 类的内存布局模型</li>
<li>OC 实例的内存布局模型</li>
<li>OC 函数调用与消息传递机制</li>
<li>macho 文件格式</li>
<li>基本 x64, arm 汇编指令</li>
<li>函数调用与参数传递的 x64, arm 汇编实现机制(函数调用约定)</li>
<li>inlinehook 机制</li>
</ol>
<h2 id="Hook-思路"><a href="#Hook-思路" class="headerlink" title="Hook 思路"></a>Hook 思路</h2><p>这里首先明确, objc_msgSend 的第三个参数是不定参数, 无法确定 <code>objc_msgSend</code> 的具体函数签名, 也就无法通过传参来调用原函数, 所以只能上暴力的方法, 通过保存/恢复栈和寄存器方法调用原函数, 之后在汇编指令中实现原函数的跳转调用.</p>
<p> <code>objc_msgSend</code> 的函数声明</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// runtime/message.h</div><div class="line">OBJC_EXPORT id objc_msgSend(id self, SEL op, ...)</div></pre></td></tr></table></figure>
<p><code>objc_msgSend</code> 的函数实现, 这里以 x64 和 arm64 举例.</p>
<h4 id="ARM64-下-ojbc-msgSend-实现机制"><a href="#ARM64-下-ojbc-msgSend-实现机制" class="headerlink" title="ARM64 下 ojbc_msgSend 实现机制"></a>ARM64 下 ojbc_msgSend 实现机制</h4><p> <code>_objc_msgSend</code> 首先会取得基本的参数, 比如 isa, class, 之后会使用宏 <code>CacheLookup</code> 先进行缓存查找, 如果没有命中, 会触发 <code>JumpMiss</code> 宏处理, 跳转到 <code>__objc_msgSend_uncached_impcache</code>, 这个方法是了解如何正确 hook 的关键.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div></pre></td><td class="code"><pre><div class="line">// objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">	ENTRY _objc_msgSend</div><div class="line">	MESSENGER_START</div><div class="line"></div><div class="line">	cmp	x0, #0			// nil check and tagged pointer check</div><div class="line">	b.le	LNilOrTagged		//  (MSB tagged pointer looks negative)</div><div class="line">	ldr	x13, [x0]		// x13 = isa</div><div class="line">	and	x9, x13, #ISA_MASK	// x9 = class	</div><div class="line">LGetIsaDone:</div><div class="line">	CacheLookup NORMAL		// calls imp or objc_msgSend_uncached</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div></pre></td><td class="code"><pre><div class="line">// objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">.macro JumpMiss</div><div class="line">.if $0 == NORMAL</div><div class="line">	b	__objc_msgSend_uncached_impcache</div><div class="line">.else</div><div class="line">	b	LGetImpMiss</div><div class="line">.endif</div><div class="line">.endmacro</div><div class="line"></div><div class="line">.macro CacheLookup</div><div class="line">	// x1 = SEL, x9 = isa</div><div class="line">	ldp	x10, x11, [x9, #CACHE]	// x10 = buckets, x11 = occupied|mask</div><div class="line">	and	w12, w1, w11		// x12 = _cmd &amp; mask</div><div class="line">	add	x12, x10, x12, LSL #4	// x12 = buckets + ((_cmd &amp; mask)&lt;&lt;4)</div><div class="line"></div><div class="line">	ldp	x16, x17, [x12]		// &#123;x16, x17&#125; = *bucket</div><div class="line">1:	cmp	x16, x1			// if (bucket-&gt;sel != _cmd)</div><div class="line">	b.ne	2f			//     scan more</div><div class="line">	CacheHit $0			// call or return imp</div><div class="line">	</div><div class="line">2:	// not hit: x12 = not-hit bucket</div><div class="line">	CheckMiss $0			// miss if bucket-&gt;cls == 0</div><div class="line">	cmp	x12, x10		// wrap if bucket == buckets</div><div class="line">	b.eq	3f</div><div class="line">	ldp	x16, x17, [x12, #-16]!	// &#123;x16, x17&#125; = *--bucket</div><div class="line">	b	1b			// loop</div><div class="line"></div><div class="line">3:	// wrap: x12 = first bucket, w11 = mask</div><div class="line">	add	x12, x12, w11, UXTW #4	// x12 = buckets+(mask&lt;&lt;4)</div><div class="line"></div><div class="line">	// Clone scanning loop to miss instead of hang when cache is corrupt.</div><div class="line">	// The slow path may detect any corruption and halt later.</div><div class="line"></div><div class="line">	ldp	x16, x17, [x12]		// &#123;x16, x17&#125; = *bucket</div><div class="line">1:	cmp	x16, x1			// if (bucket-&gt;sel != _cmd)</div><div class="line">	b.ne	2f			//     scan more</div><div class="line">	CacheHit $0			// call or return imp</div><div class="line">	</div><div class="line">2:	// not hit: x12 = not-hit bucket</div><div class="line">	CheckMiss $0			// miss if bucket-&gt;cls == 0</div><div class="line">	cmp	x12, x10		// wrap if bucket == buckets</div><div class="line">	b.eq	3f</div><div class="line">	ldp	x16, x17, [x12, #-16]!	// &#123;x16, x17&#125; = *--bucket</div><div class="line">	b	1b			// loop</div><div class="line"></div><div class="line">3:	// double wrap</div><div class="line">	JumpMiss $0</div><div class="line">	</div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<p>具体解析下 <code>__objc_msgSend_uncached_impcache</code>  这个函数, 在函数入口保存寄存器和返回地址, 在调用 <code>__class_lookupMethodAndLoadCache3</code> 之后进行恢复. <code>__class_lookupMethodAndLoadCache3</code> 函数返回需要调用函数的地址.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div></pre></td><td class="code"><pre><div class="line"> // objc4-680/runtime/Messengers.subproj/objc-msg-arm64.s</div><div class="line">STATIC_ENTRY __objc_msgSend_uncached_impcache</div><div class="line"></div><div class="line">// THIS IS NOT A CALLABLE C FUNCTION</div><div class="line">// Out-of-band x9 is the class to search</div><div class="line"></div><div class="line">MESSENGER_START</div><div class="line"></div><div class="line">// push frame</div><div class="line">stp	fp, lr, [sp, #-16]!</div><div class="line">mov	fp, sp</div><div class="line"></div><div class="line">MESSENGER_END_SLOW</div><div class="line"></div><div class="line">// save parameter registers: x0..x8, q0..q7</div><div class="line">sub	sp, sp, #(10*8 + 8*16)</div><div class="line">stp	q0, q1, [sp, #(0*16)]</div><div class="line">stp	q2, q3, [sp, #(2*16)]</div><div class="line">stp	q4, q5, [sp, #(4*16)]</div><div class="line">stp	q6, q7, [sp, #(6*16)]</div><div class="line">stp	x0, x1, [sp, #(8*16+0*8)]</div><div class="line">stp	x2, x3, [sp, #(8*16+2*8)]</div><div class="line">stp	x4, x5, [sp, #(8*16+4*8)]</div><div class="line">stp	x6, x7, [sp, #(8*16+6*8)]</div><div class="line">str	x8,     [sp, #(8*16+8*8)]</div><div class="line"></div><div class="line">// receiver and selector already in x0 and x1</div><div class="line">mov	x2, x9</div><div class="line">bl	__class_lookupMethodAndLoadCache3</div><div class="line"></div><div class="line">// imp in x0</div><div class="line">mov	x17, x0</div><div class="line"></div><div class="line">// restore registers and return</div><div class="line">ldp	q0, q1, [sp, #(0*16)]</div><div class="line">ldp	q2, q3, [sp, #(2*16)]</div><div class="line">ldp	q4, q5, [sp, #(4*16)]</div><div class="line">ldp	q6, q7, [sp, #(6*16)]</div><div class="line">ldp	x0, x1, [sp, #(8*16+0*8)]</div><div class="line">ldp	x2, x3, [sp, #(8*16+2*8)]</div><div class="line">ldp	x4, x5, [sp, #(8*16+4*8)]</div><div class="line">ldp	x6, x7, [sp, #(8*16+6*8)]</div><div class="line">ldr	x8,     [sp, #(8*16+8*8)]</div><div class="line"></div><div class="line">mov	sp, fp</div><div class="line">ldp	fp, lr, [sp], #16</div><div class="line"></div><div class="line">br	x17</div><div class="line"></div><div class="line">END_ENTRY __objc_msgSend_uncached_impcache</div></pre></td></tr></table></figure>
<p>举个例子演示下, 这里可以仔细观察 lldb 的输出.</p>
<p><img src="/images/debug-objc_msgSend.png" alt=""></p>
<h4 id="x64-下-ojbc-msgSend-实现机制"><a href="#x64-下-ojbc-msgSend-实现机制" class="headerlink" title="x64 下 ojbc_msgSend 实现机制"></a>x64 下 ojbc_msgSend 实现机制</h4><p>整体思路与 arm64 类似, 但几个关键部分不同, 这里主要关注 <code>GetIsaFast</code> 和 <code>MethodTableLookup</code>, <code>MethodTableLookup</code> 是在缓存中没有命中时进行查找.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div></pre></td><td class="code"><pre><div class="line">objc4-709/runtime/Messengers.subproj/objc-msg-x86_64.s</div><div class="line">ENTRY _objc_msgSend</div><div class="line">UNWIND _objc_msgSend, NoFrame</div><div class="line">MESSENGER_START</div><div class="line"></div><div class="line">NilTest	NORMAL</div><div class="line"></div><div class="line">GetIsaFast NORMAL		// r10 = self-&gt;isa</div><div class="line">CacheLookup NORMAL, CALL	// calls IMP on success</div></pre></td></tr></table></figure>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div></pre></td><td class="code"><pre><div class="line">objc4-709/runtime/Messengers.subproj/objc-msg-x86_64.s</div><div class="line">.macro GetIsaFast</div><div class="line">.if $0 != STRET</div><div class="line">	testb	$$1, %a1b</div><div class="line">	PN</div><div class="line">	jnz	LGetIsaSlow_f</div><div class="line">	movq	$$0x00007ffffffffff8, %r10</div><div class="line">	andq	(%a1), %r10</div><div class="line">.else</div><div class="line">	testb	$$1, %a2b</div><div class="line">	PN</div><div class="line">	jnz	LGetIsaSlow_f</div><div class="line">	movq	$$0x00007ffffffffff8, %r10</div><div class="line">	andq	(%a2), %r10</div><div class="line">.endif</div><div class="line">LGetIsaDone:	</div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<p>这里需要关注 x64 保存和恢复参数的操作, 特别是这里的栈对齐.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div></pre></td><td class="code"><pre><div class="line">objc4-709/runtime/Messengers.subproj/objc-msg-x86_64.s</div><div class="line">.macro MethodTableLookup</div><div class="line"></div><div class="line">	push	%rbp</div><div class="line">	mov	%rsp, %rbp</div><div class="line">	</div><div class="line">	sub	$$0x80+8, %rsp		// +8 for alignment</div><div class="line"></div><div class="line">	movdqa	%xmm0, -0x80(%rbp)</div><div class="line">	push	%rax			// might be xmm parameter count</div><div class="line">	movdqa	%xmm1, -0x70(%rbp)</div><div class="line">	push	%a1</div><div class="line">	movdqa	%xmm2, -0x60(%rbp)</div><div class="line">	push	%a2</div><div class="line">	movdqa	%xmm3, -0x50(%rbp)</div><div class="line">	push	%a3</div><div class="line">	movdqa	%xmm4, -0x40(%rbp)</div><div class="line">	push	%a4</div><div class="line">	movdqa	%xmm5, -0x30(%rbp)</div><div class="line">	push	%a5</div><div class="line">	movdqa	%xmm6, -0x20(%rbp)</div><div class="line">	push	%a6</div><div class="line">	movdqa	%xmm7, -0x10(%rbp)</div><div class="line"></div><div class="line">	// _class_lookupMethodAndLoadCache3(receiver, selector, class)</div><div class="line"></div><div class="line">.if $0 == NORMAL</div><div class="line">	// receiver already in a1</div><div class="line">	// selector already in a2</div><div class="line">.else</div><div class="line">	movq	%a2, %a1</div><div class="line">	movq	%a3, %a2</div><div class="line">.endif</div><div class="line">	movq	%r10, %a3</div><div class="line">	call	__class_lookupMethodAndLoadCache3</div><div class="line"></div><div class="line">	// IMP is now in %rax</div><div class="line">	movq	%rax, %r11</div><div class="line"></div><div class="line">	movdqa	-0x80(%rbp), %xmm0</div><div class="line">	pop	%a6</div><div class="line">	movdqa	-0x70(%rbp), %xmm1</div><div class="line">	pop	%a5</div><div class="line">	movdqa	-0x60(%rbp), %xmm2</div><div class="line">	pop	%a4</div><div class="line">	movdqa	-0x50(%rbp), %xmm3</div><div class="line">	pop	%a3</div><div class="line">	movdqa	-0x40(%rbp), %xmm4</div><div class="line">	pop	%a2</div><div class="line">	movdqa	-0x30(%rbp), %xmm5</div><div class="line">	pop	%a1</div><div class="line">	movdqa	-0x20(%rbp), %xmm6</div><div class="line">	pop	%rax</div><div class="line">	movdqa	-0x10(%rbp), %xmm7</div><div class="line"></div><div class="line">.if $0 == NORMAL</div><div class="line">	cmp	%r11, %r11		// set eq for nonstret forwarding</div><div class="line">.else</div><div class="line">	test	%r11, %r11		// set ne for stret forwarding</div><div class="line">.endif</div><div class="line">	</div><div class="line">	leave</div><div class="line"></div><div class="line">.endmacro</div></pre></td></tr></table></figure>
<h2 id="构建-fake-objc-msgSend"><a href="#构建-fake-objc-msgSend" class="headerlink" title="构建 fake_objc_msgSend"></a>构建 fake_objc_msgSend</h2><p>在了解了 objc_msgSend 的流程, 接下来构建 <code>fake_objc_msgSend</code>, 需要保存保存寄存器状态, 以正确调用原 <code>objc_msgSend</code>, 这里解释下为什么需要保存寄存器状态, 因为参数个数不定, 所以可能会同时用到多个寄存器和栈来同时传参, 所以这里需要将可能会用到的所有寄存器以及 sp 都保存, 以确保多参数不被修改. 其实把这里的保护寄存器实现在 hook 层可能会更好一些. 最终通过把寄存器参数保存在栈中, 并以栈指针作为参数, 传给 <code>hookBefore</code>, 实现函数参数的完全访问.</p>
<p>ok, 说完了函数的参数(寄存器)保存和恢复部分, 接下来谈一谈函数调用栈的问题.</p>
<ol>
<li>限制函数调用栈深度</li>
<li>记录函数调用的返回值</li>
</ol>
<p>问题 1, 比较好理解. 问题 2, 如果需要记录函数返回值, 并且过滤了部分的函数记录, 必须要保证 <code>hookBefore</code> 和 <code>hookAfter</code> 是对于同一个 <code>函数</code> 做的处理, 所以这里需要自建函数调用栈以及标记 <code>函数</code> , 也就是说必须要保证自建的调用栈的 push 和 pop 操作必须对应, 这一点 InspectiveC 不同, 它是直接跟踪所有函数入栈(依赖系统标准函数栈的准确). 这里使用 <code>sp</code> 寄存器做标记区分函数(关于为何使用 <code>sp</code> 寄存器做标记区分, 希望读者能自己仔细思考函数调用本质), 以确保 push 和 pop 的对应正确.</p>
<p>这里总结一下 fake_objc_msgSend_safe 的工作</p>
<ol>
<li>保存寄存器/参数</li>
<li>hookBefore 工作(过滤/判断 <code>调用的函数</code>)</li>
<li>恢复寄存器/参数</li>
<li>如果经过判断不需要追踪, 则直接调用原 ojbc_msgSend</li>
<li>如果需要追踪, 则修改默认栈内保存的返回地址后, 继续调用 objc_msgSend (这里涉及到 trick)</li>
<li>保存寄存器/参数</li>
<li>hookAfter 工作(解析返回值, 函数调用出栈, 确保两次  <code>sp</code> 值相同)</li>
<li>恢复寄存器/参数</li>
<li>ret</li>
</ol>
<p>下面列出 fake_objc_msgSend_safe 的核心代码. </p>
<p>这里关于调用栈的操作主要放在 <code>hookBefore</code> 和 <code>hookAfter</code>, 关于在内联汇编中调用 C 函数这里也使用了两种方法, 一种使用 <code>nm</code> 导出符号, 一种使用内联汇编传参. </p>
<p>这里关于寄存器的使用与污染问题, 请查阅相关资料或参考下方参考资料, 以了解寄存器使用约定.</p>
<p>这里关于如何获取到汇编的下一条指令地址的 trick, 可以参考 <code>&lt;程序员自我修养&gt;</code> 中地址无关代码中使用到的 <code>get_pc_thunk</code>.</p>
<p>使用 ‘横线’ 分割了 <code>hookBefore</code> 和 <code>hookAfter</code> 相关处理代码, 大部分代码我都已经加了注释.</p>
<figure class="highlight"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div><div class="line">89</div><div class="line">90</div><div class="line">91</div><div class="line">92</div><div class="line">93</div><div class="line">94</div><div class="line">95</div><div class="line">96</div><div class="line">97</div><div class="line">98</div><div class="line">99</div><div class="line">100</div><div class="line">101</div><div class="line">102</div><div class="line">103</div><div class="line">104</div><div class="line">105</div><div class="line">106</div><div class="line">107</div><div class="line">108</div><div class="line">109</div><div class="line">110</div><div class="line">111</div><div class="line">112</div><div class="line">113</div><div class="line">114</div><div class="line">115</div><div class="line">116</div><div class="line">117</div><div class="line">118</div><div class="line">119</div><div class="line">120</div><div class="line">121</div><div class="line">122</div><div class="line">123</div><div class="line">124</div><div class="line">125</div><div class="line">126</div><div class="line">127</div><div class="line">128</div><div class="line">129</div><div class="line">130</div><div class="line">131</div><div class="line">132</div><div class="line">133</div><div class="line">134</div><div class="line">135</div><div class="line">136</div><div class="line">137</div><div class="line">138</div><div class="line">139</div><div class="line">140</div><div class="line">141</div><div class="line">142</div><div class="line">143</div><div class="line">144</div><div class="line">145</div><div class="line">146</div><div class="line">147</div><div class="line">148</div><div class="line">149</div><div class="line">150</div><div class="line">151</div><div class="line">152</div><div class="line">153</div><div class="line">154</div><div class="line">155</div><div class="line">156</div><div class="line">157</div><div class="line">158</div><div class="line">159</div><div class="line">160</div><div class="line">161</div><div class="line">162</div><div class="line">163</div><div class="line">164</div><div class="line">165</div><div class="line">166</div></pre></td><td class="code"><pre><div class="line">__attribute__((__naked__)) static void fake_objc_msgSend_safe()</div><div class="line">&#123;</div><div class="line">    // test for direct jmp</div><div class="line">    // __asm__ volatile(</div><div class="line">    //     "jmpq *%0\n":</div><div class="line">    //     : "r" (orig_objc_msgSend)</div><div class="line">    //     :);</div><div class="line">    // backup registers</div><div class="line">    __asm__ volatile(</div><div class="line">        "subq $(16*8+8), %%rsp\n" // +8 for alignment</div><div class="line"></div><div class="line">        "movdqa	%%xmm0, (%%rsp)\n"</div><div class="line">        "movdqa	%%xmm1, 0x10(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm2, 0x20(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm3, 0x30(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm4, 0x40(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm5, 0x50(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm6, 0x60(%%rsp)\n"</div><div class="line">        "movdqa	%%xmm7, 0x70(%%rsp)\n"</div><div class="line"></div><div class="line">        "pushq %%rax\n" // stack align</div><div class="line"></div><div class="line">        "pushq %%r9\n" // might be xmm parameter count</div><div class="line">        "pushq %%r8\n"</div><div class="line">        "pushq %%rcx\n"</div><div class="line">        "pushq %%rdx\n"</div><div class="line">        "pushq %%rsi\n"</div><div class="line">        "pushq %%rdi\n"</div><div class="line">        "pushq %%rax\n"</div><div class="line"></div><div class="line">        // origin rsp, contain `ret address`, how to use leaq, always wrong.</div><div class="line">        "movq %%rsp, %%rax\n"</div><div class="line">        "addq $(16*8+8+8+7*8), %%rax\n"</div><div class="line">        "pushq (%%rax)\n"</div><div class="line">        "pushq %%rax\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // prepare args for func</div><div class="line">    __asm__ volatile(</div><div class="line">        "movq %%rsp, %%rdi\n"</div><div class="line">        "callq __Z10hookBeforeP9RegState_\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // get value from `ReturnPayload`</div><div class="line">    __asm__ volatile(</div><div class="line">        "movq (%%rax), %%r10\n"</div><div class="line">        "movq 8(%%rax), %%r11\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // restore registers</div><div class="line">    __asm__ volatile(</div><div class="line"></div><div class="line">        "popq %%rax\n"</div><div class="line">        "popq (%%rax)\n"</div><div class="line"></div><div class="line">        "popq	%%rax\n"</div><div class="line">        "popq	%%rdi\n"</div><div class="line">        "popq	%%rsi\n"</div><div class="line">        "popq	%%rdx\n"</div><div class="line">        "popq	%%rcx\n"</div><div class="line">        "popq	%%r8\n"</div><div class="line">        "popq	%%r9\n"</div><div class="line"></div><div class="line">        "popq %%rax\n" // stack align</div><div class="line"></div><div class="line">        "movdqa	(%%rsp), %%xmm0\n"</div><div class="line">        "movdqa	0x10(%%rsp), %%xmm1\n"</div><div class="line">        "movdqa	0x20(%%rsp), %%xmm2\n"</div><div class="line">        "movdqa	0x30(%%rsp), %%xmm3\n"</div><div class="line">        "movdqa	0x40(%%rsp), %%xmm4\n"</div><div class="line">        "movdqa	0x50(%%rsp), %%xmm5\n"</div><div class="line">        "movdqa	0x60(%%rsp), %%xmm6\n"</div><div class="line">        "movdqa	0x70(%%rsp), %%xmm7\n"</div><div class="line"></div><div class="line">        "addq $(16*8+8), %%rsp\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // go to the original objc_msgSend</div><div class="line">    __asm__ volatile(</div><div class="line">        // "br x9\n"</div><div class="line">        "cmpq $0, %%r11\n"</div><div class="line">        "jne Lthroughx\n"</div><div class="line">        "jmpq *%%r10\n"</div><div class="line">        "Lthroughx:\n"</div><div class="line"></div><div class="line">        // trick to jmp</div><div class="line">        "jmp NextInstruction\n"</div><div class="line">        "Begin:\n"</div><div class="line">        "popq %%r11\n"</div><div class="line">        "movq %%r11, (%%rsp)\n"</div><div class="line">        "jmpq *%%r10\n"</div><div class="line">        "NextInstruction:\n"</div><div class="line">        "call Begin" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    //-----------------------------------------------------------------------------</div><div class="line">    // after objc_msgSend we parse the result.</div><div class="line"></div><div class="line">    // backup registers</div><div class="line">    __asm__ volatile(</div><div class="line">        "pushq %%r10\n" // stack align</div><div class="line"></div><div class="line">        "push	%%rbp\n"</div><div class="line">        "movq	%%rsp, %%rbp\n"</div><div class="line"></div><div class="line">        "subq	$(16*8), %%rsp\n" // +8 for alignment</div><div class="line"></div><div class="line">        "movdqa	%%xmm0, -0x80(%%rbp)\n"</div><div class="line">        "push	%%r9\n" // might be xmm parameter count</div><div class="line">        "movdqa	%%xmm1, -0x70(%%rbp)\n"</div><div class="line">        "push	%%r8\n"</div><div class="line">        "movdqa	%%xmm2, -0x60(%%rbp)\n"</div><div class="line">        "push	%%rcx\n"</div><div class="line">        "movdqa	%%xmm3, -0x50(%%rbp)\n"</div><div class="line">        "push	%%rdx\n"</div><div class="line">        "movdqa	%%xmm4, -0x40(%%rbp)\n"</div><div class="line">        "push	%%rsi\n"</div><div class="line">        "movdqa	%%xmm5, -0x30(%%rbp)\n"</div><div class="line">        "push	%%rdi\n"</div><div class="line">        "movdqa	%%xmm6, -0x20(%%rbp)\n"</div><div class="line">        "push	%%rax\n"</div><div class="line">        "movdqa	%%xmm7, -0x10(%%rbp)\n"</div><div class="line"></div><div class="line">        "pushq 0x8(%%rbp)\n"</div><div class="line">        "movq %%rbp, %%rax\n"</div><div class="line">        "addq $8, %%rax\n"</div><div class="line">        "pushq %%rax\n" ::</div><div class="line">            :);</div><div class="line"></div><div class="line">    // prepare args for func</div><div class="line">    __asm__ volatile(</div><div class="line">        "movq %%rsp, %%rdi\n"</div><div class="line">        // "callq __Z9hookAfterP9RegState_\n"</div><div class="line">        "callq *%0\n"</div><div class="line">        "movq %%rax, %%r10\n"</div><div class="line">        :</div><div class="line">        : "r"(func_ptr)</div><div class="line">        : "%rax");</div><div class="line"></div><div class="line">    // restore registers</div><div class="line">    __asm__ volatile(</div><div class="line">        "pop %%rax\n"</div><div class="line">        "pop 8(%%rbp)\n"</div><div class="line"></div><div class="line">        "movdqa	-0x80(%%rbp), %%xmm0\n"</div><div class="line">        "pop	%%rax\n"</div><div class="line">        "movdqa	-0x70(%%rbp), %%xmm1\n"</div><div class="line">        "pop	%%rdi\n"</div><div class="line">        "movdqa	-0x60(%%rbp), %%xmm2\n"</div><div class="line">        "pop	%%rsi\n"</div><div class="line">        "movdqa	-0x50(%%rbp), %%xmm3\n"</div><div class="line">        "pop	%%rdx\n"</div><div class="line">        "movdqa	-0x40(%%rbp), %%xmm4\n"</div><div class="line">        "pop	%%rcx\n"</div><div class="line">        "movdqa	-0x30(%%rbp), %%xmm5\n"</div><div class="line">        "pop	%%r8\n"</div><div class="line">        "movdqa	-0x20(%%rbp), %%xmm6\n"</div><div class="line">        "pop	%%r9\n"</div><div class="line">        "movdqa	-0x10(%%rbp), %%xmm7\n"</div><div class="line">        "leave\n"</div><div class="line"></div><div class="line">        // go to the original objc_msgSend</div><div class="line">        "movq %%r10, (%%rsp)\n"</div><div class="line">        "ret\n" ::</div><div class="line">            :);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>虽然现在已经可以 hook 到 objc_msgSend.</p>
<p>利用下面的数据结构获取之前保存在栈中的参数, ps: 这个结构是参考 InspectiveC, 实现的很精巧, 在此基础上做了一些修改.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div></pre></td><td class="code"><pre><div class="line"><span class="meta">#<span class="meta-keyword">include</span> <span class="meta-string">&lt;stdint.h&gt; // uint64_t</span></span></div><div class="line"><span class="comment">/*</span></div><div class="line">    -ARM64</div><div class="line">    http://infocenter.arm.com/help/topic/com.arm.doc.den0024a/DEN0024A_v8_architecture_PG.pdf (7.2.1 Floating-point) (4.6.1 Floating-point register organization in AArch64)</div><div class="line">    use struct and union to describe diagram in the above link, nice!</div><div class="line"></div><div class="line">    -X86</div><div class="line">    https://en.wikipedia.org/wiki/X86_calling_conventions</div><div class="line">    RDI, RSI, RDX, RCX, R8, R9, XMM0–7</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="comment">// x86_64 is XMM, arm64 is q</span></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">union</span> FPMReg_ &#123;</div><div class="line">    <span class="keyword">__int128_t</span> q;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">double</span> d1; <span class="comment">// Holds the double (LSB).</span></div><div class="line">        <span class="keyword">double</span> d2;</div><div class="line">    &#125; d;</div><div class="line">    <span class="keyword">struct</span> &#123;</div><div class="line">        <span class="keyword">float</span> f1; <span class="comment">// Holds the float (LSB).</span></div><div class="line">        <span class="keyword">float</span> f2;</div><div class="line">        <span class="keyword">float</span> f3;</div><div class="line">        <span class="keyword">float</span> f4;</div><div class="line">    &#125; f;</div><div class="line">&#125; FPReg;</div><div class="line"></div><div class="line"><span class="comment">// just ref how to backup/restore registers</span></div><div class="line"><span class="keyword">struct</span> RegState_ &#123;</div><div class="line">    <span class="keyword">uint64_t</span> bp;</div><div class="line">    <span class="keyword">uint64_t</span> ret;</div><div class="line"></div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        <span class="keyword">uint64_t</span> arr[<span class="number">7</span>];</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            <span class="keyword">uint64_t</span> rax;</div><div class="line">            <span class="keyword">uint64_t</span> rdi;</div><div class="line">            <span class="keyword">uint64_t</span> rsi;</div><div class="line">            <span class="keyword">uint64_t</span> rdx;</div><div class="line">            <span class="keyword">uint64_t</span> rcx;</div><div class="line">            <span class="keyword">uint64_t</span> r8;</div><div class="line">            <span class="keyword">uint64_t</span> r9;</div><div class="line">        &#125; regs;</div><div class="line">    &#125; general;</div><div class="line"></div><div class="line">    <span class="keyword">uint64_t</span> _; <span class="comment">// for align</span></div><div class="line">    </div><div class="line">    <span class="keyword">union</span> &#123;</div><div class="line">        FPReg arr[<span class="number">8</span>];</div><div class="line">        <span class="keyword">struct</span> &#123;</div><div class="line">            FPReg xmm0;</div><div class="line">            FPReg xmm1;</div><div class="line">            FPReg xmm2;</div><div class="line">            FPReg xmm3;</div><div class="line">            FPReg xmm4;</div><div class="line">            FPReg xmm5;</div><div class="line">            FPReg xmm6;</div><div class="line">            FPReg xmm7;</div><div class="line">        &#125; regs;</div><div class="line">    &#125; floating;</div><div class="line">&#125;;</div><div class="line"></div><div class="line"><span class="keyword">typedef</span> <span class="keyword">struct</span> pa_list_ &#123;</div><div class="line">    <span class="keyword">struct</span> RegState_ *regs; <span class="comment">// Registers saved when function is called.</span></div><div class="line">    <span class="keyword">unsigned</span> <span class="keyword">char</span> *<span class="built_in">stack</span>; <span class="comment">// Address of current argument.</span></div><div class="line">    <span class="keyword">int</span> ngrn; <span class="comment">// The Next General-purpose Register Number.</span></div><div class="line">    <span class="keyword">int</span> nsrn; <span class="comment">// The Next SIMD and Floating-point Register Number.</span></div><div class="line">&#125; pa_list;</div></pre></td></tr></table></figure>
<h4 id="构建-hookBefore"><a href="#构建-hookBefore" class="headerlink" title="构建 hookBefore"></a>构建 hookBefore</h4><p><code>hookBefore</code> 实现了函数调用前的 trace 工作, 过滤 <code>函数</code>, 将 <code>函数</code> 压进调用栈, 解析类实例对象, 解析不定参数.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div><div class="line">21</div><div class="line">22</div><div class="line">23</div><div class="line">24</div><div class="line">25</div><div class="line">26</div><div class="line">27</div><div class="line">28</div><div class="line">29</div><div class="line">30</div><div class="line">31</div><div class="line">32</div><div class="line">33</div><div class="line">34</div><div class="line">35</div><div class="line">36</div><div class="line">37</div><div class="line">38</div><div class="line">39</div><div class="line">40</div><div class="line">41</div><div class="line">42</div><div class="line">43</div><div class="line">44</div><div class="line">45</div><div class="line">46</div><div class="line">47</div><div class="line">48</div><div class="line">49</div><div class="line">50</div><div class="line">51</div><div class="line">52</div><div class="line">53</div><div class="line">54</div><div class="line">55</div><div class="line">56</div><div class="line">57</div><div class="line">58</div><div class="line">59</div><div class="line">60</div><div class="line">61</div><div class="line">62</div><div class="line">63</div><div class="line">64</div><div class="line">65</div><div class="line">66</div><div class="line">67</div><div class="line">68</div><div class="line">69</div><div class="line">70</div><div class="line">71</div><div class="line">72</div><div class="line">73</div><div class="line">74</div><div class="line">75</div><div class="line">76</div><div class="line">77</div><div class="line">78</div><div class="line">79</div><div class="line">80</div><div class="line">81</div><div class="line">82</div><div class="line">83</div><div class="line">84</div><div class="line">85</div><div class="line">86</div><div class="line">87</div><div class="line">88</div></pre></td><td class="code"><pre><div class="line"><span class="comment">/*</span></div><div class="line">    arg1: object-address(need to parse &gt;&gt; class)</div><div class="line">    arg2: method string address</div><div class="line">    arg3: method signature</div><div class="line">*/</div><div class="line"></div><div class="line"><span class="keyword">vm_address_t</span> hookBefore(<span class="keyword">struct</span> RegState_ *rs)</div><div class="line">&#123;</div><div class="line">    gettimeofday(&amp;start,<span class="literal">NULL</span>);</div><div class="line">    <span class="comment">// <span class="doctag">TODO:</span> parse args</span></div><div class="line">    pa_list args = (pa_list)&#123;</div><div class="line">        rs,</div><div class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span> *&gt;(rs-&gt;bp),</div><div class="line">        <span class="number">2</span>,</div><div class="line">        <span class="number">0</span>&#125;;</div><div class="line"></div><div class="line">    ThreadCallStack *cs = getThreadCallStack(threadKey);</div><div class="line"></div><div class="line">    ReturnPayload *rp = cs-&gt;rp;</div><div class="line"></div><div class="line">    <span class="keyword">vm_address_t</span> xaddr = (<span class="keyword">uint64_t</span>)orig_objc_msgSend;</div><div class="line">    rp-&gt;addr = xaddr;</div><div class="line">    rp-&gt;ret = rs-&gt;ret;</div><div class="line">    rp-&gt;bp = rs-&gt;bp;</div><div class="line">    rp-&gt;isTrace = <span class="number">0</span>;</div><div class="line">    rp-&gt;key = rs-&gt;ret &amp; rs-&gt;bp;</div><div class="line"></div><div class="line">    <span class="keyword">if</span> (<span class="number">1</span> || pthread_main_np())</div><div class="line">    &#123;</div><div class="line">        <span class="comment">/* </span></div><div class="line">            pay attention!!! as `objc_msgSend` invoked so often, the `filter` code snippet that use `c` to write it must be fast!!!.</div><div class="line">        */</div><div class="line">        <span class="keyword">do</span></div><div class="line">        &#123;   </div><div class="line">            <span class="comment">// check method string address, can be narrow the scope.</span></div><div class="line">            <span class="keyword">char</span> *methodSelector = <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">char</span> *&gt;(rs-&gt;general.regs.rsi);</div><div class="line">            <span class="keyword">if</span>(!(methodSelector &amp;&amp; checkAddressRange((<span class="keyword">vm_address_t</span>)methodSelector, macho_load_addr, macho_load_end_addr)))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// check object's class address</span></div><div class="line">            <span class="keyword">vm_address_t</span> class_addr = macho_objc_getClass(rs-&gt;general.regs.rdi);</div><div class="line">            <span class="keyword">if</span> (!(class_addr &amp;&amp; checkAddressRange(class_addr, macho_load_addr, macho_load_end_addr)))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// check `call count filter`</span></div><div class="line">            <span class="keyword">if</span>(check_freq_filter((<span class="keyword">unsigned</span> <span class="keyword">long</span>)methodSelector))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">            <span class="comment">// // test for wechat</span></div><div class="line">            <span class="comment">// if(!strncmp(methodSelector, "onRevokeMsg", 9))</span></div><div class="line">            <span class="comment">//     debug_break();</span></div><div class="line"></div><div class="line">            <span class="comment">// check exclude</span></div><div class="line">            <span class="comment">// check method_name first, no need parse object.</span></div><div class="line">            <span class="keyword">if</span> (!checkLogFilters_MethodName(<span class="literal">NULL</span>, methodSelector, FT_EXINLUDE))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            <span class="keyword">objc_class_info_t</span> *xobjc_class_info;</div><div class="line">            xobjc_class_info = mem-&gt;parse_OBJECT(rs-&gt;general.regs.rdi);</div><div class="line">            <span class="keyword">if</span>(!xobjc_class_info)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            </div><div class="line">            <span class="comment">// check class name, need parse object</span></div><div class="line">            <span class="keyword">if</span> (!checkLogFilters_ClassName(xobjc_class_info-&gt;class_name, <span class="literal">NULL</span>, FT_EXINLUDE))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">objc_method_info_t</span> * objc_method_info;</div><div class="line">            objc_method_info = search_method_name(&amp;(xobjc_class_info-&gt;methods), methodSelector);</div><div class="line">            <span class="keyword">if</span> (!objc_method_info)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="keyword">if</span>(check_thread_filter(cs-&gt;thread))</div><div class="line">                <span class="keyword">break</span>;</div><div class="line"></div><div class="line">            <span class="comment">// add to `method call count cache`</span></div><div class="line">            add_freq_filter((<span class="keyword">unsigned</span> <span class="keyword">long</span>)methodSelector, objc_method_info);</div><div class="line"></div><div class="line">            <span class="comment">// may be can pass into 'objc_method_info_t' without 'class_name' and 'method_name'</span></div><div class="line">            CallRecord *cr = pushCallRecord(xobjc_class_info-&gt;class_name, methodSelector, <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> *&gt;(rs-&gt;bp), <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">void</span> *&gt;(rs-&gt;ret), cs);</div><div class="line">            <span class="keyword">if</span>(!cr)</div><div class="line">                <span class="keyword">break</span>;</div><div class="line">            printCallRcord(cr, cs);</div><div class="line">            rp-&gt;isTrace = <span class="number">1</span>;</div><div class="line">        &#125; <span class="keyword">while</span>(<span class="number">0</span>);</div><div class="line">    &#125;</div><div class="line">    gettimeofday(&amp;end,<span class="literal">NULL</span>);</div><div class="line">    time_cost += (end.tv_sec-start.tv_sec)+(end.tv_usec-start.tv_usec)/<span class="number">1000000.0</span>;</div><div class="line">    <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(rp);</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<p>hookBefore 的参数其实之前备份寄存器后的 sp 地址, 再通过 <code>RegState_</code> 格式, 就可以取得所有寄存器的值. <code>rs-&gt;general.regs.x0</code> 存放的是实例地址, 但是按理说应该通过 <code>object_getClass(rs-&gt;general.regs.x0)</code> 应该取得类地址, 但是这里避免使用 Objective-C以及 parser 内代码格式统一 就直接使用了 c++ 去实现源码中对应的函数. <code>rs-&gt;general.regs.x1</code> 存放的是函数签名字符串.</p>
<h4 id="Macho-的文件解析"><a href="#Macho-的文件解析" class="headerlink" title="Macho 的文件解析"></a>Macho 的文件解析</h4><p>这里用到了个人之前实现的 macho 的 parser 模块, 大致介绍下这个模块, 可以通过三种状态对 macho 格式进行解析: 1. 文件 2. pid 3. 自身进程, 这里使用第三种, 对自身进程进行解析. (这个模块实现也挺有意思, 需要考虑到 ‘文件偏移’, ‘虚拟地址’, ‘内存地址’ 三种地址的处理)</p>
<p><img src="/images/macho-parser.png" alt=""></p>
<p>对于类实例的解析, 比较复杂, 这里简单介绍下, 具体可以参照 macho-ABI 文档.</p>
<h4 id="构建-hookAfter"><a href="#构建-hookAfter" class="headerlink" title="构建 hookAfter"></a>构建 hookAfter</h4><p><code>hookAfter</code> 实现了 <code>objc_msgSend</code> 执行后, 函数的出栈工作, 并解析函数返回值.</p>
<figure class="highlight c"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div><div class="line">17</div><div class="line">18</div><div class="line">19</div><div class="line">20</div></pre></td><td class="code"><pre><div class="line"><span class="keyword">vm_address_t</span> hookAfter(<span class="keyword">struct</span> RegState_ *rs)</div><div class="line">&#123;</div><div class="line">    pa_list args = (pa_list)&#123;</div><div class="line">        rs,</div><div class="line">        <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">char</span> *&gt;(rs-&gt;bp),</div><div class="line">        <span class="number">2</span>,</div><div class="line">        <span class="number">0</span>&#125;;</div><div class="line">    ThreadCallStack *cs = getThreadCallStack(threadKey);</div><div class="line">    CallRecord *cr = popCallRecordSafe(cs, (<span class="keyword">void</span> *)rs-&gt;bp);</div><div class="line">    <span class="keyword">if</span> (cr)</div><div class="line">    &#123;</div><div class="line">        <span class="comment">// printCallRcordReturnValue(cr, cs, rs);</span></div><div class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(cr-&gt;ret);</div><div class="line">    &#125;</div><div class="line">    <span class="keyword">else</span></div><div class="line">    &#123;</div><div class="line">        cr = popCallRecord(cs);</div><div class="line">        <span class="keyword">return</span> <span class="keyword">reinterpret_cast</span>&lt;<span class="keyword">unsigned</span> <span class="keyword">long</span>&gt;(cr-&gt;ret);</div><div class="line">    &#125;</div><div class="line">&#125;</div></pre></td></tr></table></figure>
<h4 id="hookBefore-与-hookAfter-的数据传递"><a href="#hookBefore-与-hookAfter-的数据传递" class="headerlink" title="hookBefore 与 hookAfter 的数据传递."></a>hookBefore 与 hookAfter 的数据传递.</h4><h5 id="x64-层面"><a href="#x64-层面" class="headerlink" title="x64 层面"></a>x64 层面</h5><p>关键在于函数调用栈中 <code>函数返回地址</code> 的传递, 也就是 <code>(%%rsp)</code> , 由于需要获取 <code>objc_msgSend</code> 的返回值, 所以需要修改栈内默认的函数返回值为下一条指令的地址(请读者思考为什么不直接 push 内存地址? ). 这涉及到如何恢复栈中函数返回地址, 采用线程私有变量的方式,  为每一个 <code>CallRecord</code> 添加 <code>ret</code> 成员.</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">    vm_address_t addr;</div><div class="line">    unsigned long isTrace;</div><div class="line">    vm_address_t ret;</div><div class="line">    vm_address_t bp;</div><div class="line">    vm_address_t key;</div><div class="line">&#125; ReturnPayload;</div><div class="line"></div><div class="line">// Shared structures.</div><div class="line">typedef struct CallRecord_ &#123;</div><div class="line">    void *objc;</div><div class="line">    void *method;</div><div class="line">    void *bp;</div><div class="line">    void *ret;</div><div class="line">&#125; CallRecord;</div></pre></td></tr></table></figure>
<h5 id="arm64-层面"><a href="#arm64-层面" class="headerlink" title="arm64 层面"></a>arm64 层面</h5><p>其实关键在于 lr 寄存器值的传递, 由于需要获取 <code>objc_msgSend</code> 的返回值, 所以必须以 <code>blr objc_msgSend</code> 的方式调用, 此时之前 lr 寄存器的值被覆盖, 此时也不能进行 push 操作, 因为栈中可能已经保存了可变参数的值, 需要维持 sp 和 栈中内容不变, 那这里的 lr 如何保存恢复成了问题.</p>
<p>最后采用了线程私有变量的方法解决, 为每一个 <code>CallRecord</code> 添加 <code>lr</code> 成员, 在 <code>hookAfter</code> 是进行安全 pop, 也就是说同时需要校验 <code>rs-&gt;fp</code> 的值, 是否一致</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div><div class="line">5</div><div class="line">6</div><div class="line">7</div><div class="line">8</div><div class="line">9</div><div class="line">10</div><div class="line">11</div><div class="line">12</div><div class="line">13</div><div class="line">14</div><div class="line">15</div><div class="line">16</div></pre></td><td class="code"><pre><div class="line">typedef struct</div><div class="line">&#123;</div><div class="line">    vm_address_t addr;</div><div class="line">    unsigned long isTrace;</div><div class="line">    vm_address_t lr;</div><div class="line">    vm_address_t fp;</div><div class="line">    vm_address_t key;</div><div class="line">&#125; ReturnPayload;</div><div class="line"></div><div class="line">// Shared structures.</div><div class="line">typedef struct CallRecord_ &#123;</div><div class="line">    void *objc;</div><div class="line">    void *method;</div><div class="line">    void *fp;</div><div class="line">    void *lr;</div><div class="line">&#125; CallRecord;</div></pre></td></tr></table></figure>
<h2 id="如何正确过滤-objc-msgSend"><a href="#如何正确过滤-objc-msgSend" class="headerlink" title="如何正确过滤 objc_msgSend"></a>如何正确过滤 objc_msgSend</h2><p>目前我是通过过滤来避免 log 太复杂.</p>
<h4 id="1-过滤函数地址"><a href="#1-过滤函数地址" class="headerlink" title="1. 过滤函数地址"></a>1. 过滤函数地址</h4><p>默认会过滤解析地址在 self 内存区内, 因为 MachoParser 本身就是一个耗时操作.</p>
<h4 id="2-1-设置不解析类-方法"><a href="#2-1-设置不解析类-方法" class="headerlink" title="2.1 设置不解析类/方法"></a>2.1 设置不解析类/方法</h4><p>需要使用 hash 表进行快速 cache 和 search.</p>
<h4 id="2-2-设置只解析的类-方法"><a href="#2-2-设置只解析的类-方法" class="headerlink" title="2.2 设置只解析的类/方法"></a>2.2 设置只解析的类/方法</h4><p>需要使用 hash 表进行快速 cache 和 search.</p>
<h4 id="3-限制函数调用栈深度"><a href="#3-限制函数调用栈深度" class="headerlink" title="3. 限制函数调用栈深度"></a>3. 限制函数调用栈深度</h4><p>通过自建模拟函数栈, 限制函数栈调用深度.</p>
<h4 id="4-过滤频繁调用函数-log-monitor-之类"><a href="#4-过滤频繁调用函数-log-monitor-之类" class="headerlink" title="4. 过滤频繁调用函数 (log, monitor 之类)"></a>4. 过滤频繁调用函数 (log, monitor 之类)</h4><p>对于一定时间段内频繁调用的函数添加到 hash-map 中.</p>
<h2 id="应用场景"><a href="#应用场景" class="headerlink" title="应用场景"></a>应用场景</h2><p>目前主要关注逆向方面, 当然 APM 方向也是可以玩的.</p>
<h4 id="Thunder-逆向"><a href="#Thunder-逆向" class="headerlink" title="Thunder 逆向"></a>Thunder 逆向</h4><h2 id="参考资料"><a href="#参考资料" class="headerlink" title="参考资料"></a>参考资料</h2><p><img src="/images/arm-x64-refs.png" alt=""></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">// 函数调用约定, 寄存器使用约定</div><div class="line">http://abcdxyzk.github.io/blog/2012/11/23/assembly-args/</div></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2017-05-01</span><i class="fa fa-tag"></i><a href="/categories/darwin/" title="darwin" class="tag">darwin </a><a href="/tags/darwin/" title="darwin" class="tag">darwin </a><a href="/tags/macho/" title="macho" class="tag">macho </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://jmpews.github.com/2017/05/01/darwin/如何正确的hook方法objc_msgSend/,jmpews,如何正确的hook方法objc_msgSend,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2017/04/27/darwin/逆向分析aarch64的CydiaSubstrate的汇编指令/" title="逆向分析aarch64的CydiaSubstrate的汇编指令" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2017/05/11/darwin/IOS应用安全审计思路/" title="IOS应用安全审计思路" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>