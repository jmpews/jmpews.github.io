<!DOCTYPE html><html lang="zh-CN"><head><meta charset="utf-8"><meta name="X-UA-Compatible" content="IE=edge"><meta name="author" content="jmpews,jmpews@gmail.com"><title>后端网络底层开发知识笔记 · jmpews</title><meta name="description" content="socket关闭的流程socket关闭TIME_WAIT详细解释TIME_WAIT详解
主动发起关闭的才会存在TIME_WAIT
TIME_WAIT状态会持续2MSL的时间才会转换到CLOSE状态，一般是1-4分钟。
当一端收到一个FIN，内核让read返回0来通知应用层另一端已经终止了向本端的数据"><meta name="keywords" content="py,go,pwn,reverse"><meta content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=0" name="viewport"><meta content="yes" name="apple-mobile-web-app-capable"><meta content="black" name="apple-mobile-web-app-status-bar-style"><meta content="telephone=no" name="format-detection"><meta name="renderer" content="webkit"><link rel="short icon" href="/images/favicon.png" type="image/x-icon"><link rel="stylesheet" href="/css/style.css"><link rel="stylesheet" href="/css/blog_basic.css"><link rel="stylesheet" href="/css/font-awesome.min.css"><link rel="alternate" type="application/atom+xml" title="ATOM 1.0" href="/atom.xml"></head><body><div class="sidebar animated fadeInDown"><div class="logo-title"><div class="title"><img src="/images/logo@2x.png" style="width:127px;"><h3 title=""><a href="/">jmpews</a></h3><div class="description"><p>py &amp; go &amp; pwn &amp; reverse</p></div></div></div><ul class="social-links"><li><a href="https://twitter.com/jmpews"><i class="fa fa-twitter"></i></a></li><li><a href="http://weibo.com/winter1ife"><i class="fa fa-weibo"></i></a></li><li><a href="http://github.com/jmpews"><i class="fa fa-github"></i></a></li></ul><div class="footer"><a target="_blank" href="/"><span>Theme by </span></a><a href="https://www.caicai.me"> CaiCai </a><span>&</span><a href="https://github.com/Ben02/hexo-theme-Anatole"> Ben</a><div class="by_farbox"><a href="https://hexo.io/zh-cn/" target="_blank">Proudly published with Hexo&#65281;</a></div></div></div><div class="main"><div class="page-top animated fadeInDown"><div class="nav"><li><a href="/">首页</a></li><li><a href="/about">关于</a></li><li><a href="/archives">归档</a></li></div><div class="information"><div class="back_btn"><li><a onclick="window.history.go(-1)" class="fa fa-chevron-left"> </a></li></div><div class="avatar"><img src="/images/favicon.png"></div></div></div><div class="autopagerize_page_element"><div class="content"><div class="post-page"><div class="post animated fadeInDown"><div class="post-title"><h3><a>后端网络底层开发知识笔记</a></h3></div><div class="post-content"><h2 id="socket关闭的流程"><a href="#socket关闭的流程" class="headerlink" title="socket关闭的流程"></a>socket关闭的流程</h2><p><a href="http://www.2cto.com/net/201309/243585.html" target="_blank" rel="external">socket关闭</a><br><a href="http://www.firefoxbug.com/index.php/archives/2795/" target="_blank" rel="external">TIME_WAIT详细解释</a><br><a href="http://segmentfault.com/a/1190000003509876" target="_blank" rel="external">TIME_WAIT详解</a></p>
<p>主动发起关闭的才会存在TIME_WAIT</p>
<p>TIME_WAIT状态会持续2MSL的时间才会转换到CLOSE状态，一般是1-4分钟。</p>
<p>当一端收到一个FIN，内核让read返回0来通知应用层另一端已经终止了向本端的数据传送</p>
<h2 id="处理服务器端TIME-WAIT"><a href="#处理服务器端TIME-WAIT" class="headerlink" title="处理服务器端TIME_WAIT"></a>处理服务器端TIME_WAIT</h2><p><a href="http://www.91python.com/archives/435" target="_blank" rel="external">TIME_WAIT参数</a></p>
<h2 id="内核参数的调整"><a href="#内核参数的调整" class="headerlink" title="内核参数的调整"></a>内核参数的调整</h2><p>发现系统存在大量TIME_WAIT状态的连接，通过调整内核参数解决，<code>vi /etc/sysctl.conf</code></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">net.ipv4.tcp_syncookies = 1</div><div class="line">net.ipv4.tcp_tw_reuse = 1</div><div class="line">net.ipv4.tcp_tw_recycle = 1</div><div class="line">net.ipv4.tcp_fin_timeout = 30</div></pre></td></tr></table></figure>
<p>然后执行 <code>/sbin/sysctl -p</code>让参数生效。</p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div><div class="line">3</div><div class="line">4</div></pre></td><td class="code"><pre><div class="line">net.ipv4.tcp_syncookies = 1 表示开启SYN Cookies。当出现SYN等待队列溢出时，启用cookies来处理，可防范少量SYN攻击，默认为0，表示关闭；</div><div class="line">net.ipv4.tcp_tw_reuse = 1 表示开启重用。允许将TIME-WAIT sockets重新用于新的TCP连接，默认为0，表示关闭；</div><div class="line">net.ipv4.tcp_tw_recycle = 1 表示开启TCP连接中TIME-WAIT sockets的快速回收，默认为0，表示关闭。</div><div class="line">net.ipv4.tcp_fin_timeout 修改系統默认的 TIMEOUT 时间.tcp_tw_recycle = 1</div></pre></td></tr></table></figure>
<h2 id="socket参数的调整"><a href="#socket参数的调整" class="headerlink" title="socket参数的调整"></a>socket参数的调整</h2><p><a href="http://blog.chinaunix.net/uid-24517549-id-4044883.html" target="_blank" rel="external">socket参数详解</a></p>
<figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line">sock.setsockopt(socket.SOL_SOCKET,socket.SO_REUSEADDR,1)</div><div class="line">sock.setsockopt(socket.SOL_SOCKET, socket.SO_LINGER, struct.pack(&apos;ii&apos;, 1, 0))</div></pre></td></tr></table></figure>
<h2 id="文件描述符相关-select关于限制1024"><a href="#文件描述符相关-select关于限制1024" class="headerlink" title="文件描述符相关(select关于限制1024)"></a>文件描述符相关(select关于限制1024)</h2><p><a href="http://blog.csdn.net/cywosp/article/details/38965239" target="_blank" rel="external">解释文件描述相关知识</a></p>
<p>系统为每一个进程维护了一个文件描述符表，程序刚刚启动的时候，该表的值都是从0开始的，所以在不同的进程中你会看到相同的文件描述符，这种情况下相同文件描述符有可能指向同一个文件，也有可能指向不同的文件。0是标准输入，1是标准输出，2是标准错误。如果此时去打开一个新的文件，它的文件描述符会是3。</p>
<p>需要查看由内核维护的3个数据结构</p>
<ol>
<li>进程级的文件描述符表</li>
<li>系统级的打开文件描述符表</li>
<li>文件系统的i-node表</li>
</ol>
<h2 id="最大连接数调整"><a href="#最大连接数调整" class="headerlink" title="最大连接数调整"></a>最大连接数调整</h2><figure class="highlight plain"><table><tr><td class="gutter"><pre><div class="line">1</div><div class="line">2</div></pre></td><td class="code"><pre><div class="line"># </div><div class="line">&gt; ulimit -n</div></pre></td></tr></table></figure>
</div><div class="post-footer"><div class="meta"><div class="info"><i class="fa fa-sun-o"></i><span class="date">2016-12-10</span><i class="fa fa-tag"></i><a href="/categories/notes/" title="notes" class="tag">notes </a><a href="/tags/backend/" title="backend" class="tag">backend </a></div></div></div></div><div class="share"><div class="evernote"><a href="javascript:(function(){EN_CLIP_HOST='http://www.evernote.com';try{var%20x=document.createElement('SCRIPT');x.type='text/javascript';x.src=EN_CLIP_HOST+'/public/bookmarkClipper.js?'+(new%20Date().getTime()/100000);document.getElementsByTagName('head')[0].appendChild(x);}catch(e){location.href=EN_CLIP_HOST+'/clip.action?url='+encodeURIComponent(location.href)+'&amp;title='+encodeURIComponent(document.title);}})();" ref="nofollow" target="_blank" class="fa fa-bookmark"></a></div><div class="weibo"><a href="javascript:void((function(s,d,e){try{}catch(e){}var f='http://service.weibo.com/share/share.php?',u=d.location.href,p=['url=',e(u),'&amp;title=',e(d.title),'&amp;appkey=2924220432'].join('');function a(){if(!window.open([f,p].join(''),'mb',['toolbar=0,status=0,resizable=1,width=620,height=450,left=',(s.width-620)/2,',top=',(s.height-450)/2].join('')))u.href=[f,p].join('');};if(/Firefox/.test(navigator.userAgent)){setTimeout(a,0)}else{a()}})(screen,document,encodeURIComponent));" class="fa fa-weibo"></a></div><div class="twitter"><a href="http://twitter.com/home?status=,http://jmpews.github.com/2016/12/10/notes/后端网络底层开发知识笔记/,jmpews,后端网络底层开发知识笔记,;" class="fa fa-twitter"></a></div></div><div class="pagination"><ul class="clearfix"><li class="pre pagbuttons"><a role="navigation" href="/2016/12/10/python/Torando的IOLoop和Applicaion过程分析/" title="Tornado的IOLoop和Application" class="btn">上一篇</a></li><li class="next pagbuttons"><a role="navigation" href="/2016/12/10/notes/服务器安全配置/" title="服务器安全配置" class="btn">下一篇</a></li></ul></div></div></div></div></div><script src="/js/jquery.js"></script><script src="/js/jquery-migrate-1.2.1.min.js"></script><script src="/js/jquery.appear.js"></script></body></html>